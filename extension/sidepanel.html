<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <link rel="stylesheet" href="sidepanel.css">
</head>
<body>
  <h1>EduFlow 卡片注入</h1>
  <div id="tab-status" class="tab-status"></div>
  <details id="eduflow-details" class="llm-details">
    <summary>EduFlow 后端 API</summary>
    <div class="llm-fields">
      <label>API 地址</label>
      <input type="text" id="eduflow-api-url" placeholder="https://eduflows.cn" />
      <p class="hint">默认 eduflows.cn。本地部署可填 http://localhost:端口</p>
    </div>
  </details>
  <details id="extension-llm-details" class="llm-details">
    <summary>API 与模型</summary>
    <div class="llm-fields">
      <label for="extension-llm-api-key">API Key</label>
      <input type="password" id="extension-llm-api-key" placeholder="留空则保持已保存的值" autocomplete="off" />
      <span id="extension-llm-key-mask" class="hint"></span>
      <label for="extension-llm-model-type">模型</label>
      <select id="extension-llm-model-type">
        <option value="deepseek">DeepSeek</option>
        <option value="doubao">豆包</option>
        <option value="openai">OpenAI 兼容</option>
      </select>
      <button type="button" id="btn-save-llm-config" class="btn btn-secondary">保存 API 配置</button>
      <span id="extension-llm-save-status" class="status"></span>
    </div>
  </details>

  <section class="step-block" id="step1-block">
    <h2 class="step-title">1. 选择文件</h2>
    <div class="drop-zone" id="drop-zone">
      <p>拖入 .md / .docx / .pdf 剧本文件，或点击选择</p>
      <input type="file" id="file-input" accept=".md,.docx,.pdf" hidden />
    </div>
    <div id="file-status" class="status"></div>
    <div id="step1-result" class="step-result" style="display:none;"></div>
  </section>

  <section class="step-block step-block-disabled" id="step2-block">
    <h2 class="step-title">2. 选择生成框架</h2>
    <label for="framework-select">框架</label>
    <select id="framework-select" class="step-select">
      <option value="">加载中…</option>
    </select>
  </section>

  <section class="step-block step-block-disabled" id="step3-block">
    <h2 class="step-title">3. 选择学生角色</h2>
    <label for="persona-select">人设</label>
    <select id="persona-select" class="step-select">
      <option value="">请先完成步骤 1</option>
    </select>
    <div id="persona-content-wrap" class="persona-content-wrap" style="display:none;">
      <label>人设内容（可编辑后保存）</label>
      <textarea id="persona-content" class="persona-content" rows="8" readonly></textarea>
      <button type="button" id="btn-save-persona" class="btn btn-secondary" style="display:none;">保存人设</button>
      <span id="persona-save-status" class="status"></span>
    </div>
  </section>

  <section class="step-block step-block-disabled" id="step4-block">
    <h2 class="step-title">4. 选择评分体系</h2>
    <label for="scoring-select">评分体系</label>
    <select id="scoring-select" class="step-select">
      <option value="default">默认（当前逻辑）</option>
    </select>
  </section>

  <section class="step-block step-block-disabled" id="step5-block">
    <h2 class="step-title">5. 生成卡片</h2>
    <button type="button" id="btn-generate" class="btn btn-primary">生成卡片</button>
    <div id="generate-status" class="status"></div>
    <div id="generate-progress" class="progress" style="display:none;">
      <div class="progress-text" id="progress-text">加载中...</div>
      <div class="progress-bar"><div class="progress-fill" id="progress-fill"></div></div>
    </div>
    <div id="cards-ready" class="cards-ready" style="display:none;">
      <p id="cards-summary" class="cards-summary"></p>
      <label>卡片内容（可编辑后再注入）</label>
      <textarea id="cards-preview" class="cards-preview"></textarea>
    </div>
  </section>

  <section class="step-block step-block-disabled" id="step6-block">
    <h2 class="step-title">6. 注入平台</h2>
    <button type="button" id="btn-inject" class="btn btn-primary">注入平台</button>
    <div id="inject-status" class="status"></div>
  </section>

  <section class="step-block" id="platform-config-block">
    <h2 class="step-title">复制到 Web 端</h2>
    <p class="hint">在智慧树能力训练配置页打开本扩展，点击下方按钮获取配置，可逐一复制到 Web 端「平台配置」使用。</p>
    <button type="button" id="btn-get-platform-config" class="btn btn-secondary">一键获取平台配置</button>
    <div id="platform-config-status" class="status"></div>
    <div id="platform-config-fields" class="platform-config-fields" style="display:none;">
      <label>当前页面 URL</label>
      <div class="config-row">
        <input type="text" id="platform-config-url" class="config-input" readonly />
        <button type="button" class="btn-copy" data-target="platform-config-url" title="复制">复制</button>
      </div>
      <label>Cookie</label>
      <div class="config-row">
        <textarea id="platform-config-cookie" class="config-textarea" readonly rows="2"></textarea>
        <button type="button" class="btn-copy" data-target="platform-config-cookie" title="复制">复制</button>
      </div>
      <label>JWT (Authorization)</label>
      <div class="config-row">
        <textarea id="platform-config-jwt" class="config-textarea" readonly rows="2"></textarea>
        <button type="button" class="btn-copy" data-target="platform-config-jwt" title="复制">复制</button>
      </div>
      <label>开始节点 ID</label>
      <div class="config-row">
        <input type="text" id="platform-config-start" class="config-input" readonly />
        <button type="button" class="btn-copy" data-target="platform-config-start" title="复制">复制</button>
      </div>
      <label>结束节点 ID</label>
      <div class="config-row">
        <input type="text" id="platform-config-end" class="config-input" readonly />
        <button type="button" class="btn-copy" data-target="platform-config-end" title="复制">复制</button>
      </div>
    </div>
  </section>

  <script src="sidepanel.js"></script>
</body>
</html>
