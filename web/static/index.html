<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>EduFlow äº¤äº’æ§åˆ¶å°</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@400;600&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/mammoth@1.6.0/mammoth.browser.min.js"></script>
  <style>
    :root {
      --natsume-paper: #f5f0e6;
      --natsume-cream: #ebe4d8;
      --natsume-ink: #4a4035;
      --natsume-ink-light: #6b5f52;
      --natsume-green: #6b7b6b;
      --natsume-green-soft: #8f9d8f;
      --natsume-leaf: #7d8b6f;
      --natsume-border: #d4c9b8;
      --natsume-shadow: rgba(74, 64, 53, 0.08);
      --natsume-err: #a65d4a;
      --sidebar-width: 280px;
    }
    html { scrollbar-gutter: stable; overflow-x: hidden; }
    * { box-sizing: border-box; }
    body {
      font-family: "Noto Serif SC", "Songti SC", serif;
      margin: 0;
      padding: 0;
      overflow-x: hidden;
      background: var(--natsume-paper);
      color: var(--natsume-ink);
      line-height: 1.7;
      min-height: 100vh;
      background-size: cover;
      background-position: center;
      background-attachment: fixed;
      background-image:
        radial-gradient(ellipse at 20% 10%, rgba(139, 157, 143, 0.06) 0%, transparent 50%),
        radial-gradient(ellipse at 80% 90%, rgba(125, 139, 111, 0.05) 0%, transparent 50%);
      display: flex;
    }
    body.sidebar-collapsed { --sidebar-width: 0; }
    .local-sidebar {
      position: fixed;
      left: 0;
      top: 0;
      width: var(--sidebar-width);
      height: 100vh;
      display: flex;
      flex-direction: column;
      padding: 0;
      background: var(--natsume-cream);
      border-right: 1px solid var(--natsume-border);
      border-radius: 0 12px 12px 0;
      box-shadow: 2px 0 12px var(--natsume-shadow);
      z-index: 20;
      transition: width 0.2s ease;
      overflow-x: hidden;
    }
    .sidebar-resize-handle {
      position: fixed;
      left: calc(var(--sidebar-width) - 3px);
      top: 0;
      bottom: 0;
      width: 6px;
      cursor: col-resize;
      z-index: 21;
      background: transparent;
      transition: left 0.2s ease, background 0.15s;
    }
    .sidebar-resize-handle:hover { background: rgba(107, 123, 107, 0.2); }
    body.sidebar-collapsed .sidebar-resize-handle { display: none; }
    .sidebar-collapse-btn {
      position: absolute;
      right: 0;
      top: 50%;
      transform: translate(100%, -50%);
      width: 18px;
      height: 48px;
      padding: 0;
      margin: 0;
      font-size: 0.75rem;
      color: var(--natsume-ink-light);
      background: var(--natsume-cream);
      border: 1px solid var(--natsume-border);
      border-left: none;
      border-radius: 0 6px 6px 0;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 2px 0 6px var(--natsume-shadow);
      z-index: 22;
    }
    .sidebar-collapse-btn:hover { background: var(--natsume-border); color: var(--natsume-ink); }
    body.sidebar-collapsed .sidebar-collapse-btn { display: none; }
    .sidebar-expand-tab {
      display: none;
      position: fixed;
      left: 0;
      top: 50%;
      transform: translateY(-50%);
      width: 22px;
      height: 56px;
      padding: 0;
      margin: 0;
      font-size: 0.8rem;
      color: var(--natsume-ink-light);
      background: var(--natsume-cream);
      border: 1px solid var(--natsume-border);
      border-left: none;
      border-radius: 0 8px 8px 0;
      cursor: pointer;
      align-items: center;
      justify-content: center;
      box-shadow: 2px 0 8px var(--natsume-shadow);
      z-index: 22;
    }
    .sidebar-expand-tab:hover { background: var(--natsume-border); color: var(--natsume-ink); }
    body.sidebar-collapsed .sidebar-expand-tab { display: flex; }
    .main-content {
      margin-left: var(--sidebar-width);
      transition: margin-left 0.2s ease;
      min-width: 0;
      flex: 1;
      display: flex;
      justify-content: center;
      padding: 2rem 1.5rem;
    }
    .main-content-inner {
      width: 100%;
      max-width: 900px;
    }
    .local-sidebar .sidebar-head {
      flex-shrink: 0;
      padding: 0.85rem 0.75rem 0.6rem;
      margin: 0.5rem 0.5rem 0 0.5rem;
      background: rgba(255, 255, 255, 0.4);
      border-radius: 10px;
      border: 1px solid var(--natsume-border);
    }
    .local-sidebar .sidebar-title {
      font-size: 0.9rem;
      font-weight: 600;
      color: var(--natsume-ink);
      margin: 0 0 0.5rem 0;
    }
    .local-sidebar .sidebar-foot {
      flex-shrink: 0;
      padding: 0.6rem 0.75rem 0.85rem;
      margin: 0 0.5rem 0.5rem 0.5rem;
      background: rgba(255, 255, 255, 0.4);
      border-radius: 10px;
      border: 1px solid var(--natsume-border);
    }
    .header {
      margin-bottom: 2rem;
      padding-bottom: 1.25rem;
      border-bottom: 1px solid var(--natsume-border);
    }
    h1 {
      font-size: 1.6rem;
      font-weight: 600;
      color: var(--natsume-ink);
      letter-spacing: 0.02em;
      margin: 0 0 0.5rem 0;
    }
    .nav {
      font-size: 0.95rem;
      color: var(--natsume-ink-light);
    }
    .nav a {
      color: var(--natsume-green);
      text-decoration: none;
      border-bottom: 1px solid transparent;
      transition: border-color 0.2s, color 0.2s;
    }
    .nav a:hover {
      color: var(--natsume-leaf);
      border-bottom-color: var(--natsume-leaf);
    }
    section {
      margin: 1.75rem 0;
      padding: 1.35rem 1.5rem;
      background: var(--natsume-cream);
      border: 1px solid var(--natsume-border);
      border-radius: 12px;
      box-shadow: 0 2px 12px var(--natsume-shadow);
    }
    section h2 {
      font-size: 1.15rem;
      font-weight: 600;
      color: var(--natsume-ink);
      margin: 0 0 0.6rem 0;
      padding-bottom: 0.4rem;
      border-bottom: 1px solid var(--natsume-border);
    }
    .section-title-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 1rem;
      margin: 0 0 0.6rem 0;
      padding-bottom: 0.4rem;
      border-bottom: 1px solid var(--natsume-border);
    }
    .section-title-row h2 { margin: 0; padding-bottom: 0; border-bottom: none; }
    section p {
      margin: 0 0 0.75rem 0;
      color: var(--natsume-ink-light);
      font-size: 0.95rem;
    }
    label {
      display: block;
      margin: 0.6rem 0 0.25rem;
      font-size: 0.9rem;
      color: var(--natsume-ink-light);
    }
    input[type="file"],
    input[type="text"],
    select {
      width: 100%;
      padding: 0.5rem 0.65rem;
      font-family: inherit;
      font-size: 0.95rem;
      color: var(--natsume-ink);
      background: var(--natsume-paper);
      border: 1px solid var(--natsume-border);
      border-radius: 8px;
      transition: border-color 0.2s, box-shadow 0.2s;
    }
    input:focus,
    select:focus {
      outline: none;
      border-color: var(--natsume-green-soft);
      box-shadow: 0 0 0 2px rgba(111, 125, 111, 0.15);
    }
    input::placeholder {
      color: var(--natsume-border);
    }
    button {
      margin-top: 0.5rem;
      margin-right: 0.5rem;
      padding: 0.5rem 1.1rem;
      font-family: inherit;
      font-size: 0.9rem;
      color: var(--natsume-paper);
      background: var(--natsume-green);
      border: none;
      border-radius: 8px;
      cursor: pointer;
      transition: background 0.2s, transform 0.1s;
      box-shadow: 0 2px 6px var(--natsume-shadow);
    }
    button:hover {
      background: var(--natsume-leaf);
    }
    button:active {
      transform: translateY(1px);
    }
    pre {
      margin-top: 0.75rem;
      padding: 1rem;
      background: var(--natsume-paper);
      border: 1px solid var(--natsume-border);
      border-radius: 8px;
      overflow: auto;
      font-size: 0.82rem;
      line-height: 1.5;
      color: var(--natsume-ink-light);
    }
    .msg {
      margin-top: 0.5rem;
      font-size: 0.9rem;
      color: var(--natsume-ink-light);
    }
    .err {
      color: var(--natsume-err);
    }
    .btn-icon {
      margin: 0;
      padding: 0.35rem 0.5rem;
      font-size: 1rem;
      line-height: 1;
      background: transparent;
      color: var(--natsume-ink-light);
      box-shadow: none;
    }
    .btn-icon:hover { background: var(--natsume-cream); color: var(--natsume-ink); }
    .modal-overlay {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(74, 64, 53, 0.35);
      z-index: 100;
      align-items: center;
      justify-content: center;
    }
    .modal-overlay.show { display: flex; }
    .modal-panel {
      background: var(--natsume-cream);
      border: 1px solid var(--natsume-border);
      border-radius: 12px;
      box-shadow: 0 8px 32px var(--natsume-shadow);
      padding: 0;
      max-width: 420px;
      width: 90%;
    }
    .modal-panel.settings-panel-large {
      max-width: min(90vw, 800px);
      width: 90%;
      display: flex;
      flex-direction: row;
      min-height: 420px;
    }
    .settings-nav {
      width: 180px;
      flex-shrink: 0;
      padding: 1rem 0;
      border-right: 1px solid var(--natsume-border);
      background: rgba(255, 255, 255, 0.35);
      border-radius: 12px 0 0 12px;
    }
    .settings-nav-item {
      display: block;
      width: 100%;
      padding: 0.65rem 1rem;
      text-align: left;
      font-size: 0.95rem;
      color: var(--natsume-ink);
      background: none;
      border: none;
      cursor: pointer;
      border-radius: 0;
      box-shadow: none;
      margin: 0;
      transition: background 0.15s, color 0.15s;
    }
    .settings-nav-item:hover { background: rgba(143, 157, 143, 0.12); color: var(--natsume-ink); }
    .settings-nav-item.active { background: rgba(125, 139, 111, 0.2); color: var(--natsume-leaf); font-weight: 600; }
    .settings-content-wrap {
      flex: 1;
      padding: 1.5rem;
      overflow-y: auto;
      position: relative;
    }
    .settings-content-wrap .modal-close { position: absolute; top: 0.5rem; right: 0.5rem; margin: 0; }
    .settings-panel-page { display: none; }
    .settings-panel-page.active { display: block; }
    .settings-panel-page h3 { margin: 0 0 1rem 0; font-size: 1.1rem; color: var(--natsume-ink); }
    .modal-panel h3 { margin: 0 0 1rem 0; font-size: 1.1rem; color: var(--natsume-ink); }
    .modal-panel .modal-close { float: right; margin: -0.25rem 0 0 0; }
    .drop-zone {
      border: 2px dashed var(--natsume-border);
      border-radius: 10px;
      padding: 1.25rem;
      text-align: center;
      color: var(--natsume-ink-light);
      font-size: 0.9rem;
      cursor: pointer;
      transition: border-color 0.2s, background 0.2s;
    }
    .drop-zone:hover, .drop-zone.dragover { border-color: var(--natsume-green-soft); background: rgba(143, 157, 143, 0.08); }
    .path-drop-target.drag-over { border-color: var(--natsume-green-soft); background: rgba(143, 157, 143, 0.06); }
    .drop-zone input[type="file"] { display: none; }
    #scriptFile, #wallpaperFile { display: none !important; }
    .wallpaper-preview {
      margin-bottom: 0.75rem;
      border: 1px solid var(--natsume-border);
      border-radius: 8px;
      overflow: hidden;
      background: var(--natsume-paper);
      min-height: 80px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .wallpaper-preview img { max-width: 100%; max-height: 160px; object-fit: contain; display: block; }
    .wallpaper-preview .no-preview { color: var(--natsume-ink-light); font-size: 0.9rem; }
    .file-list {
      max-height: 200px;
      overflow-y: auto;
      border: 1px solid var(--natsume-border);
      border-radius: 8px;
      margin-top: 0.5rem;
    }
    .local-sidebar .file-list {
      flex: 1;
      min-height: 0;
      max-height: none;
      overflow-x: auto;
      overflow-y: auto;
      border: none;
      border-radius: 0;
      margin: 0.5rem 0.5rem 0;
      padding: 0.25rem 0;
      background: transparent;
    }
    .file-list-item {
      padding: 0.35rem 0.5rem 0.35rem 0.75rem;
      font-size: 0.875rem;
      color: var(--natsume-ink);
      cursor: pointer;
      border: none;
      border-radius: 6px;
      margin: 0 0.25rem 1px 0.25rem;
      transition: background 0.15s;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
    .file-list-item:hover { background: rgba(143, 157, 143, 0.14); }
    .script-upload-row { display: flex; gap: 1rem; margin-top: 0.75rem; flex-wrap: wrap; }
    .script-upload-row .col { flex: 1; min-width: 200px; }
    .save-to-input { margin-top: 0.75rem; }
    .save-to-input label { display: inline; margin-left: 0.35rem; }
    .save-to-input input[type="text"] { margin-top: 0.35rem; }
    .sidebar-tab { padding: 0.2rem 0.5rem; font-size: 0.8rem; cursor: pointer; background: transparent; border: 1px solid var(--natsume-border); color: var(--natsume-ink); border-radius: 3px; }
    .sidebar-tab:hover { background: rgba(143,157,143,0.15); }
    .sidebar-tab.active { background: var(--natsume-green-soft); color: var(--natsume-ink); }
    .local-sidebar .sidebar-head .breadcrumb {
      font-size: 0.8rem;
      color: var(--natsume-ink-light);
      margin: 0.35rem 0 0 0;
      min-height: 1.2em;
    }
    .local-sidebar .sidebar-head .breadcrumb {
      font-size: 0.75rem;
      color: var(--natsume-ink-light);
      margin: 0.35rem 0 0 0;
      min-height: 1em;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
    .local-sidebar .breadcrumb span { cursor: pointer; }
    .local-sidebar .breadcrumb span:hover { color: var(--natsume-green); }
    .tree-depth-0 { padding-left: 0.5rem !important; }
    .file-list-item[data-depth] { padding-left: calc(0.5rem + var(--tree-depth, 0) * 1rem) !important; }
    .file-list-item .tree-arrow {
      display: inline-block;
      width: 1em;
      margin-right: 0.2em;
      font-size: 0.7em;
      color: var(--natsume-ink-light);
      transition: transform 0.15s;
    }
    .file-list-item.folder .tree-icon { color: var(--natsume-green-soft); margin-right: 0.25em; }
    .file-list-item.file .tree-icon { color: var(--natsume-ink-light); margin-right: 0.35em; }
    .file-list-item.up { font-style: italic; color: var(--natsume-green); }
    .file-list-item.up::before { content: "â†‘ "; }
    .file-list-item.selected { background: rgba(125, 139, 111, 0.22); }
    .file-list-item.loading { opacity: 0.85; }
    .file-list-item.err { color: var(--natsume-err); }
    .local-sidebar .local-selected { display: none; }
    .local-sidebar .local-analyze-wrap { margin: 0; }
    .local-analyze-wrap { margin-top: 0.5rem; }
    .ctx-menu {
      position: fixed;
      z-index: 200;
      background: var(--natsume-cream);
      border: 1px solid var(--natsume-border);
      border-radius: 8px;
      box-shadow: 0 4px 16px var(--natsume-shadow);
      padding: 0.25rem 0;
      min-width: 140px;
    }
    .ctx-menu-item {
      padding: 0.4rem 0.75rem;
      font-size: 0.9rem;
      cursor: pointer;
      color: var(--natsume-ink);
    }
    .ctx-menu-item:hover { background: rgba(143, 157, 143, 0.15); }
    #previewModal .modal-panel { max-width: min(95vw, 900px); width: 95%; max-height: 90vh; display: flex; flex-direction: column; padding: 0; }
    #previewModal .preview-header { flex-shrink: 0; padding: 0.75rem 1rem; border-bottom: 1px solid var(--natsume-border); display: flex; align-items: center; justify-content: space-between; }
    #previewModal .preview-body { flex: 1; overflow: auto; padding: 1rem; background: var(--natsume-paper); border-radius: 0 0 12px 12px; font-size: 0.9rem; line-height: 1.6; }
    #previewModal .preview-body pre, #previewModal .preview-body code { font-family: ui-monospace, monospace; }
    #previewModal .preview-body pre { padding: 0.75rem; border-radius: 6px; overflow-x: auto; }
    .header, .local-sidebar, section, .main-content,
    .sidebar-resize-handle, .sidebar-collapse-btn, .sidebar-expand-tab {
      transition: opacity 0.22s ease;
    }
    body.ui-fade-out .header,
    body.ui-fade-out .local-sidebar,
    body.ui-fade-out section,
    body.ui-fade-out .main-content,
    body.ui-fade-out .sidebar-resize-handle,
    body.ui-fade-out .sidebar-collapse-btn,
    body.ui-fade-out .sidebar-expand-tab { opacity: 0; pointer-events: none; }
    body.ui-hidden .local-sidebar,
    body.ui-hidden .sidebar-resize-handle,
    body.ui-hidden .sidebar-collapse-btn,
    body.ui-hidden .sidebar-expand-tab,
    body.ui-hidden .header,
    body.ui-hidden section,
    body.ui-hidden .main-content { display: none !important; }
    body.ui-restoring .header,
    body.ui-restoring .local-sidebar,
    body.ui-restoring section,
    body.ui-restoring .main-content,
    body.ui-restoring .sidebar-resize-handle,
    body.ui-restoring .sidebar-collapse-btn,
    body.ui-restoring .sidebar-expand-tab { opacity: 0; }
    ::-webkit-scrollbar { width: 8px; height: 8px; }
    ::-webkit-scrollbar-track { background: var(--natsume-cream); border-radius: 4px; }
    ::-webkit-scrollbar-thumb { background: var(--natsume-border); border-radius: 4px; }
    ::-webkit-scrollbar-thumb:hover { background: var(--natsume-green-soft); }
  </style>
</head>
<body>
  <aside id="localSidebar" class="local-sidebar">
    <div class="sidebar-head">
      <div class="sidebar-title">æœ¬åœ°ç›®å½•</div>
      <div class="breadcrumb" style="margin-top:0.2rem;font-size:0.7rem">é¡¹ç›®: <span id="currentWorkspaceLabel"></span></div>
      <div style="display:flex;gap:0.25rem;margin-top:0.25rem;flex-wrap:wrap;">
        <input type="text" id="projectNameInput" placeholder="è¾“å…¥é¡¹ç›®åå¦‚ ç¼–è¯‘åŸç†" style="flex:1;min-width:6rem;padding:0.2rem 0.4rem;font-size:0.8rem;" />
        <button type="button" id="btnOpenProject">æ‰“å¼€é¡¹ç›®</button>
      </div>
      <button type="button" id="btnPickLocalDir">æ‹©å®šæœ¬åœ°ç›®å½•</button>
      <div id="dirPickerTip" class="file-list-item err" style="display:none; margin-top:0.35rem; font-size:0.85em;"></div>
      <div id="localBreadcrumb" class="breadcrumb"></div>
      <div style="display:flex;gap:0.25rem;margin-top:0.5rem;">
        <button type="button" id="sidebarTabLocal" class="sidebar-tab active">æœ¬åœ°ç›®å½•</button>
        <button type="button" id="sidebarTabWorkspace" class="sidebar-tab">å·¥ä½œåŒºæ–‡ä»¶</button>
      </div>
    </div>
    <div id="localPanel" class="sidebar-panel">
      <div id="localFileList" class="file-list">è¯·å…ˆæ‹©å®šæœ¬åœ°ç›®å½•</div>
    </div>
    <div id="workspacePanel" class="sidebar-panel" style="display:none;">
      <button type="button" id="btnRefreshWorkspaceFiles" style="margin-bottom:0.35rem;">åˆ·æ–°</button>
      <div id="workspaceFileList" class="file-list">ç‚¹å‡»ã€Œåˆ·æ–°ã€åŠ è½½å·¥ä½œåŒº input/output æ–‡ä»¶</div>
    </div>
    <div class="sidebar-foot">
      <div id="localSelected" class="local-selected"></div>
    </div>
  </aside>
  <div id="sidebarResizeHandle" class="sidebar-resize-handle" title="æ‹–æ‹½è°ƒæ•´å®½åº¦"></div>
  <button type="button" id="sidebarCollapseBtn" class="sidebar-collapse-btn" title="æ”¶èµ·ä¾§è¾¹æ ">â—€</button>
  <button type="button" id="sidebarExpandTab" class="sidebar-expand-tab" title="å±•å¼€ä¾§è¾¹æ ">â–¶</button>
  <div class="main-content">
  <div class="main-content-inner">
  <header class="header">
    <h1>EduFlow äº¤äº’æ§åˆ¶å°</h1>
    <p class="nav">
      <a href="/docs">API æ–‡æ¡£ (OpenAPI)</a> Â· <a href="/api/health">å¥åº·æ£€æŸ¥</a>
      <button type="button" id="btnSettings" class="btn-icon" title="ç½‘é¡µè®¾ç½®">âš™ è®¾ç½®</button>
    </p>
  </header>

  <div id="settingsModal" class="modal-overlay">
    <div class="modal-panel settings-panel-large">
      <nav class="settings-nav">
        <button type="button" class="settings-nav-item active" data-settings-page="llm">API ä¸æ¨¡å‹</button>
        <button type="button" class="settings-nav-item" data-settings-page="wallpaper">å¤–è§‚ï¼ˆå£çº¸ï¼‰</button>
      </nav>
      <div class="settings-content-wrap">
        <button type="button" id="btnCloseSettings" class="modal-close btn-icon">Ã—</button>
        <div id="settingsPageLlm" class="settings-panel-page active">
          <h3>API ä¸æ¨¡å‹</h3>
          <p class="hint">è§£æå‰§æœ¬ã€ç”Ÿæˆå¡ç‰‡ã€Trainset æ„å»ºã€DSPy ä¼˜åŒ–å‡ä½¿ç”¨æ­¤å¤„é…ç½®ã€‚è¯·å¡«å†™æ‚¨è‡ªå·±çš„ API Keyã€‚</p>
          <label>API Key</label>
          <input type="password" id="llmApiKey" placeholder="ç•™ç©ºåˆ™ä¿æŒå·²ä¿å­˜çš„å€¼" autocomplete="off">
          <span id="llmApiKeyMasked" class="hint"></span>
          <label>æ¨¡å‹</label>
          <select id="llmModelType">
            <option value="deepseek">DeepSeek</option>
            <option value="doubao">è±†åŒ…</option>
            <option value="openai">OpenAI å…¼å®¹ï¼ˆè‡ªå®šä¹‰ï¼‰</option>
          </select>
          <div id="llmCustomFields" style="display:none">
            <label>Base URL</label>
            <input type="text" id="llmBaseUrl" placeholder="https://api.openai.com/v1">
            <label>Model åç§°</label>
            <input type="text" id="llmModelName" placeholder="gpt-4o">
          </div>
          <button type="button" id="btnSaveLlmConfig">ä¿å­˜ LLM é…ç½®</button>
          <div id="llmConfigMsg" class="msg"></div>
        </div>
        <div id="settingsPageWallpaper" class="settings-panel-page">
          <h3>å¤–è§‚ï¼ˆå£çº¸ï¼‰</h3>
          <label>å£çº¸</label>
          <div id="wallpaperPreview" class="wallpaper-preview"><span class="no-preview">å½“å‰æœªè®¾ç½®å£çº¸</span></div>
          <div id="wallpaperDropZone" class="drop-zone">å°†å›¾ç‰‡æ‹–è‡³æ­¤å¤„ï¼Œæˆ–ç‚¹å‡»é€‰å–</div>
          <input type="file" id="wallpaperFile" accept="image/*">
          <button type="button" id="btnClearWallpaper" style="margin-top:0.5rem">æ¸…é™¤å£çº¸</button>
        </div>
      </div>
    </div>
  </div>

  <div id="previewModal" class="modal-overlay">
    <div class="modal-panel">
      <div class="preview-header">
        <strong id="previewModalTitle">é¢„è§ˆ</strong>
        <button type="button" id="btnClosePreview" class="btn-icon">Ã—</button>
      </div>
      <div id="previewModalBody" class="preview-body"></div>
    </div>
  </div>

  <section>
  <h2>1. å‰§æœ¬ã€åˆ†æç»“æ„å¹¶ç”Ÿæˆæ•™å­¦å¡ç‰‡</h2>
  <p>ä»å·¦ä¾§ç›®å½•é€‰å–å‰§æœ¬ï¼Œæˆ–å°†æ–‡ä»¶æ‹–å…¥ä¸‹æ–¹åŒºåŸŸï¼›ç³»ç»Ÿä¼šè§£æç»“æ„ã€‚è§£æå®Œæˆåç‚¹å‡»ã€Œç”Ÿæˆå¡ç‰‡ã€ç”Ÿæˆæ•™å­¦å¡ç‰‡ã€‚</p>
  <label>æ‹–å…¥æˆ–ç‚¹é€‰å‰§æœ¬</label>
  <div id="scriptDropZone" class="drop-zone">å°† .md / .docx / .pdf æ‹–è‡³æ­¤å¤„ï¼Œæˆ–ç‚¹å‡»é€‰å–</div>
  <input type="file" id="scriptFile" accept=".md,.docx,.pdf">
  <label style="margin-top:0.9rem;">ç”Ÿæˆæ¡†æ¶</label>
  <select id="frameworkId"></select>
  <button type="button" id="btnGenCards">ç”Ÿæˆå¡ç‰‡</button>
  <div id="uploadMsg" class="msg"></div>
  </section>

  <section>
  <h2>2. å­¦ç”Ÿæ¨¡æ‹Ÿæµ‹è¯•ï¼ˆè‡ªåŠ¨æ¨¡å¼ï¼‰</h2>
    <label>å¡ç‰‡æ–‡ä»¶è·¯å¾„ï¼ˆç›¸å¯¹é¡¹ç›®æ ¹ï¼Œå¯æ‹–å…¥å·¦ä¾§æ–‡ä»¶å¡«å…¥ï¼‰</label>
    <input type="text" id="cardsPath" class="path-drop-target" placeholder="output/cards_output_20260202_170046.md">
    <label>äººè®¾</label>
    <select id="personaId"></select>
    <button id="btnSimulate">è¿è¡Œæ¨¡æ‹Ÿ</button>
    <div id="simMsg" class="msg"></div>
    <pre id="simResult" style="display:none;"></pre>
  </section>

  <section>
  <h2>3. å†…éƒ¨è¯„ä¼°ï¼ˆä¼šè¯æ—¥å¿— â†’ è¯„ä¼°æŠ¥å‘Šï¼‰</h2>
    <p>è¾“å…¥ä¸ºæ¨¡æ‹Ÿå¯¹è¯è®°å½•ï¼ˆJSONï¼‰ï¼Œè¾“å‡ºä¸ºå¤šç»´åº¦è¯„ä¼°æŠ¥å‘Šã€‚å¯ä¿å­˜ä¸ºå¯¼å‡ºæ–‡ä»¶ä¾›ç¬¬ 6 æ­¥ä¼˜åŒ–å™¨ä½¿ç”¨ã€‚</p>
    <label>ä¼šè¯æ—¥å¿—è·¯å¾„ï¼ˆå¯æ‹–å…¥å·¦ä¾§å·¥ä½œåŒºæ–‡ä»¶å¡«å…¥ï¼‰</label>
    <input type="text" id="logPath" class="path-drop-target" placeholder="simulator_output/logs/session_20260202_123456.json">
    <button id="btnEvaluate">æŒ‰è·¯å¾„è¯„ä¼°</button>
    <label style="margin-left:0.5rem;"><input type="checkbox" id="evalSaveToExport"> ä¿å­˜ä¸ºå¯¼å‡ºæ–‡ä»¶ï¼ˆoutput/optimizer/export_score.*ï¼‰</label>
    <div style="margin-top:0.5rem;">
      <label>æˆ–æ‹–å…¥ä¼šè¯æ—¥å¿—æ–‡ä»¶</label>
      <div id="evalLogDropZone" class="drop-zone" style="max-width:28rem;">å°† .json ä¼šè¯æ—¥å¿—æ‹–è‡³æ­¤å¤„ï¼Œæˆ–ç‚¹å‡»é€‰å–</div>
      <input type="file" id="evalLogFile" accept=".json" style="display:none">
      <label style="margin-top:0.35rem;"><input type="checkbox" id="evalFileSaveToExport"> ä¿å­˜ä¸ºå¯¼å‡ºæ–‡ä»¶</label>
    </div>
    <div id="evalMsg" class="msg"></div>
    <pre id="evalResult" style="display:none;"></pre>
  </section>

  <section>
  <h2>4. å¹³å°é…ç½®ï¼ˆæ™ºæ…§æ ‘ï¼‰</h2>
    <p>å¡«å†™æˆ–ä¿®æ”¹åç‚¹å‡»ã€Œä¿å­˜é…ç½®ã€ä¼šå†™å…¥å½“å‰å·¥ä½œåŒºï¼Œåç»­ã€Œæ‰§è¡Œæ³¨å…¥ã€å°†ä½¿ç”¨æ­¤é…ç½®ã€‚è‹¥å·²åœ¨ .env ä¸­é…ç½®ï¼Œå¯ç‚¹å‡»ã€Œä» .env æ¢å¤ã€è¦†ç›–å·¥ä½œåŒºã€‚</p>
    <label>ä»æ™ºæ…§æ ‘é¡µé¢ URL ä¸€é”®å¡«å……è¯¾ç¨‹/ä»»åŠ¡ ID</label>
    <input type="text" id="setProjectUrl" placeholder="https://hike-teaching-center.polymas.com/.../ability-training/create?trainTaskId=xxx">
    <button type="button" id="btnSetProject">ä» URL è®¾ç½®é¡¹ç›®</button>
    <div id="setProjectMsg" class="msg"></div>
    <label>PLATFORM_BASE_URL</label>
    <input type="text" id="cfgBaseUrl" placeholder="https://cloudapi.polymas.com">
    <label>PLATFORM_COOKIE</label>
    <input type="text" id="cfgCookie" placeholder="">
    <label>PLATFORM_AUTHORIZATIONï¼ˆJWTï¼‰</label>
    <input type="text" id="cfgAuthorization" placeholder="">
    <label>PLATFORM_COURSE_ID</label>
    <input type="text" id="cfgCourseId" placeholder="">
    <label>PLATFORM_TRAIN_TASK_ID</label>
    <input type="text" id="cfgTrainTaskId" placeholder="">
    <label>PLATFORM_START_NODE_IDï¼ˆè®­ç»ƒå¼€å§‹èŠ‚ç‚¹ï¼‰</label>
    <input type="text" id="cfgStartNodeId" placeholder="">
    <label>PLATFORM_END_NODE_IDï¼ˆè®­ç»ƒç»“æŸèŠ‚ç‚¹ï¼‰</label>
    <input type="text" id="cfgEndNodeId" placeholder="">
    <button type="button" id="btnLoadConfig">åŠ è½½å½“å‰é…ç½®</button>
    <button type="button" id="btnSaveConfig">ä¿å­˜é…ç½®</button>
    <button type="button" id="btnResetToEnv">ä» .env æ¢å¤</button>
    <div id="configMsg" class="msg"></div>
  </section>

  <section>
  <h2>5. æ³¨å…¥å¹³å°ï¼ˆæ™ºæ…§æ ‘ï¼‰</h2>
    <p>å°†å·²ç”Ÿæˆçš„å¡ç‰‡ Markdown æ¨é€åˆ°æ™ºæ…§æ ‘å¹³å°ï¼›è¯·å…ˆåœ¨ã€Œ4. å¹³å°é…ç½®ã€ä¸­å¡«å†™å¹¶ä¿å­˜ã€‚</p>
    <label>å¡ç‰‡æ–‡ä»¶è·¯å¾„ï¼ˆç›¸å¯¹é¡¹ç›®æ ¹ï¼Œå¯æ‹–å…¥å·¦ä¾§æ–‡ä»¶å¡«å…¥ï¼‰</label>
    <input type="text" id="injectCardsPath" class="path-drop-target" placeholder="output/cards_output_20260202_170046.md">
    <label>ä»»åŠ¡åç§°ï¼ˆå¯é€‰ï¼Œä¸ºç©ºåˆ™ä¸æ›´æ–°ä»»åŠ¡é…ç½®ï¼‰</label>
    <input type="text" id="injectTaskName" placeholder="">
    <label>ä»»åŠ¡æè¿°ï¼ˆå¯é€‰ï¼‰</label>
    <input type="text" id="injectDescription" placeholder="">
    <label style="display:flex;align-items:center;gap:0.4rem;">
      <input type="checkbox" id="injectOverwrite"> è¦†å†™å¹³å°ç°æœ‰å¡ç‰‡ï¼ˆè‹¥å·²å­˜åœ¨åˆ™é»˜è®¤é˜»æ­¢ï¼‰
    </label>
    <button id="btnInjectPreview">é¢„è§ˆæ³¨å…¥</button>
    <button id="btnInjectRun">æ‰§è¡Œæ³¨å…¥</button>
    <div id="injectMsg" class="msg"></div>
    <pre id="injectResult" style="display:none;"></pre>
  </section>

  <section>
  <h2>6. Trainset ä¸ DSPy ä¼˜åŒ–</h2>
    <p>trainset.json ç”±ç¬¬ 1 æ­¥è§£æå‰§æœ¬æ—¶è‡ªåŠ¨å†™å…¥ã€‚å¯åœ¨æ­¤æ ¡éªŒç»“æ„åè¿è¡Œ DSPy ä¼˜åŒ–ï¼ˆéœ€å®‰è£… dspy-aiï¼‰ã€‚è·¯å¾„å‡ç›¸å¯¹å½“å‰å·¥ä½œåŒºã€‚</p>
    <label>Trainset è·¯å¾„ï¼ˆå¯æ‹–å…¥å·¦ä¾§æ–‡ä»¶å¡«å…¥ï¼‰</label>
    <input type="text" id="trainsetPath" class="path-drop-target" placeholder="output/optimizer/trainset.json">
    <button type="button" id="btnValidateTrainset">æ ¡éªŒ</button>
    <div id="validateTrainsetMsg" class="msg"></div>
    <pre id="validateTrainsetResult" style="display:none;"></pre>
    <label>Devset è·¯å¾„ï¼ˆå¯é€‰ï¼Œå¯æ‹–å…¥å·¦ä¾§æ–‡ä»¶å¡«å…¥ï¼‰</label>
    <input type="text" id="optimizerDevsetPath" class="path-drop-target" placeholder="">
    <label>å¯¼å‡ºæ–‡ä»¶è·¯å¾„ï¼ˆä¼˜åŒ–å™¨è¯»å–è¯„åˆ†çš„æŠ¥å‘Šï¼Œå¯æ‹–å…¥å·¦ä¾§å·¥ä½œåŒºæ–‡ä»¶å¡«å…¥ï¼‰</label>
    <input type="text" id="optimizerExportPath" class="path-drop-target" placeholder="output/optimizer/export_score.json">
    <div class="upload-report-wrap" style="margin-top:0.6rem;">
      <label>ä¸Šä¼ å¤–éƒ¨è¯„ä¼°æŠ¥å‘Š</label>
      <div id="exportReportDropZone" class="drop-zone" style="max-width:28rem;">å°† .md / .json / .txt æŠ¥å‘Šæ‹–è‡³æ­¤å¤„ï¼Œæˆ–ç‚¹å‡»é€‰å–</div>
      <input type="file" id="exportReportFile" accept=".md,.json,.txt" style="display:none">
      <div id="uploadExportReportMsg" class="msg"></div>
    </div>
    <label>ä¼˜åŒ–å™¨ç±»å‹</label>
    <select id="optimizerType"><option value="bootstrap">bootstrap</option><option value="mipro">mipro</option></select>
    <button type="button" id="btnRunOptimizer">è¿è¡Œä¼˜åŒ–</button>
    <div id="optimizerMsg" class="msg"></div>
    <pre id="optimizerResult" style="display:none;"></pre>
  </section>
  </div>
  </div>

  <script>
    const API = '';
    const WALLPAPER_KEY = 'eduflow_wallpaper';
    const WALLPAPER_OVERLAY = 'linear-gradient(rgba(245, 240, 230, 0.88), rgba(245, 240, 230, 0.9)), ';
    let lastUploadData = null;

    (function ensureWorkspaceInUrl() {
      var m = /^\/w\/([^/]+)\/?$/.exec(location.pathname);
      if (m) {
        try {
          window.WORKSPACE_ID = decodeURIComponent(m[1]);
        } catch (e) {
          window.WORKSPACE_ID = m[1];
        }
        return;
      }
      var id = '';
      if (typeof crypto !== 'undefined' && crypto.randomUUID) {
        id = crypto.randomUUID().replace(/-/g, '').slice(0, 12);
      } else {
        for (var i = 0; i < 12; i++) id += 'abcdefghijklmnopqrstuvwxyz0123456789'[Math.floor(Math.random() * 36)];
      }
      window.WORKSPACE_ID = id;
      history.replaceState(null, '', '/w/' + id);
    })();
    function getWorkspaceId() { return window.WORKSPACE_ID || ''; }
    (function initWorkspaceLabel() {
      var wl = document.getElementById('currentWorkspaceLabel');
      if (wl) wl.textContent = getWorkspaceId();
    })();
    (function initOpenProjectBtn() {
      var btn = document.getElementById('btnOpenProject');
      var input = document.getElementById('projectNameInput');
      if (btn && input) {
        btn.onclick = function() {
          var name = input.value.trim();
          if (name) switchWorkspaceByProjectName(name);
        };
        input.onkeydown = function(e) { if (e.key === 'Enter') btn.click(); };
      }
    })();
    function showWorkspaceToast(id) {
      var wl = document.getElementById('currentWorkspaceLabel');
      if (!wl) return;
      wl.textContent = 'å·²åˆ‡æ¢: ' + id;
      setTimeout(function() { wl.textContent = id; }, 2000);
    }
    function encodeWorkspaceIdForHeader(id) {
      if (!id) return '';
      try {
        return btoa(unescape(encodeURIComponent(id)));
      } catch (e) {
        return /^[\x00-\x7F]*$/.test(id) ? id : '';
      }
    }
    function apiFetch(path, options) {
      options = options || {};
      options.headers = options.headers || {};
      var wid = getWorkspaceId();
      var encoded = encodeWorkspaceIdForHeader(wid);
      options.headers['X-Workspace-Id'] = encoded || (wid && /^[\x00-\x7F]*$/.test(wid) ? wid : '');
      var base = (typeof API !== 'undefined' && API) ? API : (window.location.origin || '');
      var url = path.startsWith('http') ? path : (base.replace(/\/$/, '') + (path.startsWith('/') ? path : '/' + path));
      return fetch(url, options);
    }

    function applyWallpaper(dataUrl) {
      if (!dataUrl) {
        document.body.style.backgroundImage = '';
        document.body.style.backgroundSize = '';
        return;
      }
      document.body.style.backgroundImage = WALLPAPER_OVERLAY + 'url(' + dataUrl + ')';
      document.body.style.backgroundSize = 'cover';
      document.body.style.backgroundPosition = 'center';
      document.body.style.backgroundAttachment = 'fixed';
    }
    function loadWallpaper() {
      try {
        const dataUrl = localStorage.getItem(WALLPAPER_KEY);
        if (dataUrl) applyWallpaper(dataUrl);
      } catch (e) {}
    }
    loadWallpaper();

    var settingsModal = document.getElementById('settingsModal');
    function updateWallpaperPreview() {
      var wrap = document.getElementById('wallpaperPreview');
      try {
        var dataUrl = localStorage.getItem(WALLPAPER_KEY);
        if (dataUrl) {
          wrap.innerHTML = '<img src="' + dataUrl + '" alt="å½“å‰å£çº¸">';
        } else {
          wrap.innerHTML = '<span class="no-preview">å½“å‰æœªè®¾ç½®å£çº¸</span>';
        }
      } catch (e) {
        wrap.innerHTML = '<span class="no-preview">å½“å‰æœªè®¾ç½®å£çº¸</span>';
      }
    }
    function loadLlmConfig() {
      apiFetch('/api/llm/config').then(function(r) { return r.json(); }).then(function(data) {
        document.getElementById('llmModelType').value = data.model_type || 'deepseek';
        document.getElementById('llmApiKey').value = '';
        document.getElementById('llmApiKeyMasked').textContent = data.has_api_key ? 'å·²ä¿å­˜ Key: ' + (data.api_key_masked || '***') : 'æœªè®¾ç½®';
        document.getElementById('llmBaseUrl').value = data.base_url || '';
        document.getElementById('llmModelName').value = data.model || '';
        document.getElementById('llmCustomFields').style.display = (data.model_type === 'openai') ? 'block' : 'none';
      }).catch(function() {
        document.getElementById('llmApiKeyMasked').textContent = 'åŠ è½½å¤±è´¥';
      });
    }
    document.getElementById('llmModelType').onchange = function() {
      document.getElementById('llmCustomFields').style.display = (this.value === 'openai') ? 'block' : 'none';
    };
    document.getElementById('btnSaveLlmConfig').onclick = function() {
      var payload = { model_type: document.getElementById('llmModelType').value };
      var key = document.getElementById('llmApiKey').value.trim();
      if (key) payload.api_key = key;
      if (document.getElementById('llmModelType').value === 'openai') {
        payload.base_url = document.getElementById('llmBaseUrl').value.trim();
        payload.model = document.getElementById('llmModelName').value.trim();
      }
      document.getElementById('llmConfigMsg').textContent = 'ä¿å­˜ä¸­â€¦';
      apiFetch('/api/llm/config', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) })
        .then(function(r) { return r.json(); })
        .then(function(data) {
          document.getElementById('llmConfigMsg').textContent = data.message || 'å·²ä¿å­˜';
          loadLlmConfig();
        })
        .catch(function(e) {
          document.getElementById('llmConfigMsg').textContent = 'ä¿å­˜å¤±è´¥: ' + (e.message || e);
        });
    };
    document.getElementById('btnSettings').onclick = function() {
      updateWallpaperPreview();
      loadLlmConfig();
      settingsModal.classList.add('show');
    };
    document.getElementById('btnCloseSettings').onclick = function() { settingsModal.classList.remove('show'); };
    settingsModal.onclick = function(e) { if (e.target === settingsModal) settingsModal.classList.remove('show'); };
    (function initSettingsNav() {
      var navItems = settingsModal.querySelectorAll('.settings-nav-item');
      var pages = { llm: document.getElementById('settingsPageLlm'), wallpaper: document.getElementById('settingsPageWallpaper') };
      navItems.forEach(function(btn) {
        btn.onclick = function() {
          var pageId = this.getAttribute('data-settings-page');
          navItems.forEach(function(b) { b.classList.remove('active'); });
          this.classList.add('active');
          for (var k in pages) { pages[k].classList.remove('active'); if (k === pageId) pages[k].classList.add('active'); }
        };
      });
    })();

    var wallpaperDZ = document.getElementById('wallpaperDropZone');
    var wallpaperInput = document.getElementById('wallpaperFile');
    function setWallpaperFromFile(file) {
      if (!file || !file.type.startsWith('image/')) return;
      var r = new FileReader();
      r.onload = function() {
        try {
          localStorage.setItem(WALLPAPER_KEY, r.result);
          applyWallpaper(r.result);
          updateWallpaperPreview();
        } catch (e) { alert('å£çº¸è¿‡å¤§æˆ–æ— æ³•ä¿å­˜ï¼Œè¯·æ¢ä¸€å¼ è¾ƒå°çš„å›¾ç‰‡'); }
      };
      r.readAsDataURL(file);
    }
    wallpaperDZ.onclick = function() { wallpaperInput.click(); };
    wallpaperInput.onchange = function() { setWallpaperFromFile(this.files[0]); this.value = ''; };
    wallpaperDZ.ondragover = function(e) { e.preventDefault(); this.classList.add('dragover'); };
    wallpaperDZ.ondragleave = function() { this.classList.remove('dragover'); };
    wallpaperDZ.ondrop = function(e) {
      e.preventDefault();
      this.classList.remove('dragover');
      var f = e.dataTransfer.files[0];
      if (f) setWallpaperFromFile(f);
    };
    document.getElementById('btnClearWallpaper').onclick = function() {
      localStorage.removeItem(WALLPAPER_KEY);
      applyWallpaper(null);
      updateWallpaperPreview();
    };

    document.addEventListener('dblclick', function(e) {
      if (document.body.classList.contains('ui-hidden')) {
        document.body.classList.remove('ui-hidden');
        document.body.classList.add('ui-restoring');
        requestAnimationFrame(function() {
          requestAnimationFrame(function() {
            document.body.classList.remove('ui-restoring');
          });
        });
        return;
      }
      if (e.target.closest('button, a, input, select, textarea, .local-sidebar, .modal-overlay, .ctx-menu, section, header, .drop-zone, pre, .file-list, .breadcrumb, .sidebar-resize-handle, .sidebar-collapse-btn, .sidebar-expand-tab, .file-list-item, .nav a, label, [contenteditable]')) return;
      document.body.classList.add('ui-fade-out');
      setTimeout(function() {
        document.body.classList.add('ui-hidden');
        document.body.classList.remove('ui-fade-out');
      }, 220);
    });

    (function() {
      var SIDEBAR_WIDTH_KEY = 'eduflow_sidebar_width';
      var SIDEBAR_COLLAPSED_KEY = 'eduflow_sidebar_collapsed';
      var MIN_WIDTH = 200;
      var MAX_WIDTH = 480;
      var DEFAULT_WIDTH = 280;
      var root = document.documentElement;
      function getSidebarWidth() {
        var w = parseFloat(getComputedStyle(root).getPropertyValue('--sidebar-width'));
        return isNaN(w) ? DEFAULT_WIDTH : w;
      }
      function setSidebarWidth(px) {
        px = Math.min(MAX_WIDTH, Math.max(MIN_WIDTH, px));
        root.style.setProperty('--sidebar-width', px + 'px');
        try { localStorage.setItem(SIDEBAR_WIDTH_KEY, String(px)); } catch (e) {}
      }
      function setCollapsed(collapsed) {
        if (collapsed) document.body.classList.add('sidebar-collapsed');
        else document.body.classList.remove('sidebar-collapsed');
        try { localStorage.setItem(SIDEBAR_COLLAPSED_KEY, collapsed ? '1' : '0'); } catch (e) {}
      }
      function isCollapsed() { return document.body.classList.contains('sidebar-collapsed'); }
      try {
        var savedW = localStorage.getItem(SIDEBAR_WIDTH_KEY);
        if (savedW != null) {
          var n = parseFloat(savedW);
          if (!isNaN(n)) root.style.setProperty('--sidebar-width', Math.min(MAX_WIDTH, Math.max(MIN_WIDTH, n)) + 'px');
        }
        if (localStorage.getItem(SIDEBAR_COLLAPSED_KEY) === '1') document.body.classList.add('sidebar-collapsed');
      } catch (e) {}
      var resizeHandle = document.getElementById('sidebarResizeHandle');
      var startX, startW;
      resizeHandle.onmousedown = function(e) {
        if (isCollapsed()) return;
        e.preventDefault();
        startX = e.clientX;
        startW = getSidebarWidth();
        function onMove(e) { setSidebarWidth(startW + (e.clientX - startX)); }
        function onUp() {
          document.removeEventListener('mousemove', onMove);
          document.removeEventListener('mouseup', onUp);
        }
        document.addEventListener('mousemove', onMove);
        document.addEventListener('mouseup', onUp);
      };
      document.getElementById('sidebarCollapseBtn').onclick = function() { setCollapsed(true); };
      document.getElementById('sidebarExpandTab').onclick = function() {
        setCollapsed(false);
        var w = DEFAULT_WIDTH;
        try { var s = localStorage.getItem(SIDEBAR_WIDTH_KEY); if (s != null) { var n = parseFloat(s); if (!isNaN(n)) w = n; } } catch (e) {}
        setSidebarWidth(w);
      };
    })();

    var handleStack = [];
    var pathNames = [];
    var treeRoot = null;
    var ALLOWED_SCRIPT_EXT = ['.md', '.docx', '.pdf', '.json'];
    var IDB_NAME = 'EduFlowIDB';
    var IDB_STORE = 'handles';
    var LAST_DIR_KEY = 'lastDir';

    function openIDB() {
      return new Promise(function(res, rej) {
        var r = indexedDB.open(IDB_NAME, 1);
        r.onerror = function() { rej(r.error); };
        r.onsuccess = function() { res(r.result); };
        r.onupgradeneeded = function() {
          if (!r.result.objectStoreNames.contains(IDB_STORE)) r.result.createObjectStore(IDB_STORE);
        };
      });
    }
    function saveLastDir(handle) {
      openIDB().then(function(db) {
        return new Promise(function(res, rej) {
          var t = db.transaction(IDB_STORE, 'readwrite');
          t.objectStore(IDB_STORE).put(handle, LAST_DIR_KEY);
          t.oncomplete = res;
          t.onerror = rej;
        });
      }).catch(function() {});
    }
    async function restoreLastDir() {
      try {
        if (typeof showDirectoryPicker !== 'function') return;
        var db = await openIDB();
        var handle = await new Promise(function(res, rej) {
          var t = db.transaction(IDB_STORE, 'readonly');
          var req = t.objectStore(IDB_STORE).get(LAST_DIR_KEY);
          req.onsuccess = function() { res(req.result); };
          t.onerror = function() { rej(t.error); };
        });
        if (!handle || typeof handle.queryPermission !== 'function') return;
        var state = await handle.queryPermission({ mode: 'read' });
        if (state === 'granted') {
          treeRoot = { name: handle.name, handle: handle, kind: 'dir', children: null, expanded: true };
          await loadTreeChildren(treeRoot);
          renderTree();
          return;
        }
        if (state === 'prompt') {
          state = await handle.requestPermission({ mode: 'read' });
          if (state === 'granted') {
            treeRoot = { name: handle.name, handle: handle, kind: 'dir', children: null, expanded: true };
            await loadTreeChildren(treeRoot);
            renderTree();
            return;
          }
        }
        var db2 = await openIDB();
        await new Promise(function(res, rej) {
          var t = db2.transaction(IDB_STORE, 'readwrite');
          t.objectStore(IDB_STORE).delete(LAST_DIR_KEY);
          t.oncomplete = res;
          t.onerror = rej;
        });
      } catch (e) {}
    }

    async function loadDirEntries(handle) {
      var dirs = [], files = [];
      for (var it = handle.entries(); true;) {
        var next = await it.next();
        if (next.done) break;
        var name = next.value[0];
        var entry = next.value[1];
        if (entry.kind === 'directory') dirs.push({ name: name, handle: entry });
        else if (ALLOWED_SCRIPT_EXT.some(function(ext) { return name.toLowerCase().endsWith(ext); }))
          files.push({ name: name, handle: entry });
      }
      dirs.sort(function(a, b) { return a.name.localeCompare(b.name); });
      files.sort(function(a, b) { return a.name.localeCompare(b.name); });
      return { dirs: dirs, files: files };
    }
    async function loadTreeChildren(dirNode) {
      if (dirNode.children !== null) return;
      var ent = await loadDirEntries(dirNode.handle);
      dirNode.children = [];
      ent.dirs.forEach(function(d) {
        dirNode.children.push({ name: d.name, handle: d.handle, kind: 'dir', children: null, expanded: false });
      });
      ent.files.forEach(function(f) {
        dirNode.children.push({ name: f.name, handle: f.handle, kind: 'file' });
      });
    }
    function esc(s) {
      return String(s).replace(/&/g, '&amp;').replace(/"/g, '&quot;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
    }
    function renderTree() {
      var el = document.getElementById('localFileList');
      var bread = document.getElementById('localBreadcrumb');
      if (!treeRoot) {
        bread.innerHTML = '';
        el.innerHTML = '<div class="file-list-item tree-depth-0" style="color:var(--natsume-ink-light)">è¯·å…ˆæ‹©å®šæœ¬åœ°ç›®å½•</div>';
        el._treeNodes = [];
        el._fileHandles = [];
        return;
      }
      bread.innerHTML = esc(treeRoot.name);
      var flat = [];
      function collect(node, depth, parentPath) {
        if (!node) return;
        var path = parentPath ? parentPath + '/' + node.name : node.name;
        flat.push({ node: node, depth: depth, path: path });
        if (node.kind === 'dir' && node.expanded && node.children) {
          node.children.forEach(function(c) { collect(c, depth + 1, path); });
        }
      }
      collect(treeRoot, 0, '');
      var fileIndex = 0;
      var html = '';
      flat.forEach(function(item, idx) {
        var node = item.node;
        var depth = item.depth;
        var path = item.path;
        var depthStyle = depth === 0 ? '' : ' style="--tree-depth:' + depth + '"';
        var pathAttr = ' data-path="' + esc(path) + '" data-depth="' + depth + '"';
        if (node.kind === 'dir') {
          var arrow = node.expanded ? 'â–¼' : 'â–¶';
          var expClass = node.expanded ? ' expanded' : '';
          html += '<div class="file-list-item folder' + expClass + (depth === 0 ? ' tree-depth-0' : '') + '" data-kind="dir" data-name="' + esc(node.name) + '" data-tidx="' + idx + '"' + pathAttr + depthStyle + ' draggable="true"><span class="tree-arrow">' + arrow + '</span><span class="tree-icon">ğŸ“</span>' + esc(node.name) + '</div>';
        } else {
          html += '<div class="file-list-item file' + (depth === 0 ? ' tree-depth-0' : '') + '" data-name="' + esc(node.name) + '" data-kind="file" data-fidx="' + fileIndex + '" data-tidx="' + idx + '"' + pathAttr + depthStyle + ' draggable="true"><span class="tree-icon" style="margin-left:1em">ğŸ“„</span>' + esc(node.name) + '</div>';
          fileIndex++;
        }
      });
      el.innerHTML = html || '<div class="file-list-item tree-depth-0" style="color:var(--natsume-ink-light)">ï¼ˆæ­¤å±‚æ— å‰§æœ¬æ–‡ä»¶ï¼‰</div>';
      el._treeNodes = flat.map(function(item) { return item.node; });
      el._treePaths = flat.map(function(item) { return item.path; });
      el._fileHandles = flat.filter(function(item) { return item.node.kind === 'file'; }).map(function(item) { return { name: item.node.name, handle: item.node.handle }; });
      document.getElementById('localSelected').textContent = '';
      if (typeof pendingAnalysisHandle !== 'undefined') {
        pendingAnalysisHandle = null;
        var w = document.getElementById('localAnalyzeBtnWrap');
        if (w) w.style.display = 'none';
      }
    }

    (function showDirPickerTipIfInsecure() {
      if (typeof window.isSecureContext !== 'boolean' || window.isSecureContext) return;
      var tip = document.getElementById('dirPickerTip');
      tip.textContent = 'å½“å‰ä¸º HTTP è®¿é—®ï¼Œã€Œé€‰æ‹©ç›®å½•ã€ä¸å¯ç”¨ã€‚è¯·æœ¬æœºç”¨ python run_web.py --https å¯åŠ¨åè®¿é—® https://æœ¬æœºIP:8000ï¼Œæˆ–ä½¿ç”¨å³ä¾§æ‹–æ‹½/é€‰æ–‡ä»¶ä¸Šä¼ ã€‚';
      tip.style.display = 'block';
    })();

    document.getElementById('btnPickLocalDir').onclick = async function() {
      if (typeof showDirectoryPicker !== 'function') {
        document.getElementById('localFileList').innerHTML = '<div class="file-list-item err">æ‚¨çš„æµè§ˆå™¨æš‚ä¸æ”¯æŒé€‰æ‹©ç›®å½•ï¼Œè¯·ç”¨å³ä¾§æ‹–æ‹½ä¸Šä¼ </div>';
        return;
      }
      try {
        var rootHandle = await showDirectoryPicker({ id: 'eduflow-local-dir' });
        treeRoot = { name: rootHandle.name, handle: rootHandle, kind: 'dir', children: null, expanded: true };
        var el = document.getElementById('localFileList');
        el.innerHTML = 'åŠ è½½ä¸­â€¦';
        await loadTreeChildren(treeRoot);
        renderTree();
        saveLastDir(rootHandle);
      } catch (e) {
        if (e.name !== 'AbortError') {
          var msg = (e.name === 'SecurityError' || (e.message && e.message.indexOf('secure') !== -1))
            ? 'å½“å‰ç¯å¢ƒä¸å…è®¸é€‰æ‹©ç›®å½•ï¼ˆéœ€ HTTPS æˆ– localhostï¼‰ã€‚è¯·ç”¨å³ä¾§æ‹–æ‹½/é€‰æ–‡ä»¶ä¸Šä¼ ï¼Œæˆ–æ”¹ç”¨ https://æœ¬æœºIP:8000 è®¿é—®ã€‚'
            : 'æœªæ‹©å®šç›®å½•';
          document.getElementById('localFileList').innerHTML = '<div class="file-list-item err">' + msg + '</div>';
        }
      }
    };
    restoreLastDir().catch(function() {});

    /** ä»…ä¸Šä¼ å¹¶è§£æç»“æ„ï¼Œä¸ç”Ÿæˆå¡ç‰‡ã€‚è§£æå®Œæˆåæç¤ºç”¨æˆ·ç‚¹å‡»ã€Œç”Ÿæˆå¡ç‰‡ã€ã€‚ */
    async function runUploadAndAnalyze(file) {
      var msg = document.getElementById('uploadMsg');
      msg.textContent = 'è§£ææ–‡ä»¶ä¸­â€¦';
      msg.classList.remove('err');
      try {
        var fd = new FormData();
        fd.append('file', file);
        msg.textContent = 'è§£æä¸ç»“æ„ä¸­â€¦ï¼ˆé¦–æ¬¡çº¦ 10â€“30 ç§’ï¼ŒåŒå†…å®¹ä¼šèµ°ç¼“å­˜ï¼‰';
        var r = await apiFetch('/api/script/upload', { method: 'POST', body: fd });
        var d = await r.json();
        if (!r.ok) throw new Error(d.detail || JSON.stringify(d));
        lastUploadData = d;
        msg.textContent = 'åˆ†æå®Œæˆï¼š' + (d.stages_count || 0) + ' ä¸ªé˜¶æ®µã€‚è¯·ç‚¹å‡»ã€Œç”Ÿæˆå¡ç‰‡ã€ã€‚';
      } catch (err) {
        msg.classList.add('err');
        msg.innerHTML = '<span class="err">' + (err.message || String(err)) + '</span>';
      }
    }

    async function runAnalysisForFile(fileHandle) {
      try {
        var file = await fileHandle.getFile();
        if (file) await runUploadAndAnalyze(file);
      } catch (err) {
        var msg = document.getElementById('uploadMsg');
        msg.innerHTML = '<span class="err">' + err.message + '</span>';
      }
    }

    function getFileHandleFromItem(listEl, item) {
      if (item.getAttribute('data-kind') !== 'file') return null;
      var idx = parseInt(item.getAttribute('data-fidx'), 10);
      var files = listEl._fileHandles || [];
      return files[idx] ? files[idx].handle : null;
    }

    function showContextMenu(x, y, opts) {
      var fileHandle = opts.fileHandle;
      var fileName = opts.fileName || '';
      var folderName = opts.folderName || '';
      var path = opts.path || '';
      var existing = document.getElementById('ctxMenu');
      if (existing) existing.remove();
      var menu = document.createElement('div');
      menu.id = 'ctxMenu';
      menu.className = 'ctx-menu';
      menu.style.left = x + 'px';
      menu.style.top = y + 'px';
      var copyPathItem = document.createElement('div');
      copyPathItem.className = 'ctx-menu-item';
      copyPathItem.textContent = 'å¤åˆ¶è·¯å¾„';
      copyPathItem.onclick = function() {
        if (path && navigator.clipboard && navigator.clipboard.writeText) {
          navigator.clipboard.writeText(path).catch(function() {});
        }
        document.getElementById('ctxMenu') && document.getElementById('ctxMenu').remove();
      };
      menu.appendChild(copyPathItem);
      if (folderName) {
        var setWsItem = document.createElement('div');
        setWsItem.className = 'ctx-menu-item';
        setWsItem.textContent = 'è®¾ä¸ºå½“å‰å·¥ä½œåŒº';
        setWsItem.onclick = function() {
          setWorkspaceFromFolderName(folderName);
          document.getElementById('ctxMenu') && document.getElementById('ctxMenu').remove();
        };
        menu.appendChild(setWsItem);
      }
      if (fileHandle) {
        var lower = fileName.toLowerCase();
        if (lower.endsWith('.md') || lower.endsWith('.docx')) {
          var previewItem = document.createElement('div');
          previewItem.className = 'ctx-menu-item';
          previewItem.textContent = 'åœ¨é¡µé¢å†…é¢„è§ˆ';
          previewItem.onclick = function() {
            openPreview(fileHandle, fileName);
            document.getElementById('ctxMenu') && document.getElementById('ctxMenu').remove();
          };
          menu.appendChild(previewItem);
        }
        var openItem = document.createElement('div');
        openItem.className = 'ctx-menu-item';
        openItem.textContent = 'ç”¨é»˜è®¤æ–¹å¼æ‰“å¼€';
        openItem.onclick = async function() {
          try {
            var file = await fileHandle.getFile();
            var url = URL.createObjectURL(file);
            var a = document.createElement('a');
            a.href = url;
            a.download = file.name || fileName;
            a.click();
            URL.revokeObjectURL(url);
          } catch (e) { }
          document.getElementById('ctxMenu') && document.getElementById('ctxMenu').remove();
        };
        var analyzeItem = document.createElement('div');
        analyzeItem.className = 'ctx-menu-item';
        analyzeItem.textContent = 'å¼€å§‹åˆ†æ';
        analyzeItem.onclick = function() {
          runAnalysisForFile(fileHandle);
          document.getElementById('ctxMenu') && document.getElementById('ctxMenu').remove();
        };
        menu.appendChild(openItem);
        menu.appendChild(analyzeItem);
      }
      document.body.appendChild(menu);
      function closeMenu() {
        var m = document.getElementById('ctxMenu');
        if (m) m.remove();
        document.removeEventListener('click', closeMenu);
      }
      setTimeout(function() { document.addEventListener('click', closeMenu); }, 0);
    }

    async function openPreview(fileHandle, fileName) {
      var modal = document.getElementById('previewModal');
      var titleEl = document.getElementById('previewModalTitle');
      var bodyEl = document.getElementById('previewModalBody');
      titleEl.textContent = fileName || 'é¢„è§ˆ';
      bodyEl.innerHTML = '<p style="color:var(--natsume-ink-light)">åŠ è½½ä¸­â€¦</p>';
      modal.classList.add('show');
      try {
        var file = await fileHandle.getFile();
        var lower = (fileName || '').toLowerCase();
        if (lower.endsWith('.md')) {
          var text = await file.text();
          if (typeof marked !== 'undefined') {
            marked.setOptions({ gfm: true });
            bodyEl.innerHTML = marked.parse(text || '');
          } else {
            bodyEl.textContent = text || '';
          }
        } else if (lower.endsWith('.docx')) {
          var buf = await file.arrayBuffer();
          if (typeof mammoth !== 'undefined') {
            var result = await mammoth.convertToHtml({ arrayBuffer: buf });
            bodyEl.innerHTML = result.value || '<p>ï¼ˆæ— å†…å®¹ï¼‰</p>';
          } else {
            bodyEl.innerHTML = '<p class="err">éœ€è¦ mammoth.js æ‰èƒ½é¢„è§ˆ Word æ–‡æ¡£</p>';
          }
        } else {
          bodyEl.textContent = 'ä¸æ”¯æŒé¢„è§ˆè¯¥æ ¼å¼';
        }
      } catch (e) {
        bodyEl.innerHTML = '<p class="err">é¢„è§ˆå¤±è´¥: ' + (e.message || e) + '</p>';
      }
    }
    function setWorkspaceFromFolderName(folderName) {
      var id = (folderName || '').trim().replace(/[\\/:*?"<>|]/g, '_').slice(0, 64) || 'folder';
      window.WORKSPACE_ID = id;
      history.replaceState(null, '', '/w/' + encodeURIComponent(id));
      var el = document.getElementById('currentWorkspaceLabel');
      if (el) el.textContent = id;
      if (typeof showWorkspaceToast === 'function') showWorkspaceToast(id);
    }
    function switchWorkspaceByProjectName(name) {
      var id = (name || '').trim().replace(/[\\/:*?"<>|]/g, '_').slice(0, 64) || 'default';
      window.WORKSPACE_ID = id;
      history.replaceState(null, '', '/w/' + encodeURIComponent(id));
      var el = document.getElementById('currentWorkspaceLabel');
      if (el) el.textContent = id;
      if (typeof showWorkspaceToast === 'function') showWorkspaceToast(id);
    }
    (function initPreviewModal() {
      var modal = document.getElementById('previewModal');
      document.getElementById('btnClosePreview').onclick = function() { modal.classList.remove('show'); };
      modal.onclick = function(e) { if (e.target === modal) modal.classList.remove('show'); };
    })();

    document.getElementById('localFileList').onclick = async function(e) {
      var item = e.target.closest('.file-list-item');
      if (!item) return;
      var kind = item.getAttribute('data-kind');
      var name = item.getAttribute('data-name');
      if (kind === 'dir') {
        var tidx = parseInt(item.getAttribute('data-tidx'), 10);
        var node = this._treeNodes && this._treeNodes[tidx];
        if (!node || node.kind !== 'dir') return;
        if (node.expanded) {
          node.expanded = false;
          renderTree();
        } else {
          var arrowSpan = item.querySelector('.tree-arrow');
          if (arrowSpan) { arrowSpan.textContent = 'â€¦'; item.classList.add('loading'); }
          await loadTreeChildren(node);
          node.expanded = true;
          renderTree();
        }
        return;
      }
      if (kind === 'file') {
        this.querySelectorAll('.file-list-item.selected').forEach(function(n) { n.classList.remove('selected'); });
        item.classList.add('selected');
        document.getElementById('localSelected').textContent = 'å·²æ‹©å®šï¼š' + name;
      }
    };

    document.getElementById('localFileList').ondblclick = async function(e) {
      var item = e.target.closest('.file-list-item');
      if (!item) return;
      var kind = item.getAttribute('data-kind');
      var name = item.getAttribute('data-name');
      if (kind === 'dir') {
        var tidx = parseInt(item.getAttribute('data-tidx'), 10);
        var node = this._treeNodes && this._treeNodes[tidx];
        if (!node || node.kind !== 'dir') return;
        if (node.expanded) {
          node.expanded = false;
          renderTree();
        } else {
          var arrowSpan = item.querySelector('.tree-arrow');
          if (arrowSpan) { arrowSpan.textContent = 'â€¦'; item.classList.add('loading'); }
          await loadTreeChildren(node);
          node.expanded = true;
          renderTree();
        }
        return;
      }
      if (kind === 'file') {
        var fh = getFileHandleFromItem(this, item);
        if (fh) {
          runAnalysisForFile(fh);
        }
      }
    };

    document.getElementById('localFileList').ondragstart = function(e) {
      var item = e.target.closest('.file-list-item[data-kind="file"], .file-list-item[data-kind="dir"]');
      if (!item) return;
      e.dataTransfer.setData('text/plain', 'eduflow-file');
      e.dataTransfer.effectAllowed = 'copy';
      window._eduflowDraggedPath = item.getAttribute('data-path') || '';
      if (item.getAttribute('data-kind') === 'file') {
        var idx = parseInt(item.getAttribute('data-fidx'), 10);
        var handles = this._fileHandles;
        window._eduflowDraggedFileHandle = handles && handles[idx] ? handles[idx].handle : null;
      } else {
        window._eduflowDraggedFileHandle = null;
      }
    };
    document.getElementById('localFileList').ondragend = function() {
      window._eduflowDraggedFileHandle = null;
      window._eduflowDraggedPath = null;
    };
    document.getElementById('localFileList').oncontextmenu = function(e) {
      var item = e.target.closest('.file-list-item');
      if (!item || item.classList.contains('up')) return;
      var kind = item.getAttribute('data-kind');
      if (kind !== 'file' && kind !== 'dir') return;
      e.preventDefault();
      var path = item.getAttribute('data-path') || '';
      var opts = { path: path };
      if (kind === 'file') {
        var fh = getFileHandleFromItem(this, item);
        opts.fileHandle = fh;
        opts.fileName = item.getAttribute('data-name');
      } else if (kind === 'dir') {
        opts.folderName = item.getAttribute('data-name');
      }
      showContextMenu(e.clientX, e.clientY, opts);
    };

    var lastFocusedPathInput = null;
    var workspaceFilesCache = { input: [], output: [] };
    function refreshWorkspaceFileList() {
      var listEl = document.getElementById('workspaceFileList');
      if (!listEl) return;
      listEl.innerHTML = '<div class="file-list-item" style="color:var(--natsume-ink-light)">åŠ è½½ä¸­â€¦</div>';
      Promise.all([
        apiFetch('/api/input/files').then(function(r) { return r.json(); }),
        apiFetch('/api/output/files').then(function(r) { return r.json(); })
      ]).then(function(results) {
        var inputList = (results[0] && results[0].files) ? results[0].files : [];
        var outputList = (results[1] && results[1].files) ? results[1].files : [];
        workspaceFilesCache = { input: inputList, output: outputList };
        renderWorkspaceFileList();
      }).catch(function(err) {
        listEl.innerHTML = '<div class="file-list-item err">' + (err.message || 'åŠ è½½å¤±è´¥') + '</div>';
      });
    }
    function renderWorkspaceFileList() {
      var listEl = document.getElementById('workspaceFileList');
      if (!listEl) return;
      var inp = workspaceFilesCache.input || [];
      var out = workspaceFilesCache.output || [];
      var html = '';
      if (inp.length || out.length) {
        if (out.length) {
          html += '<div class="file-list-item tree-depth-0" style="color:var(--natsume-ink-light);font-weight:bold">output/</div>';
          out.forEach(function(f) {
            var path = (f.path || '').replace(/^output\/?/, 'output/');
            var name = f.name || path.split('/').pop();
            html += '<div class="file-list-item file tree-depth-0" data-path="' + String(path).replace(/"/g, '&quot;') + '" data-name="' + String(name).replace(/"/g, '&quot;') + '" draggable="true"><span class="tree-icon" style="margin-left:1em">ğŸ“„</span>' + String(name).replace(/</g, '&lt;').replace(/>/g, '&gt;') + '</div>';
          });
        }
        if (inp.length) {
          html += '<div class="file-list-item tree-depth-0" style="color:var(--natsume-ink-light);font-weight:bold;margin-top:0.5rem">input/</div>';
          inp.forEach(function(f) {
            var path = (f.path || '').replace(/^input\/?/, 'input/');
            var name = f.name || path.split('/').pop();
            html += '<div class="file-list-item file tree-depth-0" data-path="' + String(path).replace(/"/g, '&quot;') + '" data-name="' + String(name).replace(/"/g, '&quot;') + '" draggable="true"><span class="tree-icon" style="margin-left:1em">ğŸ“„</span>' + String(name).replace(/</g, '&lt;').replace(/>/g, '&gt;') + '</div>';
          });
        }
      } else {
        html = '<div class="file-list-item tree-depth-0" style="color:var(--natsume-ink-light)">æ— æ–‡ä»¶ï¼Œæˆ–ç‚¹å‡»ã€Œåˆ·æ–°ã€</div>';
      }
      listEl.innerHTML = html || '';
      listEl.onclick = function(e) {
        var item = e.target.closest('.file-list-item.file[data-path]');
        if (!item) return;
        var path = item.getAttribute('data-path');
        if (path && lastFocusedPathInput) {
          lastFocusedPathInput.value = path;
          lastFocusedPathInput = null;
        }
      };
      listEl.ondragstart = function(e) {
        var item = e.target.closest('.file-list-item.file[data-path]');
        if (!item) return;
        e.dataTransfer.setData('text/plain', 'eduflow-file');
        e.dataTransfer.effectAllowed = 'copy';
        window._eduflowDraggedPath = item.getAttribute('data-path') || '';
      };
      listEl.ondragend = function() { window._eduflowDraggedPath = null; };
    }
    document.getElementById('sidebarTabLocal').onclick = function() {
      document.getElementById('sidebarTabLocal').classList.add('active');
      document.getElementById('sidebarTabWorkspace').classList.remove('active');
      document.getElementById('localPanel').style.display = 'block';
      document.getElementById('workspacePanel').style.display = 'none';
    };
    document.getElementById('sidebarTabWorkspace').onclick = function() {
      document.getElementById('sidebarTabWorkspace').classList.add('active');
      document.getElementById('sidebarTabLocal').classList.remove('active');
      document.getElementById('localPanel').style.display = 'none';
      document.getElementById('workspacePanel').style.display = 'block';
      if (!workspaceFilesCache.output.length && !workspaceFilesCache.input.length) refreshWorkspaceFileList();
    };
    document.getElementById('btnRefreshWorkspaceFiles').onclick = function() { refreshWorkspaceFileList(); };

    async function loadFrameworks() {
      const r = await apiFetch( '/api/frameworks');
      const d = await r.json();
      const sel = document.getElementById('frameworkId');
      sel.innerHTML = (d.frameworks || []).map(f => '<option value="' + f.id + '">' + (f.name || f.id) + '</option>').join('') || '<option value="default">default</option>';
    }
    async function loadPersonas() {
      const r = await apiFetch( '/api/personas');
      const d = await r.json();
      const sel = document.getElementById('personaId');
      const opts = (d.presets || []).map(p => '<option value="' + p + '">' + p + '</option>');
      (d.custom || []).forEach(c => opts.push('<option value="' + c + '">' + c + '</option>'));
      sel.innerHTML = opts.join('') || '<option value="excellent">excellent</option>';
    }
    loadFrameworks();
    loadPersonas();

    async function loadPlatformConfig() {
      try {
        const r = await apiFetch( '/api/platform/config');
        const d = await r.json();
        if (!r.ok) throw new Error(d.detail || JSON.stringify(d));
        document.getElementById('cfgBaseUrl').value = d.base_url || '';
        document.getElementById('cfgCookie').value = d.cookie || '';
        document.getElementById('cfgAuthorization').value = d.authorization || '';
        document.getElementById('cfgCourseId').value = d.course_id || '';
        document.getElementById('cfgTrainTaskId').value = d.train_task_id || '';
        document.getElementById('cfgStartNodeId').value = d.start_node_id || '';
        document.getElementById('cfgEndNodeId').value = d.end_node_id || '';
        document.getElementById('configMsg').textContent = 'å·²åŠ è½½å½“å‰é…ç½®';
      } catch (e) {
        document.getElementById('configMsg').innerHTML = '<span class="err">' + e.message + '</span>';
      }
    }
    document.getElementById('btnLoadConfig').onclick = loadPlatformConfig;
    document.getElementById('btnSetProject').onclick = async () => {
      const urlInput = document.getElementById('setProjectUrl');
      const msg = document.getElementById('setProjectMsg');
      const url = (urlInput && urlInput.value || '').trim();
      if (!url) { msg.innerHTML = '<span class="err">è¯·ç²˜è´´æ™ºæ…§æ ‘é¡µé¢ URL</span>'; return; }
      msg.textContent = 'è§£æä¸­â€¦';
      try {
        const r = await apiFetch('/api/platform/set-project', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ url: url, save: true }),
        });
        const d = await r.json();
        if (!r.ok) throw new Error(d.detail || JSON.stringify(d));
        document.getElementById('cfgCourseId').value = d.course_id || '';
        document.getElementById('cfgTrainTaskId').value = d.train_task_id || '';
        msg.textContent = d.message || 'å·²ä» URL å¡«å……è¯¾ç¨‹ ID ä¸ä»»åŠ¡ IDï¼Œè¯·ä¿å­˜é…ç½®';
      } catch (e) {
        msg.innerHTML = '<span class="err">' + e.message + '</span>';
      }
    };
    document.getElementById('btnSaveConfig').onclick = async (ev) => {
      ev.preventDefault();
      const msg = document.getElementById('configMsg');
      msg.textContent = 'ä¿å­˜ä¸­â€¦';
      msg.classList.remove('err');
      try {
        const r = await apiFetch('/api/platform/config', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            base_url: document.getElementById('cfgBaseUrl').value.trim(),
            cookie: document.getElementById('cfgCookie').value.trim(),
            authorization: document.getElementById('cfgAuthorization').value.trim(),
            course_id: document.getElementById('cfgCourseId').value.trim(),
            train_task_id: document.getElementById('cfgTrainTaskId').value.trim(),
            start_node_id: document.getElementById('cfgStartNodeId').value.trim(),
            end_node_id: document.getElementById('cfgEndNodeId').value.trim(),
          }),
        });
        const d = await r.json().catch(() => ({}));
        if (!r.ok) throw new Error(typeof d.detail === 'string' ? d.detail : (Array.isArray(d.detail) ? d.detail.map(x => x.msg || JSON.stringify(x)).join('; ') : JSON.stringify(d)));
        msg.textContent = d.message || 'å·²ä¿å­˜';
      } catch (e) {
        msg.innerHTML = '<span class="err">ä¿å­˜å¤±è´¥: ' + (e.message || String(e)) + '</span>';
      }
    };
    document.getElementById('btnResetToEnv').onclick = async (ev) => {
      ev.preventDefault();
      const msg = document.getElementById('configMsg');
      msg.textContent = 'æ­£åœ¨ä» .env æ¢å¤â€¦';
      try {
        const r = await apiFetch('/api/platform/reset-to-env', { method: 'POST' });
        const d = await r.json().catch(() => ({}));
        if (!r.ok) throw new Error(d.detail || JSON.stringify(d));
        msg.textContent = d.message || 'å·²ç”¨ .env è¦†ç›–å·¥ä½œåŒºé…ç½®';
        loadPlatformConfig();
      } catch (e) {
        msg.innerHTML = '<span class="err">' + (e.message || String(e)) + '</span>';
      }
    };
    loadPlatformConfig();

    document.getElementById('btnValidateTrainset').onclick = async function() {
      const msg = document.getElementById('validateTrainsetMsg');
      const pre = document.getElementById('validateTrainsetResult');
      const path = (document.getElementById('trainsetPath') && document.getElementById('trainsetPath').value || '').trim();
      if (!path) { msg.innerHTML = '<span class="err">è¯·å¡«å†™ trainset æ–‡ä»¶è·¯å¾„</span>'; return; }
      msg.textContent = 'æ ¡éªŒä¸­â€¦';
      pre.style.display = 'none';
      try {
        const r = await apiFetch('/api/trainset/validate', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ trainset_path: path }),
        });
        const d = await r.json();
        if (!r.ok) throw new Error(d.detail || JSON.stringify(d));
        msg.textContent = d.valid ? 'é€šè¿‡' : 'å­˜åœ¨å»ºè®®æˆ–é”™è¯¯';
        pre.textContent = (d.messages || []).join('\n') || '(æ— )';
        pre.style.display = 'block';
      } catch (e) {
        msg.innerHTML = '<span class="err">' + e.message + '</span>';
      }
    };
    document.getElementById('btnRunOptimizer').onclick = async function() {
      const msg = document.getElementById('optimizerMsg');
      const pre = document.getElementById('optimizerResult');
      msg.textContent = 'ä¼˜åŒ–è¿è¡Œä¸­ï¼ˆå¯èƒ½è¾ƒä¹…ï¼‰â€¦';
      pre.style.display = 'none';
      try {
        const body = {
          trainset_path: (document.getElementById('trainsetPath') && document.getElementById('trainsetPath').value || 'output/optimizer/trainset.json').trim(),
          devset_path: (document.getElementById('optimizerDevsetPath') && document.getElementById('optimizerDevsetPath').value || '').trim() || null,
          export_path: (document.getElementById('optimizerExportPath') && document.getElementById('optimizerExportPath').value.trim()) || null,
          optimizer_type: (document.getElementById('optimizerType') && document.getElementById('optimizerType').value) || 'bootstrap',
        };
        const r = await apiFetch('/api/optimizer/run', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(body),
        });
        const d = await r.json();
        if (!r.ok) throw new Error(d.detail || JSON.stringify(d));
        msg.textContent = d.message || 'ä¼˜åŒ–å®Œæˆ';
        pre.textContent = (d.hint || '') + '\n\n' + JSON.stringify(d, null, 2);
        pre.style.display = 'block';
        if (typeof refreshWorkspaceFileList === 'function') refreshWorkspaceFileList();
      } catch (e) {
        msg.innerHTML = '<span class="err">' + e.message + '</span>';
        pre.style.display = 'none';
      }
    };

    (function setupExportReportDropZone() {
      var dz = document.getElementById('exportReportDropZone');
      var fileInput = document.getElementById('exportReportFile');
      var msg = document.getElementById('uploadExportReportMsg');
      if (!dz || !fileInput || !msg) return;
      function doUpload(file) {
        if (!file) return;
        var ext = (file.name || '').toLowerCase();
        if (!ext.endsWith('.md') && !ext.endsWith('.json') && !ext.endsWith('.txt')) {
          msg.classList.add('err');
          msg.innerHTML = '<span class="err">ä»…æ”¯æŒ .md / .json / .txt</span>';
          return;
        }
        msg.textContent = 'ä¸Šä¼ ä¸­â€¦';
        msg.classList.remove('err');
        var fd = new FormData();
        fd.append('file', file);
        fd.append('subpath', 'optimizer');
        apiFetch('/api/output/upload', { method: 'POST', body: fd }).then(function(r) { return r.json().then(function(d) { return { r: r, d: d }; }); }).then(function(o) {
          if (!o.r.ok) throw new Error(o.d.error || o.d.detail || JSON.stringify(o.d));
          msg.textContent = 'å·²ä¸Šä¼ ï¼š' + (o.d.path || '');
          var exportPathInput = document.getElementById('optimizerExportPath');
          if (exportPathInput && o.d.path) exportPathInput.value = o.d.path;
          if (typeof refreshWorkspaceFileList === 'function') refreshWorkspaceFileList();
        }).catch(function(e) {
          msg.classList.add('err');
          msg.innerHTML = '<span class="err">' + (e.message || 'ä¸Šä¼ å¤±è´¥') + '</span>';
        });
      }
      dz.onclick = function() { fileInput.click(); };
      fileInput.onchange = function() { doUpload(this.files && this.files[0]); this.value = ''; };
      dz.ondragover = function(e) { e.preventDefault(); this.classList.add('dragover'); };
      dz.ondragleave = function() { this.classList.remove('dragover'); };
      dz.ondrop = function(e) {
        e.preventDefault();
        this.classList.remove('dragover');
        doUpload(e.dataTransfer && e.dataTransfer.files && e.dataTransfer.files[0]);
      };
    })();

    var scriptDZ = document.getElementById('scriptDropZone');
    var scriptFileInput = document.getElementById('scriptFile');
    scriptDZ.onclick = function() { scriptFileInput.click(); };

    async function handleScriptFile(file) {
      if (!file) return;
      await runUploadAndAnalyze(file);
      scriptFileInput.value = '';
    }

    document.getElementById('btnGenCards').onclick = async function() {
      var msg = document.getElementById('uploadMsg');
      if (!lastUploadData) {
        msg.innerHTML = '<span class="err">è¯·å…ˆä¸Šä¼ å¹¶è§£æå‰§æœ¬</span>';
        return;
      }
      msg.textContent = 'ç”Ÿæˆä¸­ï¼ˆå¯èƒ½è¾ƒä¹…ï¼‰â€¦';
      try {
        var r = await apiFetch('/api/cards/generate', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            full_content: lastUploadData.full_content,
            stages: lastUploadData.stages,
            framework_id: (document.getElementById('frameworkId') && document.getElementById('frameworkId').value) || null,
            source_filename: lastUploadData.filename || null,
          }),
        });
        var d = await r.json();
        if (!r.ok) throw new Error(d.detail || JSON.stringify(d));
        var outputPath = d.output_path || d.output_filename || '';
        var fullPath = d.full_path || ('workspaces/' + (d.workspace_id || getWorkspaceId()) + '/output/' + (d.output_filename || outputPath.replace('output/', '')));
        msg.innerHTML = 'å·²å®Œæˆç”Ÿæˆã€‚å¡ç‰‡æ–‡ä»¶ï¼š<code>' + outputPath + '</code><br><span style="color:var(--natsume-ink-light);font-size:0.9em">å®Œæ•´è·¯å¾„ï¼š' + fullPath + '</span>';
        if (d.output_path) {
          var cardsPathInput = document.getElementById('cardsPath');
          var injectCardsPathInput = document.getElementById('injectCardsPath');
          if (cardsPathInput) cardsPathInput.value = d.output_path;
          if (injectCardsPathInput) injectCardsPathInput.value = d.output_path;
        }
      } catch (e) {
        msg.innerHTML = '<span class="err">' + e.message + '</span>';
      }
    };
    scriptFileInput.onchange = function() { handleScriptFile(this.files[0]); };
    scriptDZ.ondragover = function(e) { e.preventDefault(); this.classList.add('dragover'); };
    scriptDZ.ondragleave = function() { this.classList.remove('dragover'); };
    scriptDZ.ondrop = async function(e) {
      e.preventDefault();
      this.classList.remove('dragover');
      if (window._eduflowDraggedFileHandle) {
        try {
          var file = await window._eduflowDraggedFileHandle.getFile();
          if (file) handleScriptFile(file);
        } catch (err) {}
        window._eduflowDraggedFileHandle = null;
        return;
      }
      var f = e.dataTransfer.files[0];
      if (f) handleScriptFile(f);
    };

    (function setupPathDropTargets() {
      document.querySelectorAll('.path-drop-target').forEach(function(inp) {
        inp.onfocus = function() { lastFocusedPathInput = inp; };
        inp.ondragover = function(e) {
          e.preventDefault();
          if (e.dataTransfer.types.indexOf('text/plain') !== -1) inp.classList.add('drag-over');
          e.dataTransfer.dropEffect = 'copy';
        };
        inp.ondragleave = function() { inp.classList.remove('drag-over'); };
        inp.ondrop = function(e) {
          e.preventDefault();
          inp.classList.remove('drag-over');
          if (window._eduflowDraggedPath) {
            inp.value = window._eduflowDraggedPath;
          }
        };
      });
    })();

    document.getElementById('btnSimulate').onclick = async () => {
      const path = document.getElementById('cardsPath').value.trim();
      const msg = document.getElementById('simMsg');
      const pre = document.getElementById('simResult');
      if (!path) { msg.innerHTML = '<span class="err">è¯·è¾“å…¥å¡ç‰‡æ–‡ä»¶è·¯å¾„</span>'; return; }
      msg.textContent = 'æ¨¡æ‹Ÿè¿è¡Œä¸­ï¼ˆå¯èƒ½è¾ƒä¹…ï¼‰...';
      try {
        const r = await apiFetch( '/api/simulate/run', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            cards_path: path,
            persona_id: document.getElementById('personaId').value || 'excellent',
            mode: 'auto',
            run_evaluation: true,
          }),
        });
        const d = await r.json();
        if (!r.ok) throw new Error(d.detail || JSON.stringify(d));
        msg.textContent = 'å®Œæˆï¼šsession ' + (d.session_id || '') + 'ï¼Œè½®æ¬¡ ' + (d.dialogue && d.dialogue.length);
        pre.style.display = 'block';
        pre.textContent = JSON.stringify({ session_id: d.session_id, summary: d.summary, dialogue_count: (d.dialogue || []).length, evaluation: d.evaluation }, null, 2);
      } catch (e) {
        msg.innerHTML = '<span class="err">' + e.message + '</span>';
        pre.style.display = 'none';
      }
    };

    document.getElementById('btnEvaluate').onclick = async () => {
      const path = document.getElementById('logPath').value.trim();
      const msg = document.getElementById('evalMsg');
      const pre = document.getElementById('evalResult');
      if (!path) { msg.innerHTML = '<span class="err">è¯·è¾“å…¥æ—¥å¿—æ–‡ä»¶è·¯å¾„</span>'; return; }
      msg.textContent = 'è¯„ä¼°ä¸­...';
      try {
        const saveToExport = document.getElementById('evalSaveToExport') && document.getElementById('evalSaveToExport').checked;
        const r = await apiFetch( '/api/evaluate', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ log_path: path, save_to_export: saveToExport }),
        });
        const d = await r.json();
        if (!r.ok) throw new Error(d.detail || JSON.stringify(d));
        msg.textContent = 'æ€»åˆ†ï¼š' + (d.total_score ?? '') + ' / ' + (d.max_score ?? 100) + 'ï¼Œ' + (d.rating || '');
        if (d.saved_export_path) {
          msg.textContent += 'ï¼›å·²ä¿å­˜ä¸º ' + d.saved_export_path;
          var expInp = document.getElementById('optimizerExportPath');
          if (expInp) expInp.value = d.saved_export_path;
          if (typeof refreshWorkspaceFileList === 'function') refreshWorkspaceFileList();
        }
        pre.style.display = 'block';
        pre.textContent = JSON.stringify(d, null, 2);
      } catch (e) {
        msg.innerHTML = '<span class="err">' + e.message + '</span>';
        pre.style.display = 'none';
      }
    };

    (function setupEvalLogDropZone() {
      var dz = document.getElementById('evalLogDropZone');
      var fileInput = document.getElementById('evalLogFile');
      if (!dz || !fileInput) return;
      dz.onclick = function() { fileInput.click(); };
      function doEvalFromFile(file) {
        if (!file || !file.name.toLowerCase().endsWith('.json')) return;
        var msg = document.getElementById('evalMsg');
        var pre = document.getElementById('evalResult');
        msg.textContent = 'è¯„ä¼°ä¸­...';
        msg.classList.remove('err');
        var fd = new FormData();
        fd.append('file', file);
        fd.append('save_to_export', (document.getElementById('evalFileSaveToExport') && document.getElementById('evalFileSaveToExport').checked) ? 'true' : 'false');
        apiFetch('/api/evaluate/from-file', { method: 'POST', body: fd }).then(function(r) { return r.json().then(function(d) { return { r: r, d: d }; }); }).then(function(o) {
          if (!o.r.ok) throw new Error(o.d.detail || JSON.stringify(o.d));
          msg.textContent = 'æ€»åˆ†ï¼š' + (o.d.total_score ?? '') + ' / ' + (o.d.max_score ?? 100) + 'ï¼Œ' + (o.d.rating || '');
          if (o.d.saved_export_path) {
            msg.textContent += 'ï¼›å·²ä¿å­˜ä¸º ' + o.d.saved_export_path;
            var expInp = document.getElementById('optimizerExportPath');
            if (expInp) expInp.value = o.d.saved_export_path;
            if (typeof refreshWorkspaceFileList === 'function') refreshWorkspaceFileList();
          }
          pre.style.display = 'block';
          pre.textContent = JSON.stringify(o.d, null, 2);
        }).catch(function(e) {
          msg.classList.add('err');
          msg.innerHTML = '<span class="err">' + (e.message || 'è¯„ä¼°å¤±è´¥') + '</span>';
          pre.style.display = 'none';
        });
      }
      fileInput.onchange = function() { doEvalFromFile(this.files && this.files[0]); this.value = ''; };
      dz.ondragover = function(e) { e.preventDefault(); this.classList.add('dragover'); };
      dz.ondragleave = function() { this.classList.remove('dragover'); };
      dz.ondrop = function(e) {
        e.preventDefault();
        this.classList.remove('dragover');
        var f = e.dataTransfer && e.dataTransfer.files && e.dataTransfer.files[0];
        if (f) doEvalFromFile(f);
      };
    })();

    document.getElementById('btnInjectPreview').onclick = async () => {
      const path = document.getElementById('injectCardsPath').value.trim();
      const msg = document.getElementById('injectMsg');
      const pre = document.getElementById('injectResult');
      if (!path) { msg.innerHTML = '<span class="err">è¯·è¾“å…¥å¡ç‰‡æ–‡ä»¶è·¯å¾„</span>'; return; }
      msg.textContent = 'é¢„è§ˆä¸­...';
      try {
        const r = await apiFetch( '/api/inject/preview', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ cards_path: path }),
        });
        const d = await r.json();
        if (!r.ok) throw new Error(d.detail || JSON.stringify(d));
        msg.textContent = d.summary || ('Aç±» ' + d.total_a + 'ï¼ŒBç±» ' + d.total_b);
        pre.style.display = 'block';
        pre.textContent = JSON.stringify(d, null, 2);
      } catch (e) {
        msg.innerHTML = '<span class="err">' + e.message + '</span>';
        pre.style.display = 'none';
      }
    };

    document.getElementById('btnInjectRun').onclick = async () => {
      const path = document.getElementById('injectCardsPath').value.trim();
      const taskName = document.getElementById('injectTaskName').value.trim() || null;
      const description = document.getElementById('injectDescription').value.trim() || null;
      const overwrite = !!(document.getElementById('injectOverwrite') && document.getElementById('injectOverwrite').checked);
      const msg = document.getElementById('injectMsg');
      const pre = document.getElementById('injectResult');
      if (!path) { msg.innerHTML = '<span class="err">è¯·è¾“å…¥å¡ç‰‡æ–‡ä»¶è·¯å¾„</span>'; return; }
      msg.textContent = 'æ³¨å…¥ä¸­...';
      try {
        const r = await apiFetch( '/api/inject/run', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ cards_path: path, task_name: taskName, description: description, overwrite }),
        });
        const d = await r.json();
        if (!r.ok) {
          if (r.status === 409) {
            msg.innerHTML = '<span class="err">' + (d.detail || 'æ£€æµ‹åˆ°å·²æœ‰å¡ç‰‡ï¼Œæœªè¦†å†™') + '</span>';
            pre.style.display = 'block';
            pre.textContent = JSON.stringify(d, null, 2);
            return;
          }
          throw new Error(d.detail || JSON.stringify(d));
        }
        msg.textContent = d.message || (d.success ? 'æ³¨å…¥æˆåŠŸ' : 'æ³¨å…¥å®Œæˆï¼Œè¯·æŸ¥çœ‹è¯¦æƒ…');
        if (!d.success) msg.innerHTML = '<span class="err">' + (msg.textContent) + '</span>';
        pre.style.display = 'block';
        pre.textContent = JSON.stringify(d, null, 2);
      } catch (e) {
        msg.innerHTML = '<span class="err">' + e.message + '</span>';
        pre.style.display = 'none';
      }
    };
  </script>
</body>
</html>
