<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>EduFlow 交互控制台</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@400;600&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/mammoth@1.6.0/mammoth.browser.min.js"></script>
  <style>
    :root {
      --natsume-paper: #f5f0e6;
      --natsume-cream: #ebe4d8;
      --natsume-ink: #4a4035;
      --natsume-ink-light: #6b5f52;
      --natsume-green: #6b7b6b;
      --natsume-green-soft: #8f9d8f;
      --natsume-leaf: #7d8b6f;
      --natsume-border: #d4c9b8;
      --natsume-shadow: rgba(74, 64, 53, 0.08);
      --natsume-err: #a65d4a;
      --sidebar-width: 280px;
      --sim-sidebar-width: 380px;
      /* Mac-style motion */
      --ease-out-expo: cubic-bezier(0.16, 1, 0.3, 1);
      --ease-out-quart: cubic-bezier(0.25, 1, 0.5, 1);
      --ease-in-out-smooth: cubic-bezier(0.65, 0, 0.35, 1);
      --transition-fast: 0.2s var(--ease-out-quart);
      --transition-normal: 0.3s var(--ease-out-expo);
      --transition-slow: 0.4s var(--ease-out-expo);
    }
    html {
      scrollbar-gutter: stable;
      overflow-x: hidden;
      scroll-behavior: smooth;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }
    * { box-sizing: border-box; }
    body {
      font-family: "Noto Serif SC", "Songti SC", serif;
      margin: 0;
      padding: 0;
      overflow-x: hidden;
      background: var(--natsume-paper);
      color: var(--natsume-ink);
      line-height: 1.7;
      min-height: 100vh;
      background-size: cover;
      background-position: center;
      background-attachment: fixed;
      background-repeat: no-repeat;
      background-image:
        radial-gradient(ellipse at 20% 10%, rgba(139, 157, 143, 0.06) 0%, transparent 50%),
        radial-gradient(ellipse at 80% 90%, rgba(125, 139, 111, 0.05) 0%, transparent 50%);
      display: flex;
    }
    /* 壁纸与主界面关联：整页背景在 body 上且 fixed，不随侧边栏收起/展开移动；侧边栏半透明以透出背景 */
    body.sidebar-collapsed { --sidebar-width: 0; }
    .local-sidebar {
      position: fixed;
      left: 0;
      top: 0;
      width: var(--sidebar-width);
      height: 100vh;
      display: flex;
      flex-direction: column;
      padding: 0;
      background: rgba(235, 228, 216, 0.88);
      backdrop-filter: blur(8px);
      -webkit-backdrop-filter: blur(8px);
      border-right: 1px solid var(--natsume-border);
      z-index: 20;
      transition: width var(--transition-normal);
      overflow-x: hidden;
    }
    .sidebar-resize-handle {
      position: fixed;
      left: calc(var(--sidebar-width) - 2px);
      top: 0;
      bottom: 0;
      width: 4px;
      cursor: col-resize;
      z-index: 21;
      background: transparent;
      transition: left var(--transition-normal);
    }
    .sidebar-resize-handle:hover { background: rgba(143, 157, 143, 0.2); }
    .sidebar-resize-handle:active { background: rgba(125, 139, 111, 0.3); }
    body.sidebar-collapsed .sidebar-resize-handle { display: none; }
    .sidebar-collapse-btn {
      /* Claude 风格：侧边栏内右上角，无背景无边框，悬停轻高亮 */
      position: absolute;
      top: 0.75rem;
      right: 10px;
      width: 28px;
      height: 28px;
      padding: 0;
      margin: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--natsume-ink-light);
      background: transparent;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      transition: color var(--transition-fast), background var(--transition-fast);
    }
    .sidebar-collapse-btn:hover { color: var(--natsume-ink); background: rgba(143, 157, 143, 0.12); }
    .sidebar-collapse-btn:active { background: rgba(143, 157, 143, 0.2); }
    body.sidebar-collapsed .sidebar-collapse-btn { display: none; }
    .sidebar-expand-tab {
      display: none;
      position: fixed;
      left: 8px;
      top: 16px;
      width: 28px;
      height: 28px;
      padding: 0;
      margin: 0;
      color: var(--natsume-ink-light);
      background: transparent;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      align-items: center;
      justify-content: center;
      z-index: 22;
      transition: color var(--transition-fast), background var(--transition-fast);
    }
    .sidebar-expand-tab:hover { color: var(--natsume-ink); background: rgba(143, 157, 143, 0.12); }
    .sidebar-expand-tab:active { background: rgba(143, 157, 143, 0.2); }
    body.sidebar-collapsed .sidebar-expand-tab { display: flex; }
    .main-content {
      margin-left: var(--sidebar-width);
      transition: margin-left var(--transition-normal);
      min-width: 0;
      flex: 1;
      display: flex;
      justify-content: center;
      padding: 2rem 1.5rem;
    }
    .main-content-inner {
      width: 100%;
      max-width: 900px;
    }
    .local-sidebar .sidebar-head {
      flex-shrink: 0;
      position: relative;
      padding: 1rem 36px 0.75rem 14px;
      margin: 1.25rem 10px 0 10px;
      background: transparent;
      transition: transform var(--transition-fast);
    }
    .local-sidebar .sidebar-workspace-row,
    .local-sidebar .sidebar-folder-row {
      font-size: 11px;
      line-height: 1.4;
      letter-spacing: 0.01em;
    }
    .local-sidebar .sidebar-workspace-row { color: var(--natsume-ink-light); margin-bottom: 4px; }
    .local-sidebar .sidebar-folder-row { color: var(--natsume-ink); margin-bottom: 10px; }
    .local-sidebar .sidebar-head .sidebar-workspace-name { font-weight: 600; color: var(--natsume-ink); }
    .local-sidebar .sidebar-head #btnPickLocalDir {
      width: 100%;
      padding: 6px 12px;
      font-size: 12px;
      font-weight: 500;
      color: var(--natsume-ink);
      background: rgba(143, 157, 143, 0.12);
      border: 1px solid var(--natsume-border);
      border-radius: 6px;
      cursor: pointer;
      transition: background var(--transition-fast);
    }
    .local-sidebar .sidebar-head #btnPickLocalDir:hover { background: rgba(143, 157, 143, 0.2); }
    .local-sidebar .sidebar-title {
      font-size: 0.9rem;
      font-weight: 600;
      color: var(--natsume-ink);
      margin: 0 0 0.5rem 0;
    }
    .local-sidebar .sidebar-foot {
      flex-shrink: 0;
      padding: 0.5rem 14px 0.75rem;
      margin: 0 10px 10px 10px;
      background: transparent;
      font-size: 11px;
      color: var(--natsume-ink-light);
    }
    .header {
      margin-bottom: 2rem;
      padding-bottom: 1.25rem;
      border-bottom: 1px solid var(--natsume-border);
    }
    h1 {
      font-size: 1.6rem;
      font-weight: 600;
      color: var(--natsume-ink);
      letter-spacing: 0.02em;
      margin: 0 0 0.5rem 0;
    }
    .nav {
      font-size: 0.95rem;
      color: var(--natsume-ink-light);
    }
    .nav a {
      color: var(--natsume-green);
      text-decoration: none;
      border-bottom: 1px solid transparent;
      transition: border-color var(--transition-fast), color var(--transition-fast);
    }
    .nav a:hover {
      color: var(--natsume-leaf);
      border-bottom-color: var(--natsume-leaf);
    }
    section {
      margin: 1.75rem 0;
      padding: 1.35rem 1.5rem;
      background: rgba(235, 228, 216, 0.6);
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
      border: 1px solid rgba(212, 201, 184, 0.5);
      border-radius: 14px;
      box-shadow: 0 2px 16px rgba(74, 64, 53, 0.05);
      transition: transform var(--transition-fast), box-shadow var(--transition-fast), border-color var(--transition-fast);
    }
    section:hover {
      box-shadow: 0 4px 24px rgba(74, 64, 53, 0.08);
    }
    section h2 {
      font-size: 1.15rem;
      font-weight: 600;
      color: var(--natsume-ink);
      margin: 0 0 0.6rem 0;
      padding-bottom: 0.4rem;
      border-bottom: 1px solid var(--natsume-border);
    }
    .section-title-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 1rem;
      margin: 0 0 0.6rem 0;
      padding-bottom: 0.4rem;
      border-bottom: 1px solid var(--natsume-border);
    }
    .section-title-row h2 { margin: 0; padding-bottom: 0; border-bottom: none; }
    section p {
      margin: 0 0 0.75rem 0;
      color: var(--natsume-ink-light);
      font-size: 0.95rem;
    }
    label {
      display: block;
      margin: 0.6rem 0 0.25rem;
      font-size: 0.9rem;
      color: var(--natsume-ink-light);
    }
    input[type="file"],
    input[type="text"],
    select {
      width: 100%;
      padding: 0.5rem 0.65rem;
      font-family: inherit;
      font-size: 0.95rem;
      color: var(--natsume-ink);
      background: rgba(255, 255, 255, 0.8);
      border: 1px solid var(--natsume-border);
      border-radius: 10px;
      transition: border-color var(--transition-fast), box-shadow var(--transition-fast), background var(--transition-fast);
    }
    input:hover,
    select:hover {
      background: rgba(255, 255, 255, 0.95);
    }
    input:focus,
    select:focus {
      outline: none;
      border-color: var(--natsume-green-soft);
      box-shadow: 0 0 0 3px rgba(111, 125, 111, 0.12);
      background: rgba(255, 255, 255, 1);
    }
    input::placeholder {
      color: var(--natsume-border);
    }
    button {
      margin-top: 0.5rem;
      margin-right: 0.5rem;
      padding: 0.5rem 1.1rem;
      font-family: inherit;
      font-size: 0.9rem;
      color: var(--natsume-paper);
      background: var(--natsume-green);
      border: none;
      border-radius: 10px;
      cursor: pointer;
      transition: background var(--transition-fast), transform var(--transition-fast), box-shadow var(--transition-fast);
      box-shadow: 0 2px 8px rgba(74, 64, 53, 0.1);
    }
    button:hover {
      background: var(--natsume-leaf);
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(74, 64, 53, 0.12);
    }
    button:active {
      transform: translateY(0) scale(0.98);
      transition-duration: 0.1s;
    }
    button.btn-primary {
      padding: 0.6rem 1.3rem;
      font-weight: 600;
      background: var(--natsume-leaf);
      box-shadow: 0 2px 12px rgba(125, 139, 111, 0.3);
    }
    button.btn-primary:hover {
      background: #6b7b5f;
      box-shadow: 0 4px 16px rgba(125, 139, 111, 0.35);
    }
    button.btn-secondary {
      background: var(--natsume-border);
      color: var(--natsume-ink);
    }
    button.btn-secondary:hover {
      background: var(--natsume-ink-light);
      color: var(--natsume-paper);
    }
    pre {
      margin-top: 0.75rem;
      padding: 1rem;
      background: var(--natsume-paper);
      border: 1px solid var(--natsume-border);
      border-radius: 8px;
      overflow: auto;
      font-size: 0.82rem;
      line-height: 1.5;
      color: var(--natsume-ink-light);
    }
    .gen-cards-row, .btn-row-right { display: flex; justify-content: flex-end; flex-wrap: wrap; gap: 0.5rem; }
    .gen-cards-row { margin-top: 0.9rem; }
    .quick-actions { display: flex; flex-wrap: wrap; gap: 0.5rem; align-items: center; }
    .quick-actions .qabtn {
      padding: 0.3rem 0.6rem;
      font-size: 0.85rem;
      background: var(--natsume-leaf);
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      transition: transform var(--transition-fast), filter var(--transition-fast);
    }
    .quick-actions .qabtn:hover { filter: brightness(1.08); transform: translateY(-1px); }
    .quick-actions .qabtn:disabled { opacity: 0.6; cursor: not-allowed; }
    .quick-actions .hint { color: var(--natsume-ink-light); font-size: 0.85rem; margin-left: 0.25rem; }
    .card-editor {
      width: 100%;
      max-width: 100%;
      font-family: ui-monospace, "Cascadia Code", "Source Code Pro", Menlo, monospace;
      font-size: 0.9rem;
      line-height: 1.5;
      padding: 0.6rem;
      border: 1px solid var(--natsume-border);
      border-radius: 10px;
      background: rgba(255,255,255,0.6);
      resize: vertical;
      transition: border-color var(--transition-fast), box-shadow var(--transition-fast);
    }
    .card-editor:focus {
      outline: none;
      border-color: var(--natsume-green-soft);
      box-shadow: 0 0 0 2px rgba(111, 125, 111, 0.1);
    }
    .sim-cards-container { display: flex; flex-direction: column; gap: 0.75rem; margin-top: 0.5rem; }
    .sim-card-block {
      border: 1px solid rgba(212, 201, 184, 0.6);
      border-radius: 10px;
      background: rgba(255,255,255,0.5);
      padding: 0.75rem 1rem;
      transition: box-shadow var(--transition-fast), border-color var(--transition-fast);
    }
    .sim-card-block:hover { box-shadow: 0 2px 12px rgba(74, 64, 53, 0.06); }
    .sim-card-block .sim-card-head { font-weight: 600; color: var(--natsume-ink); margin-bottom: 0.5rem; display: flex; align-items: center; gap: 0.5rem; flex-wrap: wrap; }
    .sim-card-block .sim-card-head .sim-card-id { background: var(--natsume-leaf); color: white; padding: 0.15rem 0.5rem; border-radius: 4px; font-size: 0.85rem; }
    .sim-card-block .sim-card-section { margin-top: 0.5rem; }
    .sim-card-block .sim-card-section-title { font-size: 0.8rem; color: var(--natsume-ink-light); margin-bottom: 0.2rem; }
    .sim-card-block .sim-card-section-body { font-size: 0.9rem; white-space: pre-wrap; word-break: break-word; }
    .msg {
      margin-top: 0.5rem;
      font-size: 0.9rem;
      color: var(--natsume-ink-light);
    }
    .err {
      color: var(--natsume-err);
    }
    .btn-icon {
      margin: 0;
      padding: 0.35rem 0.5rem;
      font-size: 1rem;
      line-height: 1;
      background: transparent;
      color: var(--natsume-ink-light);
      box-shadow: none;
      transition: background var(--transition-fast), color var(--transition-fast);
    }
    .btn-icon:hover { background: rgba(143, 157, 143, 0.12); color: var(--natsume-ink); }
    .modal-overlay {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(74, 64, 53, 0.25);
      backdrop-filter: blur(8px);
      -webkit-backdrop-filter: blur(8px);
      z-index: 100;
      align-items: center;
      justify-content: center;
      animation: fadeIn 0.25s var(--ease-out-quart);
    }
    .modal-overlay.show { display: flex; }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    .modal-panel {
      background: rgba(235, 228, 216, 0.95);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      border: 1px solid rgba(212, 201, 184, 0.6);
      border-radius: 16px;
      box-shadow: 0 16px 48px rgba(74, 64, 53, 0.12);
      padding: 0;
      max-width: 420px;
      width: 90%;
      animation: modalSlideIn 0.35s var(--ease-out-expo);
    }
    @keyframes modalSlideIn {
      from { opacity: 0; transform: scale(0.96) translateY(-8px); }
      to { opacity: 1; transform: scale(1) translateY(0); }
    }
    .modal-panel.settings-panel-large {
      max-width: min(90vw, 800px);
      width: 90%;
      display: flex;
      flex-direction: row;
      min-height: 420px;
    }
    .settings-nav {
      width: 180px;
      flex-shrink: 0;
      padding: 1rem 0;
      border-right: 1px solid var(--natsume-border);
      background: rgba(255, 255, 255, 0.35);
      border-radius: 12px 0 0 12px;
    }
    .settings-nav-item {
      display: block;
      width: 100%;
      padding: 0.65rem 1rem;
      text-align: left;
      font-size: 0.95rem;
      color: var(--natsume-ink);
      background: none;
      border: none;
      cursor: pointer;
      border-radius: 8px;
      box-shadow: none;
      margin: 0 0.25rem;
      transition: background var(--transition-fast), color var(--transition-fast);
    }
    .settings-nav-item:hover { background: rgba(143, 157, 143, 0.12); color: var(--natsume-ink); }
    .settings-nav-item.active { background: rgba(125, 139, 111, 0.2); color: var(--natsume-leaf); font-weight: 600; }
    .settings-content-wrap {
      flex: 1;
      padding: 1.5rem;
      overflow-y: auto;
      position: relative;
    }
    .settings-content-wrap .modal-close { position: absolute; top: 0.5rem; right: 0.5rem; margin: 0; }
    .settings-panel-page { display: none; }
    .settings-panel-page.active { display: block; }
    .settings-panel-page h3 { margin: 0 0 1rem 0; font-size: 1.1rem; color: var(--natsume-ink); }
    .modal-panel h3 { margin: 0 0 1rem 0; font-size: 1.1rem; color: var(--natsume-ink); }
    .modal-panel .modal-close { float: right; margin: -0.25rem 0 0 0; }
    .drop-zone {
      border: 2px dashed var(--natsume-border);
      border-radius: 12px;
      padding: 1.25rem;
      text-align: center;
      color: var(--natsume-ink-light);
      font-size: 0.9rem;
      cursor: pointer;
      transition: border-color var(--transition-fast), background var(--transition-fast), transform var(--transition-fast);
    }
    .drop-zone:hover, .drop-zone.dragover {
      border-color: var(--natsume-green-soft);
      background: rgba(143, 157, 143, 0.08);
    }
    .path-drop-target {
      transition: border-color var(--transition-fast), background var(--transition-fast);
    }
    .path-drop-target.drag-over { border-color: var(--natsume-green-soft); background: rgba(143, 157, 143, 0.06); }
    .drop-zone input[type="file"] { display: none; }
    #scriptFile, #wallpaperFile { display: none !important; }
    .wallpaper-preview {
      margin-bottom: 0.75rem;
      border: 1px solid var(--natsume-border);
      border-radius: 8px;
      overflow: hidden;
      background: var(--natsume-paper);
      min-height: 80px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .wallpaper-preview img { max-width: 100%; max-height: 160px; object-fit: contain; display: block; }
    .wallpaper-preview .no-preview { color: var(--natsume-ink-light); font-size: 0.9rem; }
    .file-list {
      max-height: 200px;
      overflow-y: auto;
      border: 1px solid var(--natsume-border);
      border-radius: 8px;
      margin-top: 0.5rem;
    }
    .local-sidebar .file-list {
      flex: 1;
      min-height: 0;
      max-height: none;
      overflow-x: auto;
      overflow-y: auto;
      -webkit-overflow-scrolling: touch;
      border: none;
      border-radius: 0;
      margin: 0 10px;
      padding: 4px 0;
      background: transparent;
      font-size: 12px;
    }
    .local-sidebar .file-list-item {
      padding: 4px 10px 4px 8px;
      margin: 0 4px;
      border-radius: 4px;
      font-size: 12px;
      color: var(--natsume-ink);
    }
    .local-sidebar .file-list-item:hover { background: rgba(143, 157, 143, 0.14); }
    .local-sidebar .file-list-item.selected { background: rgba(125, 139, 111, 0.22); }
    .file-list-item {
      padding: 0.35rem 0.5rem 0.35rem 0.75rem;
      font-size: 0.875rem;
      color: var(--natsume-ink);
      cursor: pointer;
      border: none;
      border-radius: 8px;
      margin: 0 0.25rem 1px 0.25rem;
      transition: background var(--transition-fast);
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
    .file-list-item:hover { background: rgba(143, 157, 143, 0.14); }
    .script-upload-row { display: flex; gap: 1rem; margin-top: 0.75rem; flex-wrap: wrap; }
    .script-upload-row .col { flex: 1; min-width: 200px; }
    .save-to-input { margin-top: 0.75rem; }
    .save-to-input label { display: inline; margin-left: 0.35rem; }
    .save-to-input input[type="text"] { margin-top: 0.35rem; }
    .sidebar-tab {
      padding: 0.2rem 0.5rem;
      font-size: 0.8rem;
      cursor: pointer;
      background: transparent;
      border: 1px solid var(--natsume-border);
      color: var(--natsume-ink);
      border-radius: 6px;
      transition: background var(--transition-fast), color var(--transition-fast);
    }
    .sidebar-tab:hover { background: rgba(143,157,143,0.15); }
    .sidebar-tab.active { background: var(--natsume-green-soft); color: var(--natsume-ink); }
    .local-sidebar .sidebar-head .breadcrumb {
      font-size: 0.8rem;
      color: var(--natsume-ink-light);
      margin: 0.35rem 0 0 0;
      min-height: 1.2em;
    }
    .local-sidebar .sidebar-head .breadcrumb {
      font-size: 0.75rem;
      color: var(--natsume-ink-light);
      margin: 0.35rem 0 0 0;
      min-height: 1em;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
    .local-sidebar .breadcrumb span { cursor: pointer; }
    .local-sidebar .breadcrumb span:hover { color: var(--natsume-green); }
    .tree-depth-0 { padding-left: 0.5rem !important; }
    .file-list-item[data-depth] { padding-left: calc(0.5rem + var(--tree-depth, 0) * 1rem) !important; }
    .file-list-item .tree-arrow {
      display: inline-block;
      width: 1em;
      margin-right: 0.2em;
      font-size: 0.7em;
      color: var(--natsume-ink-light);
      transition: transform 0.15s;
    }
    .file-list-item.folder .tree-icon { color: var(--natsume-green-soft); margin-right: 0.25em; }
    .file-list-item.file .tree-icon { color: var(--natsume-ink-light); margin-right: 0.35em; }
    .file-list-item.up { font-style: italic; color: var(--natsume-green); }
    .file-list-item.up::before { content: "↑ "; }
    .file-list-item.selected { background: rgba(125, 139, 111, 0.22); }
    .file-list-item.loading { opacity: 0.85; }
    .file-list-item.err { color: var(--natsume-err); }
    .local-sidebar .local-selected { display: none; }
    .local-sidebar .local-analyze-wrap { margin: 0; }
    .local-analyze-wrap { margin-top: 0.5rem; }
    .ctx-menu {
      position: fixed;
      z-index: 200;
      background: rgba(235, 228, 216, 0.95);
      backdrop-filter: blur(16px);
      -webkit-backdrop-filter: blur(16px);
      border: 1px solid rgba(212, 201, 184, 0.6);
      border-radius: 10px;
      box-shadow: 0 8px 24px rgba(74, 64, 53, 0.12);
      padding: 0.25rem 0;
      min-width: 140px;
    }
    .ctx-menu-item {
      padding: 0.4rem 0.75rem;
      font-size: 0.9rem;
      cursor: pointer;
      color: var(--natsume-ink);
      transition: background var(--transition-fast);
    }
    .ctx-menu-item:hover { background: rgba(143, 157, 143, 0.15); }
    #previewModal .modal-panel { max-width: min(95vw, 900px); width: 95%; max-height: 90vh; display: flex; flex-direction: column; padding: 0; }
    #previewModal .preview-header { flex-shrink: 0; padding: 0.75rem 1rem; border-bottom: 1px solid var(--natsume-border); display: flex; align-items: center; justify-content: space-between; }
    #previewModal .preview-body { flex: 1; overflow: auto; padding: 1rem; background: var(--natsume-paper); border-radius: 0 0 12px 12px; font-size: 0.9rem; line-height: 1.6; }
    #previewModal .preview-body pre, #previewModal .preview-body code { font-family: ui-monospace, monospace; }
    #previewModal .preview-body pre { padding: 0.75rem; border-radius: 6px; overflow-x: auto; }
    .header, .local-sidebar, section, .main-content,
    .sidebar-resize-handle, .sidebar-collapse-btn, .sidebar-expand-tab {
      transition: opacity var(--transition-normal);
    }
    body.ui-fade-out .header,
    body.ui-fade-out .local-sidebar,
    body.ui-fade-out section,
    body.ui-fade-out .main-content,
    body.ui-fade-out .sidebar-resize-handle,
    body.ui-fade-out .sidebar-collapse-btn,
    body.ui-fade-out .sidebar-expand-tab { opacity: 0; pointer-events: none; }
    body.ui-hidden .local-sidebar,
    body.ui-hidden .sidebar-resize-handle,
    body.ui-hidden .sidebar-collapse-btn,
    body.ui-hidden .sidebar-expand-tab,
    body.ui-hidden .header,
    body.ui-hidden section,
    body.ui-hidden .main-content { display: none !important; }
    body.ui-restoring .header,
    body.ui-restoring .local-sidebar,
    body.ui-restoring section,
    body.ui-restoring .main-content,
    body.ui-restoring .sidebar-resize-handle,
    body.ui-restoring .sidebar-collapse-btn,
    body.ui-restoring .sidebar-expand-tab { opacity: 0; }
    ::-webkit-scrollbar { width: 10px; height: 10px; }
    ::-webkit-scrollbar-track { background: transparent; }
    ::-webkit-scrollbar-thumb {
      background: rgba(212, 201, 184, 0.6);
      border-radius: 10px;
      border: 3px solid transparent;
      background-clip: padding-box;
    }
    ::-webkit-scrollbar-thumb:hover { background: rgba(143, 157, 143, 0.5); }
    ::-webkit-scrollbar-thumb:active { background: var(--natsume-green-soft); }
    @media (prefers-reduced-motion: reduce) {
      *, *::before, *::after {
        animation-duration: 0.01ms !important;
        animation-iteration-count: 1 !important;
        transition-duration: 0.01ms !important;
      }
    }
    .sim-sidebar {
      position: fixed;
      top: 0;
      right: 0;
      width: var(--sim-sidebar-width);
      min-width: 280px;
      max-width: 95vw;
      height: 100vh;
      background: rgba(235, 228, 216, 0.97);
      backdrop-filter: blur(16px);
      -webkit-backdrop-filter: blur(16px);
      border-left: 1px solid rgba(212, 201, 184, 0.6);
      box-shadow: -4px 0 24px rgba(74, 64, 53, 0.06);
      z-index: 25;
      display: flex;
      flex-direction: column;
      overflow: hidden;
      transform: translateX(100%);
      transition: transform var(--transition-normal), box-shadow var(--transition-fast);
    }
    .sim-sidebar.open {
      transform: translateX(0);
    }
    .sim-sidebar-head {
      flex-shrink: 0;
      position: relative;
      padding: 0.75rem 36px 0.75rem 1rem;
      border-bottom: 1px solid var(--natsume-border);
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    .sim-sidebar-head h3 { margin: 0; font-size: 1rem; font-weight: 600; color: var(--natsume-ink); }
    .sim-sidebar-collapse-btn {
      position: absolute;
      top: 0.75rem;
      right: 10px;
      width: 28px;
      height: 28px;
      padding: 0;
      margin: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--natsume-ink-light);
      background: transparent;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      transition: color var(--transition-fast), background var(--transition-fast);
    }
    .sim-sidebar-collapse-btn:hover { color: var(--natsume-ink); background: rgba(143, 157, 143, 0.12); }
    .sim-sidebar-collapse-btn:active { background: rgba(143, 157, 143, 0.2); }
    .sim-sidebar-body {
      flex: 1;
      overflow-y: auto;
      padding: 0.75rem 1rem;
    }
    .sim-progress {
      font-size: 0.85rem;
      color: var(--natsume-ink-light);
      margin-bottom: 1rem;
      padding: 0.5rem 0;
      border-bottom: 1px dashed var(--natsume-border);
    }
    .sim-progress-title { font-weight: 600; color: var(--natsume-ink); margin-bottom: 0.4rem; }
    .sim-progress-item { display: flex; align-items: center; gap: 0.4rem; margin: 0.2rem 0; }
    .sim-progress-item.done { color: var(--natsume-green); }
    .sim-sidebar-tab {
      display: flex;
      position: fixed;
      right: 8px;
      top: 16px;
      width: 28px;
      height: 28px;
      padding: 0;
      margin: 0;
      align-items: center;
      justify-content: center;
      color: var(--natsume-ink-light);
      background: transparent;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      z-index: 24;
      transition: color var(--transition-fast), background var(--transition-fast);
    }
    .sim-sidebar-tab:hover { color: var(--natsume-ink); background: rgba(143, 157, 143, 0.12); }
    .sim-sidebar-tab:active { background: rgba(143, 157, 143, 0.2); }
    body.sim-sidebar-open .main-content { margin-right: var(--sim-sidebar-width); transition: margin-right var(--transition-normal); }
    body.sim-sidebar-open .sim-sidebar-tab { display: none !important; }
    .sim-sidebar-resize-handle {
      position: absolute;
      left: 0;
      top: 0;
      bottom: 0;
      width: 6px;
      cursor: col-resize;
      z-index: 26;
      background: transparent;
    }
    .sim-sidebar-resize-handle:hover { background: rgba(107, 123, 107, 0.2); }
    /* 可收起区块 */
    .collapsible-section .section-header {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      cursor: pointer;
      user-select: none;
      margin: 0 0 0.6rem 0;
      padding-bottom: 0.4rem;
      border-bottom: 1px solid var(--natsume-border);
      transition: color var(--transition-fast);
    }
    .collapsible-section .section-header:hover { color: var(--natsume-leaf); }
    .collapsible-section .section-chevron {
      font-size: 0.75rem;
      color: var(--natsume-ink-light);
      transition: transform var(--transition-fast);
      flex-shrink: 0;
    }
    .collapsible-section.collapsed .section-chevron { transform: rotate(-90deg); }
    .collapsible-section .section-header h2 {
      margin: 0;
      padding-bottom: 0;
      border-bottom: none;
      flex: 1;
    }
    .collapsible-section .section-body {
      transition: opacity var(--transition-fast);
    }
    .collapsible-section.collapsed .section-body {
      display: none;
    }
    .collapsible-section.collapsed { padding-bottom: 0.75rem; }
    .sidebar-workspace-name { font-weight: 600; color: var(--natsume-ink); }
    #sidebarCurrentFolder { word-break: break-all; display: inline-block; max-width: 100%; }
  </style>
</head>
<body>
  <aside id="localSidebar" class="local-sidebar">
    <div class="sidebar-head">
      <button type="button" id="sidebarCollapseBtn" class="sidebar-collapse-btn" title="收起侧边栏" aria-label="收起侧边栏">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="4" width="18" height="16" rx="2"/><line x1="8" y1="4" x2="8" y2="20"/></svg>
      </button>
      <div class="sidebar-workspace-row">工作区：<span id="currentWorkspaceLabel" class="sidebar-workspace-name"></span></div>
      <div class="sidebar-folder-row">当前文件夹：<span id="sidebarCurrentFolder" class="breadcrumb">未择定</span></div>
      <button type="button" id="btnPickLocalDir">择定本地目录</button>
      <div id="dirPickerTip" class="file-list-item err" style="display:none; margin-top:0.35rem; font-size:0.85em;"></div>
    </div>
    <div id="localPanel" class="sidebar-panel">
      <div id="localFileList" class="file-list">请先择定本地目录</div>
    </div>
    <div class="sidebar-foot">
      <div id="localSelected" class="local-selected"></div>
    </div>
  </aside>
  <div id="sidebarResizeHandle" class="sidebar-resize-handle" title="拖拽调整宽度"></div>
  <button type="button" id="sidebarExpandTab" class="sidebar-expand-tab" title="展开侧边栏" aria-label="展开侧边栏">
    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="4" width="18" height="16" rx="2"/><line x1="16" y1="4" x2="16" y2="20"/></svg>
  </button>
  <div class="main-content">
  <div class="main-content-inner">
  <header class="header">
    <h1>EduFlow 交互控制台</h1>
    <p class="nav">
      <a href="/docs">API 文档 (OpenAPI)</a> · <a href="/api/health">健康检查</a>
      <button type="button" id="btnSimNav" class="btn-icon" title="打开仿真侧边栏">仿真</button>
      <button type="button" id="btnSettings" class="btn-icon" title="网页设置">⚙ 设置</button>
    </p>
  </header>

  <div id="settingsModal" class="modal-overlay">
    <div class="modal-panel settings-panel-large">
      <nav class="settings-nav">
        <button type="button" class="settings-nav-item active" data-settings-page="llm">API 与模型</button>
        <button type="button" class="settings-nav-item" data-settings-page="wallpaper">外观（壁纸）</button>
      </nav>
      <div class="settings-content-wrap">
        <button type="button" id="btnCloseSettings" class="modal-close btn-icon">×</button>
        <div id="settingsPageLlm" class="settings-panel-page active">
          <h3>API 与模型</h3>
          <p class="hint">解析剧本、生成卡片、Trainset 构建与迭代优化均使用此处配置。请填写您自己的 API Key。</p>
          <label>API Key</label>
          <input type="password" id="llmApiKey" placeholder="留空则保持已保存的值" autocomplete="off">
          <span id="llmApiKeyMasked" class="hint"></span>
          <label>模型</label>
          <select id="llmModelType">
            <option value="deepseek">DeepSeek</option>
            <option value="doubao">豆包</option>
            <option value="openai">OpenAI 兼容（自定义）</option>
          </select>
          <div id="llmCustomFields" style="display:none">
            <label>Base URL</label>
            <input type="text" id="llmBaseUrl" placeholder="https://api.openai.com/v1">
            <label>Model 名称</label>
            <input type="text" id="llmModelName" placeholder="gpt-4o">
          </div>
          <button type="button" id="btnSaveLlmConfig">保存 LLM 配置</button>
          <div id="llmConfigMsg" class="msg"></div>
        </div>
        <div id="settingsPageWallpaper" class="settings-panel-page">
          <h3>外观（壁纸）</h3>
          <label>壁纸</label>
          <div id="wallpaperPreview" class="wallpaper-preview"><span class="no-preview">当前未设置壁纸</span></div>
          <div id="wallpaperDropZone" class="drop-zone">将图片拖至此处，或点击选取</div>
          <input type="file" id="wallpaperFile" accept="image/*">
          <button type="button" id="btnClearWallpaper" style="margin-top:0.5rem">清除壁纸</button>
        </div>
      </div>
    </div>
  </div>

  <div id="mainConsoleView">
  <div id="previewModal" class="modal-overlay">
    <div class="modal-panel">
      <div class="preview-header">
        <strong id="previewModalTitle">预览</strong>
        <button type="button" id="btnClosePreview" class="btn-icon">×</button>
      </div>
      <div id="previewModalBody" class="preview-body"></div>
    </div>
  </div>

  <section class="collapsible-section" data-section="1">
  <div class="section-header" role="button" tabindex="0" aria-expanded="true">
    <span class="section-chevron">▼</span>
    <h2>1. 剧本与生成（含迭代优化）</h2>
  </div>
  <div class="section-body">
  <p>从左侧目录选取剧本或拖入下方；解析完成后点击「生成卡片」。可选：对卡片做迭代优化（约 15–60 分钟）。<strong>推荐流程</strong>：上传剧本 → 生成卡片 →（可选）迭代优化 → 右侧栏闭环验证 → 智慧树注入。</p>
  <label>拖入或点选剧本</label>
  <div id="scriptDropZone" class="drop-zone">将 .md / .docx / .doc / .pdf 拖至此处，或点击选取</div>
  <input type="file" id="scriptFile" accept=".md,.docx,.doc,.pdf">
  <div class="gen-cards-row">
    <button type="button" id="btnGenCards" disabled title="请先上传并解析剧本，再生成卡片">生成卡片</button>
  </div>
  <div id="uploadMsg" class="msg"></div>
  <div id="uploadQuickActions" class="quick-actions" style="display:none;margin-top:0.5rem;"></div>

  <div class="closed-loop-subsection" style="margin-top:1.25rem;padding-top:1rem;border-top:1px solid var(--natsume-border);">
    <h3 style="font-size:1rem;margin:0 0 0.5rem 0;color:var(--natsume-ink);">迭代优化</h3>
    <label>Trainset 路径</label>
    <input type="text" id="trainsetPath" class="path-drop-target" placeholder="output/optimizer/trainset.json">
    <label>Devset 路径（可选）</label>
    <input type="text" id="optimizerDevsetPath" class="path-drop-target" placeholder="">
    <div style="margin-top:0.6rem;display:flex;flex-wrap:wrap;align-items:center;gap:0.6rem;">
      <label style="margin:0;"><input type="checkbox" id="optimizerUseAutoEval" checked> 闭环模式（推荐）</label>
      <label>优化器</label>
      <select id="optimizerType" style="width:auto;"><option value="bootstrap">bootstrap</option><option value="mipro">mipro</option></select>
    </div>
    <div class="btn-row-right" style="margin-top:0.5rem;">
      <button type="button" id="btnRunOptimizer" class="btn-primary">运行优化</button>
    </div>
    <div id="optimizerProgressWrap" style="display:none;margin-top:0.5rem;">
      <div style="display:flex;justify-content:space-between;font-size:0.85rem;color:var(--natsume-ink-light);">
        <span id="optimizerProgressMsg">准备中…</span>
        <span id="optimizerProgressPct">0%</span>
      </div>
      <div style="height:6px;background:var(--natsume-border);border-radius:3px;overflow:hidden;margin-top:0.25rem;">
        <div id="optimizerProgressBar" style="height:100%;width:0%;background:var(--natsume-leaf);transition:width 0.3s;"></div>
      </div>
    </div>
    <details id="optimizerAdvancedDetails" style="margin-top:0.6rem;border:1px solid var(--natsume-border);border-radius:8px;padding:0.5rem 0.75rem;background:rgba(255,255,255,0.3);">
      <summary style="cursor:pointer;font-size:0.9rem;color:var(--natsume-ink-light);">高级：外部评估（将废弃）</summary>
      <div style="margin-top:0.6rem;">
        <label>导出文件路径</label>
        <input type="text" id="optimizerExportPath" class="path-drop-target" placeholder="output/optimizer/export_score.json">
        <div class="upload-report-wrap" style="margin-top:0.5rem;">
          <label>上传外部评估报告</label>
          <div id="exportReportDropZone" class="drop-zone" style="max-width:28rem;">将 .md / .json / .txt 报告拖至此处，或点击选取</div>
          <input type="file" id="exportReportFile" accept=".md,.json,.txt" style="display:none">
          <div id="uploadExportReportMsg" class="msg"></div>
        </div>
      </div>
    </details>
    <div id="optimizerMsg" class="msg"></div>
    <pre id="optimizerResult" style="display:none;"></pre>
  </div>
  </div>
  </section>

  <section class="collapsible-section" data-section="2">
  <div class="section-header" role="button" tabindex="0" aria-expanded="true">
    <span class="section-chevron">▼</span>
    <h2>2. 智慧树平台（配置与注入）</h2>
  </div>
  <div class="section-body">
    <p>配置写入当前工作区后，「执行注入」将使用此配置。若已在 .env 中配置，可点击「从 .env 恢复」。</p>
    <h3 style="font-size:1rem;margin:0 0 0.5rem 0;color:var(--natsume-ink);">平台配置</h3>
    <label>从智慧树页面 URL 一键填充课程/任务 ID</label>
    <input type="text" id="setProjectUrl" placeholder="https://hike-teaching-center.polymas.com/.../ability-training/create?trainTaskId=xxx">
    <div class="btn-row-right">
      <button type="button" id="btnSetProject">从 URL 设置项目</button>
    </div>
    <div id="setProjectMsg" class="msg"></div>
    <label>PLATFORM_BASE_URL</label>
    <input type="text" id="cfgBaseUrl" placeholder="https://cloudapi.polymas.com">
    <label>PLATFORM_COOKIE</label>
    <input type="text" id="cfgCookie" placeholder="">
    <label>PLATFORM_AUTHORIZATION（JWT）</label>
    <input type="text" id="cfgAuthorization" placeholder="">
    <label>PLATFORM_COURSE_ID</label>
    <input type="text" id="cfgCourseId" placeholder="">
    <label>PLATFORM_TRAIN_TASK_ID</label>
    <input type="text" id="cfgTrainTaskId" placeholder="">
    <label>PLATFORM_START_NODE_ID（训练开始节点）</label>
    <input type="text" id="cfgStartNodeId" placeholder="">
    <label>PLATFORM_END_NODE_ID（训练结束节点）</label>
    <input type="text" id="cfgEndNodeId" placeholder="">
    <div class="gen-cards-row" style="margin-top:0.5rem;">
      <button type="button" id="btnLoadConfig">加载当前配置</button>
      <button type="button" id="btnSaveConfig">保存配置</button>
      <button type="button" id="btnResetToEnv">从 .env 恢复</button>
    </div>
    <div id="configMsg" class="msg"></div>

    <h3 style="font-size:1rem;margin:1.25rem 0 0.5rem 0;color:var(--natsume-ink);">注入平台</h3>
    <p class="hint" style="margin-top:0;">将卡片 Markdown 推送到智慧树；请先保存上方配置。</p>
    <label>卡片文件路径</label>
    <input type="text" id="injectCardsPath" class="path-drop-target" list="cardsPathOptions" placeholder="output/cards_output_20260202_170046.md">
    <label>任务名称（可选，为空则不更新任务配置）</label>
    <input type="text" id="injectTaskName" placeholder="">
    <label>任务描述（可选）</label>
    <input type="text" id="injectDescription" placeholder="">
    <label style="display:flex;align-items:center;gap:0.4rem;">
      <input type="checkbox" id="injectOverwrite"> 覆写平台现有卡片（若已存在则默认阻止）
    </label>
    <div class="gen-cards-row" style="margin-top:0.5rem;">
      <button id="btnInjectPreview">预览注入</button>
      <button id="btnInjectRun">执行注入</button>
    </div>
    <div id="injectMsg" class="msg"></div>
    <pre id="injectResult" style="display:none;"></pre>
    <datalist id="cardsPathOptions"></datalist>
  </div>
  </section>
  </div>

  <button type="button" id="simSidebarTab" class="sim-sidebar-tab" title="展开仿真侧边栏" aria-label="展开仿真侧边栏">
    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="4" width="18" height="16" rx="2"/><line x1="8" y1="4" x2="8" y2="20"/></svg>
  </button>
  <aside id="simSidebar" class="sim-sidebar">
    <div id="simSidebarResizeHandle" class="sim-sidebar-resize-handle" title="拖拽调整宽度"></div>
    <div class="sim-sidebar-head">
      <button type="button" id="simSidebarClose" class="sim-sidebar-collapse-btn" title="收起侧边栏" aria-label="收起侧边栏">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="4" width="18" height="16" rx="2"/><line x1="16" y1="4" x2="16" y2="20"/></svg>
      </button>
      <h3>仿真</h3>
    </div>
    <div class="sim-sidebar-body">
      <div class="sim-progress">
        <div class="sim-progress-title">项目进度</div>
        <div id="simProgressList">
          <div class="sim-progress-item" data-step="1"><span>○</span> 1. 剧本解析</div>
          <div class="sim-progress-item" data-step="2"><span>○</span> 2. 卡片生成</div>
          <div class="sim-progress-item" data-step="3"><span>○</span> 3. 闭环验证</div>
          <div class="sim-progress-item" data-step="4"><span>○</span> 4. 闭环优化</div>
          <div class="sim-progress-item" data-step="5"><span>○</span> 5. 注入平台</div>
        </div>
      </div>
      <div class="closed-loop-subsection" style="margin-bottom:1rem;">
        <h4 style="font-size:0.95rem;margin:0 0 0.5rem 0;">单次验证（闭环 / 模拟）</h4>
        <label>卡片文件路径</label>
        <input type="text" id="cardsPath" class="path-drop-target" list="cardsPathOptions" placeholder="output/cards_output_20260202_170046.md" style="width:100%;">
        <label style="margin-top:0.4rem;">人设</label>
        <select id="personaId" style="width:100%;"></select>
        <div style="margin-top:0.6rem;display:flex;flex-wrap:wrap;align-items:center;gap:0.5rem;">
          <button id="btnClosedLoop" class="btn-primary">闭环运行</button>
          <label style="margin:0;"><input type="checkbox" id="closedLoopSaveExport" checked> 保存为优化器导出</label>
        </div>
        <div style="margin-top:0.35rem;">
          <button id="btnSimulate" class="btn-secondary">仅运行模拟</button>
        </div>
        <div id="simMsg" class="msg"></div>
        <pre id="simResult" style="display:none;font-size:0.8rem;max-height:100px;"></pre>
      </div>
      <div style="margin-bottom:1rem;">
        <h4 style="font-size:0.95rem;margin:0 0 0.5rem 0;">卡片编辑</h4>
        <label>加载卡片</label>
        <div style="display:flex;flex-wrap:wrap;gap:0.35rem;">
          <input type="text" id="cardEditPath" class="path-drop-target" list="cardsPathOptions" placeholder="output/cards_output_xxx.md" style="flex:1;min-width:8rem;">
          <button type="button" id="btnLoadCardEdit">加载</button>
          <button type="button" id="btnLoadFromCardsPath" class="qabtn" style="padding:0.25rem 0.5rem;font-size:0.85rem;">从主界面路径</button>
        </div>
        <label style="margin-top:0.5rem;">卡片内容（可编辑）</label>
        <textarea id="cardEditContent" class="card-editor" rows="12" placeholder="加载卡片后在此编辑…"></textarea>
        <div style="margin-top:0.5rem;display:flex;flex-wrap:wrap;align-items:center;gap:0.5rem;">
          <input type="text" id="cardEditSavePath" class="path-drop-target" list="cardsPathOptions" placeholder="保存路径" style="width:10rem;">
          <button type="button" id="btnSaveCardEdit">保存</button>
          <button type="button" id="btnPlayFromEditor">一键仿真</button>
          <select id="cardEditPersonaId" style="width:auto;"></select>
        </div>
        <div id="cardEditMsg" class="msg"></div>
        <pre id="cardEditResult" style="display:none;font-size:0.8rem;max-height:120px;"></pre>
      </div>
      <div>
        <h4 style="font-size:0.95rem;margin:0 0 0.5rem 0;">按步骤仿真</h4>
        <p class="hint" style="font-size:0.85rem;">加载卡片后分块展示，可直接运行模拟。</p>
        <div style="display:flex;gap:0.35rem;margin-bottom:0.5rem;">
          <input type="text" id="simModulePath" class="path-drop-target" list="cardsPathOptions" placeholder="output/cards_output_xxx.md" style="flex:1;min-width:6rem;">
          <button type="button" id="simModuleLoad">加载</button>
        </div>
        <div id="simModuleCards" class="sim-cards-container"></div>
        <div style="margin-top:0.5rem;display:flex;flex-wrap:wrap;align-items:center;gap:0.5rem;">
          <select id="simModulePersonaId" style="width:auto;"></select>
          <button type="button" id="simModuleRun">运行模拟</button>
        </div>
        <div id="simModuleMsg" class="msg"></div>
        <pre id="simModuleResult" style="display:none;font-size:0.8rem;max-height:100px;"></pre>
      </div>
      <div class="closed-loop-subsection" style="margin-top:1rem;padding-top:1rem;border-top:1px dashed var(--natsume-border);">
        <h4 style="font-size:0.95rem;margin:0 0 0.5rem 0;">单独评估</h4>
        <p class="hint" style="font-size:0.85rem;">对已有会话日志做评估；闭环运行已含评估，此处用于单独跑某次日志。</p>
        <label>会话日志路径</label>
        <input type="text" id="logPath" class="path-drop-target" list="logPathOptions" placeholder="output/simulator_output/logs/session_xxx.json" style="width:100%;">
        <datalist id="logPathOptions"></datalist>
        <div style="margin-top:0.5rem;display:flex;flex-wrap:wrap;align-items:center;gap:0.5rem;">
          <button id="btnEvaluate">按路径评估</button>
          <label style="margin:0;"><input type="checkbox" id="evalSaveToExport"> 保存为导出文件</label>
        </div>
        <div style="margin-top:0.5rem;">
          <label>或拖入会话日志</label>
          <div id="evalLogDropZone" class="drop-zone" style="max-width:100%;">将 .json 拖至此处或点击选取</div>
          <input type="file" id="evalLogFile" accept=".json" style="display:none">
          <label style="margin-top:0.35rem;"><input type="checkbox" id="evalFileSaveToExport"> 保存为导出文件</label>
        </div>
        <div id="evalMsg" class="msg"></div>
        <pre id="evalResult" style="display:none;font-size:0.8rem;max-height:100px;"></pre>
      </div>
    </div>
  </aside>
  </div>
  </div>

  <script>
    const API = '';
    const WALLPAPER_KEY = 'eduflow_wallpaper';
    const WALLPAPER_OVERLAY = 'linear-gradient(rgba(245, 240, 230, 0.88), rgba(245, 240, 230, 0.9)), ';
    let lastUploadData = null;

    function syncWorkspaceFromUrl() {
      var m = /^\/w\/([^/]+)\/?$/.exec(location.pathname);
      if (m) {
        try {
          window.WORKSPACE_ID = decodeURIComponent(m[1]);
        } catch (e) {
          window.WORKSPACE_ID = m[1];
        }
      } else {
        window.WORKSPACE_ID = 'demo';
        history.replaceState(null, '', '/w/demo');
      }
      var wl = document.getElementById('currentWorkspaceLabel');
      if (wl) wl.textContent = getWorkspaceId();
      if (typeof refreshWorkspaceFileList === 'function') refreshWorkspaceFileList();
    }
    (function ensureWorkspaceInUrl() {
      syncWorkspaceFromUrl();
      window.addEventListener('popstate', syncWorkspaceFromUrl);
      document.addEventListener('visibilitychange', function() {
        if (document.visibilityState === 'visible') syncWorkspaceFromUrl();
      });
    })();
    function getWorkspaceId() { return window.WORKSPACE_ID || ''; }
    (function initCollapsibleSections() {
      var KEY = 'eduflow_sections_collapsed';
      try {
        var saved = JSON.parse(localStorage.getItem(KEY) || '{}');
      } catch (e) { var saved = {}; }
      document.querySelectorAll('.collapsible-section').forEach(function(el) {
        var id = el.dataset.section;
        var header = el.querySelector('.section-header');
        if (!header) return;
        if (saved[id]) el.classList.add('collapsed');
        header.setAttribute('aria-expanded', el.classList.contains('collapsed') ? 'false' : 'true');
        header.onclick = function() {
          el.classList.toggle('collapsed');
          header.setAttribute('aria-expanded', el.classList.contains('collapsed') ? 'false' : 'true');
          try {
            saved[id] = el.classList.contains('collapsed');
            localStorage.setItem(KEY, JSON.stringify(saved));
          } catch (e) {}
        };
        header.onkeydown = function(e) {
          if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); header.click(); }
        };
      });
    })();
    function showWorkspaceToast(id) {
      var wl = document.getElementById('currentWorkspaceLabel');
      if (!wl) return;
      wl.textContent = '已切换: ' + id;
      setTimeout(function() { wl.textContent = id; }, 2000);
    }
    function encodeWorkspaceIdForHeader(id) {
      if (!id) return '';
      try {
        return btoa(unescape(encodeURIComponent(id)));
      } catch (e) {
        return /^[\x00-\x7F]*$/.test(id) ? id : '';
      }
    }
    function apiFetch(path, options) {
      options = options || {};
      options.headers = options.headers || {};
      var wid = getWorkspaceId();
      var encoded = encodeWorkspaceIdForHeader(wid);
      options.headers['X-Workspace-Id'] = encoded || (wid && /^[\x00-\x7F]*$/.test(wid) ? wid : '');
      var base = (typeof API !== 'undefined' && API) ? API : (window.location.origin || '');
      var url = path.startsWith('http') ? path : (base.replace(/\/$/, '') + (path.startsWith('/') ? path : '/' + path));
      return fetch(url, options);
    }
    /** 安全解析响应体为 JSON；若为非 JSON（如 500 返回的 HTML/文本）则返回 { detail: 文本 }，避免 "Unexpected token" 崩溃 */
    function safeResponseJson(r) {
      return r.text().then(function(text) {
        try { return JSON.parse(text); } catch (e) { return { detail: text || r.statusText || 'Invalid response' }; }
      });
    }

    function applyWallpaper(dataUrl) {
      if (!dataUrl) {
        document.body.style.backgroundImage = '';
        document.body.style.backgroundSize = '';
        return;
      }
      document.body.style.backgroundImage = WALLPAPER_OVERLAY + 'url(' + dataUrl + ')';
      document.body.style.backgroundSize = 'cover';
      document.body.style.backgroundPosition = 'center';
      document.body.style.backgroundAttachment = 'fixed';
    }
    function loadWallpaper() {
      try {
        const dataUrl = localStorage.getItem(WALLPAPER_KEY);
        if (dataUrl) applyWallpaper(dataUrl);
      } catch (e) {}
    }
    loadWallpaper();

    var settingsModal = document.getElementById('settingsModal');
    function updateWallpaperPreview() {
      var wrap = document.getElementById('wallpaperPreview');
      try {
        var dataUrl = localStorage.getItem(WALLPAPER_KEY);
        if (dataUrl) {
          wrap.innerHTML = '<img src="' + dataUrl + '" alt="当前壁纸">';
        } else {
          wrap.innerHTML = '<span class="no-preview">当前未设置壁纸</span>';
        }
      } catch (e) {
        wrap.innerHTML = '<span class="no-preview">当前未设置壁纸</span>';
      }
    }
    function loadLlmConfig() {
      apiFetch('/api/llm/config').then(function(r) { return safeResponseJson(r); }).then(function(data) {
        document.getElementById('llmModelType').value = data.model_type || 'deepseek';
        document.getElementById('llmApiKey').value = '';
        document.getElementById('llmApiKeyMasked').textContent = data.has_api_key ? '已保存 Key: ' + (data.api_key_masked || '***') : '未设置';
        document.getElementById('llmBaseUrl').value = data.base_url || '';
        document.getElementById('llmModelName').value = data.model || '';
        document.getElementById('llmCustomFields').style.display = (data.model_type === 'openai') ? 'block' : 'none';
      }).catch(function() {
        document.getElementById('llmApiKeyMasked').textContent = '加载失败';
      });
    }
    document.getElementById('llmModelType').onchange = function() {
      document.getElementById('llmCustomFields').style.display = (this.value === 'openai') ? 'block' : 'none';
    };
    document.getElementById('btnSaveLlmConfig').onclick = function() {
      var payload = { model_type: document.getElementById('llmModelType').value };
      var key = document.getElementById('llmApiKey').value.trim();
      if (key) payload.api_key = key;
      if (document.getElementById('llmModelType').value === 'openai') {
        payload.base_url = document.getElementById('llmBaseUrl').value.trim();
        payload.model = document.getElementById('llmModelName').value.trim();
      }
      document.getElementById('llmConfigMsg').textContent = '保存中…';
      apiFetch('/api/llm/config', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) })
        .then(function(r) { return safeResponseJson(r); })
        .then(function(data) {
          document.getElementById('llmConfigMsg').textContent = data.message || '已保存';
          loadLlmConfig();
        })
        .catch(function(e) {
          document.getElementById('llmConfigMsg').textContent = '保存失败: ' + (e.message || e);
        });
    };
    document.getElementById('btnSettings').onclick = function() {
      updateWallpaperPreview();
      loadLlmConfig();
      settingsModal.classList.add('show');
    };
    document.getElementById('btnCloseSettings').onclick = function() { settingsModal.classList.remove('show'); };
    settingsModal.onclick = function(e) { if (e.target === settingsModal) settingsModal.classList.remove('show'); };
    (function initSettingsNav() {
      var navItems = settingsModal.querySelectorAll('.settings-nav-item');
      var pages = { llm: document.getElementById('settingsPageLlm'), wallpaper: document.getElementById('settingsPageWallpaper') };
      navItems.forEach(function(btn) {
        btn.onclick = function() {
          var pageId = this.getAttribute('data-settings-page');
          navItems.forEach(function(b) { b.classList.remove('active'); });
          this.classList.add('active');
          for (var k in pages) { pages[k].classList.remove('active'); if (k === pageId) pages[k].classList.add('active'); }
        };
      });
    })();

    var wallpaperDZ = document.getElementById('wallpaperDropZone');
    var wallpaperInput = document.getElementById('wallpaperFile');
    function setWallpaperFromFile(file) {
      if (!file || !file.type.startsWith('image/')) return;
      var r = new FileReader();
      r.onload = function() {
        try {
          localStorage.setItem(WALLPAPER_KEY, r.result);
          applyWallpaper(r.result);
          updateWallpaperPreview();
        } catch (e) { alert('壁纸过大或无法保存，请换一张较小的图片'); }
      };
      r.readAsDataURL(file);
    }
    wallpaperDZ.onclick = function() { wallpaperInput.click(); };
    wallpaperInput.onchange = function() { setWallpaperFromFile(this.files[0]); this.value = ''; };
    wallpaperDZ.ondragover = function(e) { e.preventDefault(); this.classList.add('dragover'); };
    wallpaperDZ.ondragleave = function() { this.classList.remove('dragover'); };
    wallpaperDZ.ondrop = function(e) {
      e.preventDefault();
      this.classList.remove('dragover');
      var f = e.dataTransfer.files[0];
      if (f) setWallpaperFromFile(f);
    };
    document.getElementById('btnClearWallpaper').onclick = function() {
      localStorage.removeItem(WALLPAPER_KEY);
      applyWallpaper(null);
      updateWallpaperPreview();
    };

    document.addEventListener('dblclick', function(e) {
      if (document.body.classList.contains('ui-hidden')) {
        document.body.classList.remove('ui-hidden');
        document.body.classList.add('ui-restoring');
        requestAnimationFrame(function() {
          requestAnimationFrame(function() {
            document.body.classList.remove('ui-restoring');
          });
        });
        return;
      }
      if (e.target.closest('button, a, input, select, textarea, .local-sidebar, .modal-overlay, .ctx-menu, section, header, .drop-zone, pre, .file-list, .breadcrumb, .sidebar-resize-handle, .sidebar-collapse-btn, .sidebar-expand-tab, .file-list-item, .nav a, label, [contenteditable]')) return;
      document.body.classList.add('ui-fade-out');
      setTimeout(function() {
        document.body.classList.add('ui-hidden');
        document.body.classList.remove('ui-fade-out');
      }, 220);
    });

    (function() {
      var SIDEBAR_WIDTH_KEY = 'eduflow_sidebar_width';
      var SIDEBAR_COLLAPSED_KEY = 'eduflow_sidebar_collapsed';
      var MIN_WIDTH = 200;
      var MAX_WIDTH = 480;
      var DEFAULT_WIDTH = 280;
      var root = document.documentElement;
      function getSidebarWidth() {
        var w = parseFloat(getComputedStyle(root).getPropertyValue('--sidebar-width'));
        return isNaN(w) ? DEFAULT_WIDTH : w;
      }
      function setSidebarWidth(px) {
        px = Math.min(MAX_WIDTH, Math.max(MIN_WIDTH, px));
        root.style.setProperty('--sidebar-width', px + 'px');
        try { localStorage.setItem(SIDEBAR_WIDTH_KEY, String(px)); } catch (e) {}
      }
      function setCollapsed(collapsed) {
        if (collapsed) document.body.classList.add('sidebar-collapsed');
        else document.body.classList.remove('sidebar-collapsed');
        try { localStorage.setItem(SIDEBAR_COLLAPSED_KEY, collapsed ? '1' : '0'); } catch (e) {}
      }
      function isCollapsed() { return document.body.classList.contains('sidebar-collapsed'); }
      try {
        var savedW = localStorage.getItem(SIDEBAR_WIDTH_KEY);
        if (savedW != null) {
          var n = parseFloat(savedW);
          if (!isNaN(n)) root.style.setProperty('--sidebar-width', Math.min(MAX_WIDTH, Math.max(MIN_WIDTH, n)) + 'px');
        }
        if (localStorage.getItem(SIDEBAR_COLLAPSED_KEY) === '1') document.body.classList.add('sidebar-collapsed');
      } catch (e) {}
      var resizeHandle = document.getElementById('sidebarResizeHandle');
      var startX, startW;
      resizeHandle.onmousedown = function(e) {
        if (isCollapsed()) return;
        e.preventDefault();
        startX = e.clientX;
        startW = getSidebarWidth();
        function onMove(e) { setSidebarWidth(startW + (e.clientX - startX)); }
        function onUp() {
          document.removeEventListener('mousemove', onMove);
          document.removeEventListener('mouseup', onUp);
        }
        document.addEventListener('mousemove', onMove);
        document.addEventListener('mouseup', onUp);
      };
      document.getElementById('sidebarCollapseBtn').onclick = function() { setCollapsed(true); };
      document.getElementById('sidebarExpandTab').onclick = function() {
        setCollapsed(false);
        var w = DEFAULT_WIDTH;
        try { var s = localStorage.getItem(SIDEBAR_WIDTH_KEY); if (s != null) { var n = parseFloat(s); if (!isNaN(n)) w = n; } } catch (e) {}
        setSidebarWidth(w);
      };
    })();

    var handleStack = [];
    var pathNames = [];
    var treeRoot = null;
    var ALLOWED_SCRIPT_EXT = ['.md', '.docx', '.doc', '.pdf', '.json'];
    var IDB_NAME = 'EduFlowIDB';
    var IDB_STORE = 'handles';
    var LAST_DIR_KEY = 'lastDir';

    function openIDB() {
      return new Promise(function(res, rej) {
        var r = indexedDB.open(IDB_NAME, 1);
        r.onerror = function() { rej(r.error); };
        r.onsuccess = function() { res(r.result); };
        r.onupgradeneeded = function() {
          if (!r.result.objectStoreNames.contains(IDB_STORE)) r.result.createObjectStore(IDB_STORE);
        };
      });
    }
    function saveLastDir(handle) {
      openIDB().then(function(db) {
        return new Promise(function(res, rej) {
          var t = db.transaction(IDB_STORE, 'readwrite');
          t.objectStore(IDB_STORE).put(handle, LAST_DIR_KEY);
          t.oncomplete = res;
          t.onerror = rej;
        });
      }).catch(function() {});
    }
    async function restoreLastDir() {
      try {
        if (typeof showDirectoryPicker !== 'function') return;
        var db = await openIDB();
        var handle = await new Promise(function(res, rej) {
          var t = db.transaction(IDB_STORE, 'readonly');
          var req = t.objectStore(IDB_STORE).get(LAST_DIR_KEY);
          req.onsuccess = function() { res(req.result); };
          t.onerror = function() { rej(t.error); };
        });
        if (!handle || typeof handle.queryPermission !== 'function') return;
        var state = await handle.queryPermission({ mode: 'read' });
        if (state === 'granted') {
          treeRoot = { name: handle.name, handle: handle, kind: 'dir', children: null, expanded: true };
          await loadTreeChildren(treeRoot);
          renderTree();
          return;
        }
        if (state === 'prompt') {
          state = await handle.requestPermission({ mode: 'read' });
          if (state === 'granted') {
            treeRoot = { name: handle.name, handle: handle, kind: 'dir', children: null, expanded: true };
            await loadTreeChildren(treeRoot);
            renderTree();
            return;
          }
        }
        var db2 = await openIDB();
        await new Promise(function(res, rej) {
          var t = db2.transaction(IDB_STORE, 'readwrite');
          t.objectStore(IDB_STORE).delete(LAST_DIR_KEY);
          t.oncomplete = res;
          t.onerror = rej;
        });
      } catch (e) {}
    }

    async function loadDirEntries(handle) {
      var dirs = [], files = [];
      for (var it = handle.entries(); true;) {
        var next = await it.next();
        if (next.done) break;
        var name = next.value[0];
        var entry = next.value[1];
        if (entry.kind === 'directory') dirs.push({ name: name, handle: entry });
        else if (ALLOWED_SCRIPT_EXT.some(function(ext) { return name.toLowerCase().endsWith(ext); }))
          files.push({ name: name, handle: entry });
      }
      dirs.sort(function(a, b) { return a.name.localeCompare(b.name); });
      files.sort(function(a, b) { return a.name.localeCompare(b.name); });
      return { dirs: dirs, files: files };
    }
    async function loadTreeChildren(dirNode) {
      if (dirNode.children !== null) return;
      var ent = await loadDirEntries(dirNode.handle);
      dirNode.children = [];
      ent.dirs.forEach(function(d) {
        dirNode.children.push({ name: d.name, handle: d.handle, kind: 'dir', children: null, expanded: false });
      });
      ent.files.forEach(function(f) {
        dirNode.children.push({ name: f.name, handle: f.handle, kind: 'file' });
      });
    }
    function esc(s) {
      return String(s).replace(/&/g, '&amp;').replace(/"/g, '&quot;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
    }
    function renderTree() {
      var el = document.getElementById('localFileList');
      var folderLabel = document.getElementById('sidebarCurrentFolder');
      if (!treeRoot) {
        if (folderLabel) folderLabel.textContent = '未择定';
        el.innerHTML = '<div class="file-list-item tree-depth-0" style="color:var(--natsume-ink-light)">请先择定本地目录</div>';
        el._treeNodes = [];
        el._fileHandles = [];
        return;
      }
      if (folderLabel) folderLabel.textContent = treeRoot.name;
      var flat = [];
      function collect(node, depth, parentPath) {
        if (!node) return;
        var path = parentPath ? parentPath + '/' + node.name : node.name;
        flat.push({ node: node, depth: depth, path: path });
        if (node.kind === 'dir' && node.expanded && node.children) {
          node.children.forEach(function(c) { collect(c, depth + 1, path); });
        }
      }
      collect(treeRoot, 0, '');
      var fileIndex = 0;
      var html = '';
      flat.forEach(function(item, idx) {
        var node = item.node;
        var depth = item.depth;
        var path = item.path;
        var depthStyle = depth === 0 ? '' : ' style="--tree-depth:' + depth + '"';
        var pathAttr = ' data-path="' + esc(path) + '" data-depth="' + depth + '"';
        if (node.kind === 'dir') {
          var arrow = node.expanded ? '▼' : '▶';
          var expClass = node.expanded ? ' expanded' : '';
          html += '<div class="file-list-item folder' + expClass + (depth === 0 ? ' tree-depth-0' : '') + '" data-kind="dir" data-name="' + esc(node.name) + '" data-tidx="' + idx + '"' + pathAttr + depthStyle + ' draggable="true"><span class="tree-arrow">' + arrow + '</span><span class="tree-icon">📁</span>' + esc(node.name) + '</div>';
        } else {
          html += '<div class="file-list-item file' + (depth === 0 ? ' tree-depth-0' : '') + '" data-name="' + esc(node.name) + '" data-kind="file" data-fidx="' + fileIndex + '" data-tidx="' + idx + '"' + pathAttr + depthStyle + ' draggable="true"><span class="tree-icon" style="margin-left:1em">📄</span>' + esc(node.name) + '</div>';
          fileIndex++;
        }
      });
      el.innerHTML = html || '<div class="file-list-item tree-depth-0" style="color:var(--natsume-ink-light)">（此层无剧本文件）</div>';
      el._treeNodes = flat.map(function(item) { return item.node; });
      el._treePaths = flat.map(function(item) { return item.path; });
      el._fileHandles = flat.filter(function(item) { return item.node.kind === 'file'; }).map(function(item) { return { name: item.node.name, handle: item.node.handle }; });
      document.getElementById('localSelected').textContent = '';
      if (typeof pendingAnalysisHandle !== 'undefined') {
        pendingAnalysisHandle = null;
        var w = document.getElementById('localAnalyzeBtnWrap');
        if (w) w.style.display = 'none';
      }
    }

    (function showDirPickerTipIfInsecure() {
      if (typeof window.isSecureContext !== 'boolean' || window.isSecureContext) return;
      var tip = document.getElementById('dirPickerTip');
      tip.textContent = '当前为 HTTP 访问，「选择目录」不可用。请本机用 python run_web.py --https 启动后访问 https://本机IP:8000，或使用右侧拖拽/选文件上传。';
      tip.style.display = 'block';
    })();

    document.getElementById('btnPickLocalDir').onclick = async function() {
      if (typeof showDirectoryPicker !== 'function') {
        document.getElementById('localFileList').innerHTML = '<div class="file-list-item err">您的浏览器暂不支持选择目录，请用右侧拖拽上传</div>';
        return;
      }
      try {
        var rootHandle = await showDirectoryPicker({ id: 'eduflow-local-dir' });
        treeRoot = { name: rootHandle.name, handle: rootHandle, kind: 'dir', children: null, expanded: true };
        var el = document.getElementById('localFileList');
        el.innerHTML = '加载中…';
        await loadTreeChildren(treeRoot);
        renderTree();
        saveLastDir(rootHandle);
      } catch (e) {
        if (e.name !== 'AbortError') {
          var msg = (e.name === 'SecurityError' || (e.message && e.message.indexOf('secure') !== -1))
            ? '当前环境不允许选择目录（需 HTTPS 或 localhost）。请用右侧拖拽/选文件上传，或改用 https://本机IP:8000 访问。'
            : '未择定目录';
          document.getElementById('localFileList').innerHTML = '<div class="file-list-item err">' + msg + '</div>';
        }
      }
    };
    restoreLastDir().catch(function() {});

    /** 仅上传并解析结构，不生成卡片。解析完成后提示用户点击「生成卡片」。 */
    async function runUploadAndAnalyze(file) {
      var msg = document.getElementById('uploadMsg');
      msg.textContent = '解析文件中…';
      msg.classList.remove('err');
      lastUploadData = null;
      var genBtn = document.getElementById('btnGenCards');
      if (genBtn) {
        genBtn.disabled = true;
      }
      try {
        var fd = new FormData();
        fd.append('file', file);
        msg.textContent = '解析与分幕中…（首次约 10–30 秒，同内容会走缓存）';
        var r = await apiFetch('/api/script/upload', { method: 'POST', body: fd });
        var d = await safeResponseJson(r);
        if (!r.ok) throw new Error(d.detail || JSON.stringify(d));
        lastUploadData = d;
        msg.textContent = '分析完成：识别出 ' + (d.stages_count || 0) + ' 个阶段。现在可以点击「生成卡片」，再依次进行学生模拟、评估和平台注入。';
        if (typeof window.updateSimProgress === 'function') window.updateSimProgress({1: true});
        if (genBtn) {
          genBtn.disabled = false;
        }
      } catch (err) {
        msg.classList.add('err');
        msg.innerHTML = '<span class="err">' + (err.message || String(err)) + '</span>';
        lastUploadData = null;
        if (genBtn) {
          genBtn.disabled = true;
        }
      }
    }

    async function runAnalysisForFile(fileHandle) {
      try {
        var file = await fileHandle.getFile();
        if (file) await runUploadAndAnalyze(file);
      } catch (err) {
        var msg = document.getElementById('uploadMsg');
        msg.innerHTML = '<span class="err">' + err.message + '</span>';
      }
    }

    function getFileHandleFromItem(listEl, item) {
      if (item.getAttribute('data-kind') !== 'file') return null;
      var idx = parseInt(item.getAttribute('data-fidx'), 10);
      var files = listEl._fileHandles || [];
      return files[idx] ? files[idx].handle : null;
    }

    function showContextMenu(x, y, opts) {
      var fileHandle = opts.fileHandle;
      var fileName = opts.fileName || '';
      var folderName = opts.folderName || '';
      var path = opts.path || '';
      var existing = document.getElementById('ctxMenu');
      if (existing) existing.remove();
      var menu = document.createElement('div');
      menu.id = 'ctxMenu';
      menu.className = 'ctx-menu';
      menu.style.left = x + 'px';
      menu.style.top = y + 'px';
      var copyPathItem = document.createElement('div');
      copyPathItem.className = 'ctx-menu-item';
      copyPathItem.textContent = '复制路径';
      copyPathItem.onclick = function() {
        if (path && navigator.clipboard && navigator.clipboard.writeText) {
          navigator.clipboard.writeText(path).catch(function() {});
        }
        document.getElementById('ctxMenu') && document.getElementById('ctxMenu').remove();
      };
      menu.appendChild(copyPathItem);
      if (folderName) {
        var setWsItem = document.createElement('div');
        setWsItem.className = 'ctx-menu-item';
        setWsItem.textContent = '设为当前工作区';
        setWsItem.onclick = function() {
          setWorkspaceFromFolderName(folderName);
          document.getElementById('ctxMenu') && document.getElementById('ctxMenu').remove();
        };
        menu.appendChild(setWsItem);
      }
      if (fileHandle) {
        var lower = fileName.toLowerCase();
        if (lower.endsWith('.md') || lower.endsWith('.docx') || lower.endsWith('.doc')) {
          var previewItem = document.createElement('div');
          previewItem.className = 'ctx-menu-item';
          previewItem.textContent = '在页面内预览';
          previewItem.onclick = function() {
            openPreview(fileHandle, fileName);
            document.getElementById('ctxMenu') && document.getElementById('ctxMenu').remove();
          };
          menu.appendChild(previewItem);
        }
        var openItem = document.createElement('div');
        openItem.className = 'ctx-menu-item';
        openItem.textContent = '用默认方式打开';
        openItem.onclick = async function() {
          try {
            var file = await fileHandle.getFile();
            var url = URL.createObjectURL(file);
            var a = document.createElement('a');
            a.href = url;
            a.download = file.name || fileName;
            a.click();
            URL.revokeObjectURL(url);
          } catch (e) { }
          document.getElementById('ctxMenu') && document.getElementById('ctxMenu').remove();
        };
        var analyzeItem = document.createElement('div');
        analyzeItem.className = 'ctx-menu-item';
        analyzeItem.textContent = '开始分析';
        analyzeItem.onclick = function() {
          runAnalysisForFile(fileHandle);
          document.getElementById('ctxMenu') && document.getElementById('ctxMenu').remove();
        };
        menu.appendChild(openItem);
        menu.appendChild(analyzeItem);
      }
      document.body.appendChild(menu);
      function closeMenu() {
        var m = document.getElementById('ctxMenu');
        if (m) m.remove();
        document.removeEventListener('click', closeMenu);
      }
      setTimeout(function() { document.addEventListener('click', closeMenu); }, 0);
    }

    async function openPreview(fileHandle, fileName) {
      var modal = document.getElementById('previewModal');
      var titleEl = document.getElementById('previewModalTitle');
      var bodyEl = document.getElementById('previewModalBody');
      titleEl.textContent = fileName || '预览';
      bodyEl.innerHTML = '<p style="color:var(--natsume-ink-light)">加载中…</p>';
      modal.classList.add('show');
      try {
        var file = await fileHandle.getFile();
        var lower = (fileName || '').toLowerCase();
        if (lower.endsWith('.md')) {
          var text = await file.text();
          if (typeof marked !== 'undefined') {
            marked.setOptions({ gfm: true });
            bodyEl.innerHTML = marked.parse(text || '');
          } else {
            bodyEl.textContent = text || '';
          }
        } else if (lower.endsWith('.docx')) {
          var buf = await file.arrayBuffer();
          if (typeof mammoth !== 'undefined') {
            var result = await mammoth.convertToHtml({ arrayBuffer: buf });
            bodyEl.innerHTML = result.value || '<p>（无内容）</p>';
          } else {
            bodyEl.innerHTML = '<p class="err">需要 mammoth.js 才能预览 Word 文档</p>';
          }
        } else if (lower.endsWith('.doc')) {
          bodyEl.innerHTML = '<p>.doc 格式暂不支持页面内预览，请另存为 .docx 后预览，或下载后用 Word 打开。</p>';
        } else {
          bodyEl.textContent = '不支持预览该格式';
        }
      } catch (e) {
        bodyEl.innerHTML = '<p class="err">预览失败: ' + (e.message || e) + '</p>';
      }
    }
    function setWorkspaceFromFolderName(folderName) {
      var id = (folderName || '').trim().replace(/[\\/:*?"<>|]/g, '_').slice(0, 64) || 'folder';
      window.WORKSPACE_ID = id;
      history.replaceState(null, '', '/w/' + encodeURIComponent(id));
      var el = document.getElementById('currentWorkspaceLabel');
      if (el) el.textContent = id;
      if (typeof showWorkspaceToast === 'function') showWorkspaceToast(id);
    }
    function switchWorkspaceByProjectName(name) {
      var id = (name || '').trim().replace(/[\\/:*?"<>|]/g, '_').slice(0, 64) || 'default';
      window.WORKSPACE_ID = id;
      history.replaceState(null, '', '/w/' + encodeURIComponent(id));
      var el = document.getElementById('currentWorkspaceLabel');
      if (el) el.textContent = id;
      if (typeof showWorkspaceToast === 'function') showWorkspaceToast(id);
    }
    (function initPreviewModal() {
      var modal = document.getElementById('previewModal');
      document.getElementById('btnClosePreview').onclick = function() { modal.classList.remove('show'); };
      modal.onclick = function(e) { if (e.target === modal) modal.classList.remove('show'); };
    })();

    document.getElementById('localFileList').onclick = async function(e) {
      var item = e.target.closest('.file-list-item');
      if (!item) return;
      var kind = item.getAttribute('data-kind');
      var name = item.getAttribute('data-name');
      if (kind === 'dir') {
        var tidx = parseInt(item.getAttribute('data-tidx'), 10);
        var node = this._treeNodes && this._treeNodes[tidx];
        if (!node || node.kind !== 'dir') return;
        if (node.expanded) {
          node.expanded = false;
          renderTree();
        } else {
          var arrowSpan = item.querySelector('.tree-arrow');
          if (arrowSpan) { arrowSpan.textContent = '…'; item.classList.add('loading'); }
          await loadTreeChildren(node);
          node.expanded = true;
          renderTree();
        }
        return;
      }
      if (kind === 'file') {
        this.querySelectorAll('.file-list-item.selected').forEach(function(n) { n.classList.remove('selected'); });
        item.classList.add('selected');
        document.getElementById('localSelected').textContent = '已择定：' + name;
      }
    };

    document.getElementById('localFileList').ondblclick = async function(e) {
      var item = e.target.closest('.file-list-item');
      if (!item) return;
      var kind = item.getAttribute('data-kind');
      var name = item.getAttribute('data-name');
      if (kind === 'dir') {
        var tidx = parseInt(item.getAttribute('data-tidx'), 10);
        var node = this._treeNodes && this._treeNodes[tidx];
        if (!node || node.kind !== 'dir') return;
        if (node.expanded) {
          node.expanded = false;
          renderTree();
        } else {
          var arrowSpan = item.querySelector('.tree-arrow');
          if (arrowSpan) { arrowSpan.textContent = '…'; item.classList.add('loading'); }
          await loadTreeChildren(node);
          node.expanded = true;
          renderTree();
        }
        return;
      }
      if (kind === 'file') {
        var fh = getFileHandleFromItem(this, item);
        if (fh) {
          runAnalysisForFile(fh);
        }
      }
    };

    document.getElementById('localFileList').ondragstart = function(e) {
      var item = e.target.closest('.file-list-item[data-kind="file"], .file-list-item[data-kind="dir"]');
      if (!item) return;
      e.dataTransfer.setData('text/plain', 'eduflow-file');
      e.dataTransfer.effectAllowed = 'copy';
      window._eduflowDraggedPath = item.getAttribute('data-path') || '';
      if (item.getAttribute('data-kind') === 'file') {
        var idx = parseInt(item.getAttribute('data-fidx'), 10);
        var handles = this._fileHandles;
        window._eduflowDraggedFileHandle = handles && handles[idx] ? handles[idx].handle : null;
      } else {
        window._eduflowDraggedFileHandle = null;
      }
    };
    document.getElementById('localFileList').ondragend = function() {
      window._eduflowDraggedFileHandle = null;
      window._eduflowDraggedPath = null;
    };
    document.getElementById('localFileList').oncontextmenu = function(e) {
      var item = e.target.closest('.file-list-item');
      if (!item || item.classList.contains('up')) return;
      var kind = item.getAttribute('data-kind');
      if (kind !== 'file' && kind !== 'dir') return;
      e.preventDefault();
      var path = item.getAttribute('data-path') || '';
      var opts = { path: path };
      if (kind === 'file') {
        var fh = getFileHandleFromItem(this, item);
        opts.fileHandle = fh;
        opts.fileName = item.getAttribute('data-name');
      } else if (kind === 'dir') {
        opts.folderName = item.getAttribute('data-name');
      }
      showContextMenu(e.clientX, e.clientY, opts);
    };

    var lastFocusedPathInput = null;
    var workspaceFilesCache = { input: [], output: [] };
    function refreshWorkspaceFileList() {
      Promise.all([
        apiFetch('/api/input/files').then(function(r) { return safeResponseJson(r); }),
        apiFetch('/api/output/files').then(function(r) { return safeResponseJson(r); })
      ]).then(function(results) {
        var inputList = (results[0] && results[0].files) ? results[0].files : [];
        var outputList = (results[1] && results[1].files) ? results[1].files : [];
        workspaceFilesCache = { input: inputList, output: outputList };
        renderWorkspaceFileList();
      }).catch(function() {});
    }
    function renderWorkspaceFileList() {
      var listEl = document.getElementById('workspaceFileList');
      var inp = workspaceFilesCache.input || [];
      var out = workspaceFilesCache.output || [];
      var html = '';
      if (inp.length || out.length) {
        if (out.length) {
          html += '<div class="file-list-item tree-depth-0" style="color:var(--natsume-ink-light);font-weight:bold">output/</div>';
          out.forEach(function(f) {
            var path = (f.path || '').replace(/^output\/?/, 'output/');
            var name = f.name || path.split('/').pop();
            html += '<div class="file-list-item file tree-depth-0" data-path="' + String(path).replace(/"/g, '&quot;') + '" data-name="' + String(name).replace(/"/g, '&quot;') + '" draggable="true"><span class="tree-icon" style="margin-left:1em">📄</span>' + String(name).replace(/</g, '&lt;').replace(/>/g, '&gt;') + '</div>';
          });
        }
        if (inp.length) {
          html += '<div class="file-list-item tree-depth-0" style="color:var(--natsume-ink-light);font-weight:bold;margin-top:0.5rem">input/</div>';
          inp.forEach(function(f) {
            var path = (f.path || '').replace(/^input\/?/, 'input/');
            var name = f.name || path.split('/').pop();
            html += '<div class="file-list-item file tree-depth-0" data-path="' + String(path).replace(/"/g, '&quot;') + '" data-name="' + String(name).replace(/"/g, '&quot;') + '" draggable="true"><span class="tree-icon" style="margin-left:1em">📄</span>' + String(name).replace(/</g, '&lt;').replace(/>/g, '&gt;') + '</div>';
          });
        }
      } else {
        html = '<div class="file-list-item tree-depth-0" style="color:var(--natsume-ink-light)">无文件</div>';
      }
      if (listEl) {
        listEl.innerHTML = html || '';
        listEl.onclick = function(e) {
          var item = e.target.closest('.file-list-item.file[data-path]');
          if (!item) return;
          var path = item.getAttribute('data-path');
          if (path && lastFocusedPathInput) {
            lastFocusedPathInput.value = (typeof normalizePathForBackend === 'function' ? normalizePathForBackend(path) : path);
            lastFocusedPathInput = null;
          }
        };
        listEl.ondragstart = function(e) {
          var item = e.target.closest('.file-list-item.file[data-path]');
          if (!item) return;
          e.dataTransfer.setData('text/plain', 'eduflow-file');
          e.dataTransfer.effectAllowed = 'copy';
          window._eduflowDraggedPath = item.getAttribute('data-path') || '';
        };
        listEl.ondragend = function() { window._eduflowDraggedPath = null; };
      }
      updatePathDatalists();
    }
    function updatePathDatalists() {
      var out = workspaceFilesCache.output || [];
      var cardsDl = document.getElementById('cardsPathOptions');
      var logDl = document.getElementById('logPathOptions');
      if (cardsDl) {
        cardsDl.innerHTML = out.filter(function(f) { return (f.path || '').toLowerCase().endsWith('.md'); }).map(function(f) {
          var p = (f.path || '').replace(/^output\/?/, 'output/');
          return '<option value="' + p.replace(/"/g, '&quot;') + '">';
        }).join('');
      }
      if (logDl) {
        logDl.innerHTML = out.filter(function(f) { return (f.path || '').toLowerCase().endsWith('.json'); }).map(function(f) {
          var p = (f.path || '').replace(/^output\/?/, 'output/');
          return '<option value="' + p.replace(/"/g, '&quot;') + '">';
        }).join('');
      }
    }
    refreshWorkspaceFileList();

    async function loadPersonas() {
      const r = await apiFetch( '/api/personas');
      const d = await safeResponseJson(r);
      const sel = document.getElementById('personaId');
      const opts = (d.presets || []).map(p => '<option value="' + p + '">' + p + '</option>');
      (d.custom || []).forEach(c => opts.push('<option value="' + c + '">' + c + '</option>'));
      sel.innerHTML = opts.join('') || '<option value="excellent">excellent</option>';
      var cardEditSel = document.getElementById('cardEditPersonaId');
      if (cardEditSel) cardEditSel.innerHTML = sel.innerHTML;
      var simPersonaSel = document.getElementById('simModulePersonaId');
      if (simPersonaSel) simPersonaSel.innerHTML = sel.innerHTML;
    }
    loadPersonas();

    var lastLoadedPlatformConfig = {};
    function setPlatformInputPlaceholder(id, value) {
      var el = document.getElementById(id);
      if (!el) return;
      el.placeholder = value || '';
      el.value = '';
    }
    async function loadPlatformConfig() {
      try {
        const r = await apiFetch( '/api/platform/config');
        const d = await safeResponseJson(r);
        if (!r.ok) throw new Error(d.detail || JSON.stringify(d));
        lastLoadedPlatformConfig = {
          base_url: d.base_url || '',
          cookie: d.cookie || '',
          authorization: d.authorization || '',
          course_id: d.course_id || '',
          train_task_id: d.train_task_id || '',
          start_node_id: d.start_node_id || '',
          end_node_id: d.end_node_id || '',
        };
        setPlatformInputPlaceholder('cfgBaseUrl', lastLoadedPlatformConfig.base_url);
        setPlatformInputPlaceholder('cfgCookie', lastLoadedPlatformConfig.cookie);
        setPlatformInputPlaceholder('cfgAuthorization', lastLoadedPlatformConfig.authorization);
        setPlatformInputPlaceholder('cfgCourseId', lastLoadedPlatformConfig.course_id);
        setPlatformInputPlaceholder('cfgTrainTaskId', lastLoadedPlatformConfig.train_task_id);
        setPlatformInputPlaceholder('cfgStartNodeId', lastLoadedPlatformConfig.start_node_id);
        setPlatformInputPlaceholder('cfgEndNodeId', lastLoadedPlatformConfig.end_node_id);
        document.getElementById('configMsg').textContent = '已加载当前配置';
      } catch (e) {
        document.getElementById('configMsg').innerHTML = '<span class="err">' + e.message + '</span>';
      }
    }
    document.getElementById('btnLoadConfig').onclick = loadPlatformConfig;
    document.getElementById('btnSetProject').onclick = async () => {
      const urlInput = document.getElementById('setProjectUrl');
      const msg = document.getElementById('setProjectMsg');
      const url = (urlInput && urlInput.value || '').trim();
      if (!url) { msg.innerHTML = '<span class="err">请粘贴智慧树页面 URL</span>'; return; }
      msg.textContent = '解析中…';
      try {
        const r = await apiFetch('/api/platform/set-project', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ url: url, save: true }),
        });
        const d = await safeResponseJson(r);
        if (!r.ok) throw new Error(d.detail || JSON.stringify(d));
        lastLoadedPlatformConfig.course_id = d.course_id || '';
        lastLoadedPlatformConfig.train_task_id = d.train_task_id || '';
        var courseEl = document.getElementById('cfgCourseId');
        var taskEl = document.getElementById('cfgTrainTaskId');
        if (courseEl) { courseEl.placeholder = lastLoadedPlatformConfig.course_id; courseEl.value = ''; }
        if (taskEl) { taskEl.placeholder = lastLoadedPlatformConfig.train_task_id; taskEl.value = ''; }
        msg.textContent = d.message || '已从 URL 填充课程 ID 与任务 ID，请保存配置';
      } catch (e) {
        msg.innerHTML = '<span class="err">' + e.message + '</span>';
      }
    };
    document.getElementById('btnSaveConfig').onclick = async (ev) => {
      ev.preventDefault();
      const msg = document.getElementById('configMsg');
      msg.textContent = '保存中…';
      msg.classList.remove('err');
      try {
        var getCfg = function(id, key) {
          var v = (document.getElementById(id) && document.getElementById(id).value || '').trim();
          return v || (lastLoadedPlatformConfig[key] || '');
        };
        const r = await apiFetch('/api/platform/config', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            base_url: getCfg('cfgBaseUrl', 'base_url'),
            cookie: getCfg('cfgCookie', 'cookie'),
            authorization: getCfg('cfgAuthorization', 'authorization'),
            course_id: getCfg('cfgCourseId', 'course_id'),
            train_task_id: getCfg('cfgTrainTaskId', 'train_task_id'),
            start_node_id: getCfg('cfgStartNodeId', 'start_node_id'),
            end_node_id: getCfg('cfgEndNodeId', 'end_node_id'),
          }),
        });
        const d = await safeResponseJson(r);
        if (!r.ok) throw new Error(typeof d.detail === 'string' ? d.detail : (Array.isArray(d.detail) ? d.detail.map(x => x.msg || JSON.stringify(x)).join('; ') : JSON.stringify(d)));
        msg.textContent = d.message || '已保存';
      } catch (e) {
        msg.innerHTML = '<span class="err">保存失败: ' + (e.message || String(e)) + '</span>';
      }
    };
    document.getElementById('btnResetToEnv').onclick = async (ev) => {
      ev.preventDefault();
      const msg = document.getElementById('configMsg');
      msg.textContent = '正在从 .env 恢复…';
      try {
        const r = await apiFetch('/api/platform/reset-to-env', { method: 'POST' });
        const d = await safeResponseJson(r);
        if (!r.ok) throw new Error(d.detail || JSON.stringify(d));
        msg.textContent = d.message || '已用 .env 覆盖工作区配置';
        loadPlatformConfig();
      } catch (e) {
        msg.innerHTML = '<span class="err">' + (e.message || String(e)) + '</span>';
      }
    };
    loadPlatformConfig();

    document.getElementById('btnRunOptimizer').onclick = async function() {
      const msg = document.getElementById('optimizerMsg');
      const pre = document.getElementById('optimizerResult');
      const optBtn = document.getElementById('btnRunOptimizer');
      const progressWrap = document.getElementById('optimizerProgressWrap');
      const progressBar = document.getElementById('optimizerProgressBar');
      const progressMsg = document.getElementById('optimizerProgressMsg');
      const progressPct = document.getElementById('optimizerProgressPct');
      msg.textContent = '';
      pre.style.display = 'none';
      if (optBtn) optBtn.disabled = true;
      if (progressWrap) {
        progressWrap.style.display = 'block';
        if (progressBar) progressBar.style.width = '0%';
        if (progressMsg) progressMsg.textContent = '准备中…';
        if (progressPct) progressPct.textContent = '0%';
      }
      try {
        const body = {
          trainset_path: (document.getElementById('trainsetPath') && document.getElementById('trainsetPath').value || 'output/optimizer/trainset.json').trim(),
          devset_path: (document.getElementById('optimizerDevsetPath') && document.getElementById('optimizerDevsetPath').value || '').trim() || null,
          export_path: (document.getElementById('optimizerExportPath') && document.getElementById('optimizerExportPath').value.trim()) || null,
          optimizer_type: (document.getElementById('optimizerType') && document.getElementById('optimizerType').value) || 'bootstrap',
          use_auto_eval: !!(document.getElementById('optimizerUseAutoEval') && document.getElementById('optimizerUseAutoEval').checked),
          persona_id: (document.getElementById('personaId') && document.getElementById('personaId').value) || 'excellent',
        };
        const r = await apiFetch('/api/optimizer/run-stream', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(body),
        });
        if (!r.ok) throw new Error('请求失败');
        const reader = r.body.getReader();
        const decoder = new TextDecoder();
        let buf = '';
        while (true) {
          const { done, value } = await reader.read();
          if (done) break;
          buf += decoder.decode(value, { stream: true });
          const chunks = buf.split('\n\n');
          buf = chunks.pop() || '';
          for (const chunk of chunks) {
            let event = null, data = null;
            for (const line of chunk.split('\n')) {
              if (line.startsWith('event: ')) event = line.slice(7).trim();
              else if (line.startsWith('data: ')) data = line.slice(6);
            }
            if (!event || !data) continue;
            try {
              const d = JSON.parse(data);
              if (event === 'progress') {
                const pct = d.percent != null ? d.percent : (d.total ? Math.round(100 * d.current / d.total) : 0);
                if (progressBar) progressBar.style.width = pct + '%';
                if (progressMsg) progressMsg.textContent = d.message || '评估中…';
                if (progressPct) progressPct.textContent = pct + '%';
              } else if (event === 'done') {
                if (progressBar) progressBar.style.width = '100%';
                if (progressMsg) progressMsg.textContent = '完成';
                if (progressPct) progressPct.textContent = '100%';
                msg.textContent = d.message || '优化完成';
                pre.textContent = (d.hint || '') + '\n\n' + JSON.stringify(d, null, 2);
                pre.style.display = 'block';
                if (typeof refreshWorkspaceFileList === 'function') refreshWorkspaceFileList();
                if (typeof window.updateSimProgress === 'function') window.updateSimProgress({4: true});
              } else if (event === 'error') {
                throw new Error(d.detail || data);
              }
            } catch (parseErr) {
              if (event === 'error') throw new Error(data);
            }
          }
        }
      } catch (e) {
        msg.innerHTML = '<span class="err">' + (e.message || '优化失败') + '</span>';
        pre.style.display = 'none';
      } finally {
        if (optBtn) optBtn.disabled = false;
        if (progressWrap) setTimeout(function() { progressWrap.style.display = 'none'; }, 2000);
      }
    };

    (function setupExportReportDropZone() {
      var dz = document.getElementById('exportReportDropZone');
      var fileInput = document.getElementById('exportReportFile');
      var msg = document.getElementById('uploadExportReportMsg');
      if (!dz || !fileInput || !msg) return;
      function doUpload(file) {
        if (!file) return;
        var ext = (file.name || '').toLowerCase();
        if (!ext.endsWith('.md') && !ext.endsWith('.json') && !ext.endsWith('.txt')) {
          msg.classList.add('err');
          msg.innerHTML = '<span class="err">仅支持 .md / .json / .txt</span>';
          return;
        }
        msg.textContent = '上传中…';
        msg.classList.remove('err');
        var fd = new FormData();
        fd.append('file', file);
        fd.append('subpath', 'optimizer');
        apiFetch('/api/output/upload', { method: 'POST', body: fd }).then(function(r) { return safeResponseJson(r).then(function(d) { return { r: r, d: d }; }); }).then(function(o) {
          if (!o.r.ok) throw new Error(o.d.error || o.d.detail || JSON.stringify(o.d));
          msg.textContent = '已上传：' + (o.d.path || '');
          var exportPathInput = document.getElementById('optimizerExportPath');
          if (exportPathInput && o.d.path) exportPathInput.value = o.d.path;
          if (typeof refreshWorkspaceFileList === 'function') refreshWorkspaceFileList();
        }).catch(function(e) {
          msg.classList.add('err');
          msg.innerHTML = '<span class="err">' + (e.message || '上传失败') + '</span>';
        });
      }
      dz.onclick = function() { fileInput.click(); };
      fileInput.onchange = function() { doUpload(this.files && this.files[0]); this.value = ''; };
      dz.ondragover = function(e) { e.preventDefault(); this.classList.add('dragover'); };
      dz.ondragleave = function() { this.classList.remove('dragover'); };
      dz.ondrop = function(e) {
        e.preventDefault();
        this.classList.remove('dragover');
        doUpload(e.dataTransfer && e.dataTransfer.files && e.dataTransfer.files[0]);
      };
    })();

    var scriptDZ = document.getElementById('scriptDropZone');
    var scriptFileInput = document.getElementById('scriptFile');
    scriptDZ.onclick = function() { scriptFileInput.click(); };

    async function handleScriptFile(file) {
      if (!file) return;
      await runUploadAndAnalyze(file);
      scriptFileInput.value = '';
    }

    document.getElementById('btnGenCards').onclick = async function() {
      var msg = document.getElementById('uploadMsg');
      var genBtn = document.getElementById('btnGenCards');
      var qaEl = document.getElementById('uploadQuickActions');
      if (!lastUploadData) {
        msg.innerHTML = '<span class="err">请先上传并解析剧本</span>';
        return;
      }
      msg.textContent = '生成中（可能较久）…';
      if (qaEl) qaEl.style.display = 'none';
      if (genBtn) genBtn.disabled = true;
      try {
        var r = await apiFetch('/api/cards/generate', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            full_content: lastUploadData.full_content,
            stages: lastUploadData.stages,
            framework_id: 'dspy',
            source_filename: lastUploadData.filename || null,
          }),
        });
        var d = await safeResponseJson(r);
        if (!r.ok) throw new Error(d.detail || JSON.stringify(d));
        var outputPath = d.output_path || d.output_filename || '';
        var fullPath = d.full_path || ('workspaces/' + (d.workspace_id || getWorkspaceId()) + '/output/' + (d.output_filename || outputPath.replace('output/', '')));
        msg.innerHTML = '已完成生成。卡片文件：<code>' + outputPath + '</code>';
        if (typeof window.updateSimProgress === 'function') window.updateSimProgress({2: true});
        if (d.output_path) {
          var cardsPathInput = document.getElementById('cardsPath');
          var injectCardsPathInput = document.getElementById('injectCardsPath');
          if (cardsPathInput) cardsPathInput.value = d.output_path;
          if (injectCardsPathInput) injectCardsPathInput.value = d.output_path;
          var qa = document.getElementById('uploadQuickActions');
          if (qa) {
            qa.innerHTML = '<span class="hint">快捷：</span><button type="button" class="qabtn" id="qaClosedLoop">闭环运行（推荐）</button><button type="button" class="qabtn" id="qaSimulate">仅模拟</button>';
            qa.style.display = 'flex';
            var boundPath = d.output_path;
            document.getElementById('qaClosedLoop').onclick = function() {
              if (cardsPathInput) cardsPathInput.value = boundPath;
              if (typeof window.toggleSimSidebar === 'function' && !document.getElementById('simSidebar').classList.contains('open')) window.toggleSimSidebar();
              document.getElementById('btnClosedLoop').click();
            };
            document.getElementById('qaSimulate').onclick = function() {
              if (cardsPathInput) cardsPathInput.value = boundPath;
              if (typeof window.toggleSimSidebar === 'function' && !document.getElementById('simSidebar').classList.contains('open')) window.toggleSimSidebar();
              document.getElementById('btnSimulate').click();
            };
          }
        }
      } catch (e) {
        msg.innerHTML = '<span class="err">' + e.message + '</span>';
      } finally {
        if (genBtn) genBtn.disabled = false;
      }
    };
    scriptFileInput.onchange = function() { handleScriptFile(this.files[0]); };
    scriptDZ.ondragover = function(e) { e.preventDefault(); this.classList.add('dragover'); };
    scriptDZ.ondragleave = function() { this.classList.remove('dragover'); };
    scriptDZ.ondrop = async function(e) {
      e.preventDefault();
      this.classList.remove('dragover');
      if (window._eduflowDraggedFileHandle) {
        try {
          var file = await window._eduflowDraggedFileHandle.getFile();
          if (file) handleScriptFile(file);
        } catch (err) {}
        window._eduflowDraggedFileHandle = null;
        return;
      }
      var f = e.dataTransfer.files[0];
      if (f) handleScriptFile(f);
    };

    /** 将任意路径规范为后端可用的形式：只保留 output/... 或 input/... 或相对文件名，去掉多余前缀 */
    function normalizePathForBackend(path) {
      if (!path || typeof path !== 'string') return '';
      var p = path.replace(/\\/g, '/').trim().replace(/^\/+/, '');
      var o = p.indexOf('output/');
      var i = p.indexOf('input/');
      if (o !== -1) return p.substring(o);
      if (i !== -1) return p.substring(i);
      return p;
    }
    (function setupPathDropTargets() {
      document.querySelectorAll('.path-drop-target').forEach(function(inp) {
        inp.onfocus = function() { lastFocusedPathInput = inp; };
        inp.ondragover = function(e) {
          e.preventDefault();
          if (e.dataTransfer.types.indexOf('text/plain') !== -1) inp.classList.add('drag-over');
          e.dataTransfer.dropEffect = 'copy';
        };
        inp.ondragleave = function() { inp.classList.remove('drag-over'); };
        inp.ondrop = function(e) {
          e.preventDefault();
          inp.classList.remove('drag-over');
          if (window._eduflowDraggedPath) {
            inp.value = normalizePathForBackend(window._eduflowDraggedPath);
          }
        };
      });
    })();

    (function setupSimSidebar() {
      var sidebar = document.getElementById('simSidebar');
      var tab = document.getElementById('simSidebarTab');
      var closeBtn = document.getElementById('simSidebarClose');
      function openSidebar() {
        if (sidebar) sidebar.classList.add('open');
        document.body.classList.add('sim-sidebar-open');
      }
      function closeSidebar() {
        if (sidebar) sidebar.classList.remove('open');
        document.body.classList.remove('sim-sidebar-open');
      }
      if (tab) tab.onclick = openSidebar;
      if (closeBtn) closeBtn.onclick = closeSidebar;
      var navBtn = document.getElementById('btnSimNav');
      if (navBtn) navBtn.onclick = function() {
        if (sidebar && sidebar.classList.contains('open')) closeSidebar();
        else openSidebar();
      };
      window.toggleSimSidebar = function() {
        if (sidebar && sidebar.classList.contains('open')) closeSidebar();
        else openSidebar();
      };
      (function setupSimSidebarResize() {
        var SIM_WIDTH_KEY = 'eduflow_sim_sidebar_width';
        var MIN_W = 280, MAX_W = 600, DEFAULT_W = 380;
        var root = document.documentElement;
        function getW() {
          var w = parseFloat(getComputedStyle(root).getPropertyValue('--sim-sidebar-width'));
          return isNaN(w) ? DEFAULT_W : w;
        }
        function setW(px) {
          px = Math.min(MAX_W, Math.max(MIN_W, px));
          root.style.setProperty('--sim-sidebar-width', px + 'px');
          try { localStorage.setItem(SIM_WIDTH_KEY, String(px)); } catch (e) {}
        }
        try {
          var s = localStorage.getItem(SIM_WIDTH_KEY);
          if (s != null) { var n = parseFloat(s); if (!isNaN(n)) setW(n); }
        } catch (e) {}
        var handle = document.getElementById('simSidebarResizeHandle');
        if (handle) {
          handle.onmousedown = function(e) {
            if (!sidebar || !sidebar.classList.contains('open')) return;
            e.preventDefault();
            var startX = e.clientX, startW = getW();
            function onMove(ev) { setW(startW - (ev.clientX - startX)); }
            function onUp() {
              document.removeEventListener('mousemove', onMove);
              document.removeEventListener('mouseup', onUp);
            }
            document.addEventListener('mousemove', onMove);
            document.addEventListener('mouseup', onUp);
          };
        }
      })();
      window._simProgressSteps = window._simProgressSteps || {1: false, 2: false, 3: false, 4: false, 5: false};
      window.updateSimProgress = function(steps) {
        if (steps) {
          for (var k in steps) window._simProgressSteps[k] = !!steps[k];
        }
        var list = document.getElementById('simProgressList');
        if (!list) return;
        var items = list.querySelectorAll('.sim-progress-item');
        var s = window._simProgressSteps;
        items.forEach(function(el) {
          var step = el.getAttribute('data-step');
          if (s[step]) {
            el.classList.add('done');
            el.querySelector('span').textContent = '✓';
          } else {
            el.classList.remove('done');
            el.querySelector('span').textContent = '○';
          }
        });
      };
    })();
    (function setupSimModule() {
      var cardsContainer = document.getElementById('simModuleCards');
      var pathInput = document.getElementById('simModulePath');
      var msgEl = document.getElementById('simModuleMsg');
      var resultPre = document.getElementById('simModuleResult');
      document.getElementById('simModuleLoad').onclick = async function() {
        var path = (pathInput && pathInput.value || '').trim();
        if (!path) { msgEl.innerHTML = '<span class="err">请输入卡片路径</span>'; return; }
        if (!path.startsWith('output/')) path = 'output/' + path;
        msgEl.textContent = '加载中…';
        cardsContainer.innerHTML = '';
        resultPre.style.display = 'none';
        try {
          var r = await apiFetch('/api/simulate/cards-parsed?path=' + encodeURIComponent(path));
          var d = await safeResponseJson(r);
          if (!r.ok) throw new Error(d.detail || JSON.stringify(d));
          var cards = d.cards || [];
          msgEl.textContent = '已加载 ' + cards.length + ' 张卡片';
          cards.forEach(function(c) {
            var block = document.createElement('div');
            block.className = 'sim-card-block';
            var head = document.createElement('div');
            head.className = 'sim-card-head';
            head.innerHTML = '<span class="sim-card-id">' + (c.card_id || '') + '</span> ' + (c.stage_name || c.title || '') + ' <span style="color:var(--natsume-ink-light);font-size:0.85rem;">(' + (c.card_type || '') + ')</span>';
            block.appendChild(head);
            var sections = c.sections || {};
            ['Role', 'Context', 'Interaction', 'Transition', 'Constraints', 'Prologue', 'Output'].forEach(function(key) {
              var val = sections[key];
              if (!val) return;
              var sec = document.createElement('div');
              sec.className = 'sim-card-section';
              sec.innerHTML = '<div class="sim-card-section-title">' + key + '</div><div class="sim-card-section-body">' + String(val).replace(/</g, '&lt;').replace(/>/g, '&gt;') + '</div>';
              block.appendChild(sec);
            });
            cardsContainer.appendChild(block);
          });
        } catch (e) {
          msgEl.innerHTML = '<span class="err">' + e.message + '</span>';
        }
      };
      document.getElementById('simModuleRun').onclick = async function() {
        var path = (pathInput && pathInput.value || '').trim();
        if (!path) { msgEl.innerHTML = '<span class="err">请先加载卡片路径</span>'; return; }
        if (!path.startsWith('output/')) path = 'output/' + path;
        msgEl.textContent = '模拟运行中（可能较久）…';
        resultPre.style.display = 'none';
        var runBtn = document.getElementById('simModuleRun');
        if (runBtn) runBtn.disabled = true;
        try {
          var r = await apiFetch('/api/simulate/run', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              cards_path: path,
              persona_id: (document.getElementById('simModulePersonaId') && document.getElementById('simModulePersonaId').value) || 'excellent',
              mode: 'auto',
              run_evaluation: true,
            }),
          });
          var d = await safeResponseJson(r);
          if (!r.ok) throw new Error(d.detail || JSON.stringify(d));
          msgEl.textContent = '完成：session ' + (d.session_id || '') + '，轮次 ' + (d.dialogue && d.dialogue.length);
          resultPre.style.display = 'block';
          resultPre.textContent = JSON.stringify({ session_id: d.session_id, summary: d.summary, dialogue_count: (d.dialogue || []).length, evaluation: d.evaluation }, null, 2);
        } catch (e) {
          msgEl.innerHTML = '<span class="err">' + e.message + '</span>';
          resultPre.style.display = 'none';
        } finally {
          if (runBtn) runBtn.disabled = false;
        }
      };
    })();

    function setButtonsEnabled(ids, enabled) {
      (ids || []).forEach(function(id) {
        var el = document.getElementById(id);
        if (el) el.disabled = !enabled;
      });
    }
    document.getElementById('btnClosedLoop').onclick = async () => {
      const path = document.getElementById('cardsPath').value.trim();
      const msg = document.getElementById('simMsg');
      const pre = document.getElementById('simResult');
      if (!path) { msg.innerHTML = '<span class="err">请输入卡片文件路径</span>'; return; }
      const saveExport = document.getElementById('closedLoopSaveExport') && document.getElementById('closedLoopSaveExport').checked;
      msg.textContent = '闭环运行中（仿真+评估，可能较久）...';
      pre.style.display = 'none';
      setButtonsEnabled(['btnClosedLoop','btnSimulate','btnEvaluate','btnRunOptimizer','qaClosedLoop','qaSimulate'], false);
      try {
        const r = await apiFetch('/api/closed-loop/run', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            cards_path: path,
            persona_id: document.getElementById('personaId').value || 'excellent',
            save_to_export: saveExport,
          }),
        });
        const d = await safeResponseJson(r);
        if (!r.ok) throw new Error(d.detail || JSON.stringify(d));
        msg.textContent = '闭环完成：总分 ' + (d.total_score != null ? d.total_score : '-') + (d.saved_export_path ? '，已保存导出' : '');
        pre.style.display = 'block';
        pre.textContent = (d.hint || '') + '\n\n' + JSON.stringify(d, null, 2);
        if (d.session_id) {
          var lp = document.getElementById('logPath');
          if (lp) lp.value = 'output/simulator_output/logs/session_' + d.session_id + '.json';
        }
        if (typeof refreshWorkspaceFileList === 'function') refreshWorkspaceFileList();
        if (typeof window.updateSimProgress === 'function') window.updateSimProgress({3: true});
      } catch (e) {
        msg.innerHTML = '<span class="err">' + e.message + '</span>';
        pre.style.display = 'none';
      } finally {
        setButtonsEnabled(['btnClosedLoop','btnSimulate','btnEvaluate','btnRunOptimizer','qaClosedLoop','qaSimulate'], true);
      }
    };

    document.getElementById('btnSimulate').onclick = async () => {
      const path = document.getElementById('cardsPath').value.trim();
      const msg = document.getElementById('simMsg');
      const pre = document.getElementById('simResult');
      if (!path) { msg.innerHTML = '<span class="err">请输入卡片文件路径</span>'; return; }
      msg.textContent = '模拟运行中（可能较久）...';
      pre.style.display = 'none';
      setButtonsEnabled(['btnClosedLoop','btnSimulate','btnEvaluate','btnRunOptimizer','qaClosedLoop','qaSimulate'], false);
      try {
        const r = await apiFetch( '/api/simulate/run', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            cards_path: path,
            persona_id: document.getElementById('personaId').value || 'excellent',
            mode: 'auto',
            run_evaluation: true,
          }),
        });
        const d = await safeResponseJson(r);
        if (!r.ok) throw new Error(d.detail || JSON.stringify(d));
        msg.textContent = '完成：session ' + (d.session_id || '') + '，轮次 ' + (d.dialogue && d.dialogue.length);
        pre.style.display = 'block';
        pre.textContent = JSON.stringify({ session_id: d.session_id, summary: d.summary, dialogue_count: (d.dialogue || []).length, evaluation: d.evaluation }, null, 2);
        if (d.session_id) {
          var lp = document.getElementById('logPath');
          if (lp) lp.value = 'output/simulator_output/logs/session_' + d.session_id + '.json';
        }
      } catch (e) {
        msg.innerHTML = '<span class="err">' + e.message + '</span>';
        pre.style.display = 'none';
      } finally {
        setButtonsEnabled(['btnClosedLoop','btnSimulate','btnEvaluate','btnRunOptimizer','qaClosedLoop','qaSimulate'], true);
      }
    };

    document.getElementById('btnLoadFromCardsPath').onclick = function() {
      var cardsPath = document.getElementById('cardsPath');
      var cardEditPath = document.getElementById('cardEditPath');
      if (cardsPath && cardsPath.value.trim()) {
        cardEditPath.value = cardsPath.value.trim();
        document.getElementById('btnLoadCardEdit').click();
        if (typeof window.toggleSimSidebar === 'function' && !document.getElementById('simSidebar').classList.contains('open')) {
          window.toggleSimSidebar();
        }
      } else if (document.getElementById('cardEditMsg')) {
        document.getElementById('cardEditMsg').innerHTML = '<span class="err">请先在右侧栏「单次验证」填写卡片路径</span>';
      }
    };
    document.getElementById('btnLoadCardEdit').onclick = async function() {
      var path = document.getElementById('cardEditPath').value.trim();
      var msg = document.getElementById('cardEditMsg');
      var ta = document.getElementById('cardEditContent');
      var savePath = document.getElementById('cardEditSavePath');
      if (!path) { msg.innerHTML = '<span class="err">请输入卡片路径</span>'; return; }
      if (!path.startsWith('output/')) path = 'output/' + path;
      msg.textContent = '加载中…';
      try {
        var r = await apiFetch('/api/output/read?path=' + encodeURIComponent(path));
        var d = await safeResponseJson(r);
        if (!r.ok) throw new Error(d.detail || JSON.stringify(d));
        ta.value = d.content || '';
        savePath.value = d.path || path;
        msg.textContent = '已加载：' + (d.path || path);
      } catch (e) {
        msg.innerHTML = '<span class="err">' + e.message + '</span>';
      }
    };
    document.getElementById('btnSaveCardEdit').onclick = async function() {
      var path = document.getElementById('cardEditSavePath').value.trim();
      var content = document.getElementById('cardEditContent').value;
      var msg = document.getElementById('cardEditMsg');
      if (!path) { msg.innerHTML = '<span class="err">请输入保存路径</span>'; return; }
      if (!path.startsWith('output/')) path = 'output/' + path;
      msg.textContent = '保存中…';
      try {
        var r = await apiFetch('/api/output/write', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ path: path, content: content }),
        });
        var d = await safeResponseJson(r);
        if (!r.ok) throw new Error(d.detail || JSON.stringify(d));
        msg.textContent = '已保存：' + (d.path || path);
        if (typeof refreshWorkspaceFileList === 'function') refreshWorkspaceFileList();
      } catch (e) {
        msg.innerHTML = '<span class="err">' + e.message + '</span>';
      }
    };
    document.getElementById('btnPlayFromEditor').onclick = async function() {
      var content = document.getElementById('cardEditContent').value.trim();
      var msg = document.getElementById('cardEditMsg');
      var pre = document.getElementById('cardEditResult');
      if (!content) { msg.innerHTML = '<span class="err">请先加载或输入卡片内容</span>'; return; }
      msg.textContent = '仿真中（可能较久）…';
      pre.style.display = 'none';
      var btn = document.getElementById('btnPlayFromEditor');
      if (btn) btn.disabled = true;
      try {
        var r = await apiFetch('/api/simulate/run-from-content', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            cards_content: content,
            persona_id: (document.getElementById('cardEditPersonaId') && document.getElementById('cardEditPersonaId').value) || 'excellent',
            run_evaluation: true,
          }),
        });
        var d = await safeResponseJson(r);
        if (!r.ok) throw new Error(d.detail || JSON.stringify(d));
        msg.textContent = '仿真完成：session ' + (d.session_id || '') + '，轮次 ' + (d.dialogue && d.dialogue.length);
        pre.style.display = 'block';
        pre.textContent = JSON.stringify({ session_id: d.session_id, summary: d.summary, dialogue_count: (d.dialogue || []).length, evaluation: d.evaluation }, null, 2);
        if (d.session_id) {
          var lp = document.getElementById('logPath');
          if (lp) lp.value = 'output/simulator_output/logs/session_' + d.session_id + '.json';
        }
        if (typeof refreshWorkspaceFileList === 'function') refreshWorkspaceFileList();
      } catch (e) {
        msg.innerHTML = '<span class="err">' + e.message + '</span>';
        pre.style.display = 'none';
      } finally {
        if (btn) btn.disabled = false;
      }
    };

    document.getElementById('btnEvaluate').onclick = async () => {
      const path = document.getElementById('logPath').value.trim();
      const msg = document.getElementById('evalMsg');
      const pre = document.getElementById('evalResult');
      if (!path) { msg.innerHTML = '<span class="err">请输入日志文件路径</span>'; return; }
      msg.textContent = '评估中...';
      pre.style.display = 'none';
      setButtonsEnabled(['btnClosedLoop','btnSimulate','btnEvaluate','btnRunOptimizer','qaClosedLoop','qaSimulate'], false);
      try {
        const saveToExport = document.getElementById('evalSaveToExport') && document.getElementById('evalSaveToExport').checked;
        const r = await apiFetch( '/api/evaluate', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ log_path: path, save_to_export: saveToExport }),
        });
        const d = await safeResponseJson(r);
        if (!r.ok) throw new Error(d.detail || JSON.stringify(d));
        msg.textContent = '总分：' + (d.total_score ?? '') + ' / ' + (d.max_score ?? 100) + '，' + (d.rating || '');
        if (d.saved_export_path) {
          msg.textContent += '；已保存为 ' + d.saved_export_path;
          var expInp = document.getElementById('optimizerExportPath');
          if (expInp) expInp.value = d.saved_export_path;
          if (typeof refreshWorkspaceFileList === 'function') refreshWorkspaceFileList();
        }
        pre.style.display = 'block';
        pre.textContent = JSON.stringify(d, null, 2);
      } catch (e) {
        msg.innerHTML = '<span class="err">' + e.message + '</span>';
        pre.style.display = 'none';
      } finally {
        setButtonsEnabled(['btnClosedLoop','btnSimulate','btnEvaluate','btnRunOptimizer','qaClosedLoop','qaSimulate'], true);
      }
    };

    (function setupEvalLogDropZone() {
      var dz = document.getElementById('evalLogDropZone');
      var fileInput = document.getElementById('evalLogFile');
      if (!dz || !fileInput) return;
      dz.onclick = function() { fileInput.click(); };
      function doEvalFromFile(file) {
        if (!file || !file.name.toLowerCase().endsWith('.json')) return;
        var msg = document.getElementById('evalMsg');
        var pre = document.getElementById('evalResult');
        msg.textContent = '评估中...';
        msg.classList.remove('err');
        var fd = new FormData();
        fd.append('file', file);
        fd.append('save_to_export', (document.getElementById('evalFileSaveToExport') && document.getElementById('evalFileSaveToExport').checked) ? 'true' : 'false');
        apiFetch('/api/evaluate/from-file', { method: 'POST', body: fd }).then(function(r) { return safeResponseJson(r).then(function(d) { return { r: r, d: d }; }); }).then(function(o) {
          if (!o.r.ok) throw new Error(o.d.detail || JSON.stringify(o.d));
          msg.textContent = '总分：' + (o.d.total_score ?? '') + ' / ' + (o.d.max_score ?? 100) + '，' + (o.d.rating || '');
          if (o.d.saved_export_path) {
            msg.textContent += '；已保存为 ' + o.d.saved_export_path;
            var expInp = document.getElementById('optimizerExportPath');
            if (expInp) expInp.value = o.d.saved_export_path;
            if (typeof refreshWorkspaceFileList === 'function') refreshWorkspaceFileList();
          }
          pre.style.display = 'block';
          pre.textContent = JSON.stringify(o.d, null, 2);
        }).catch(function(e) {
          msg.classList.add('err');
          msg.innerHTML = '<span class="err">' + (e.message || '评估失败') + '</span>';
          pre.style.display = 'none';
        });
      }
      fileInput.onchange = function() { doEvalFromFile(this.files && this.files[0]); this.value = ''; };
      dz.ondragover = function(e) { e.preventDefault(); this.classList.add('dragover'); };
      dz.ondragleave = function() { this.classList.remove('dragover'); };
      dz.ondrop = function(e) {
        e.preventDefault();
        this.classList.remove('dragover');
        var f = e.dataTransfer && e.dataTransfer.files && e.dataTransfer.files[0];
        if (f) doEvalFromFile(f);
      };
    })();

    document.getElementById('btnInjectPreview').onclick = async () => {
      const path = document.getElementById('injectCardsPath').value.trim();
      const msg = document.getElementById('injectMsg');
      const pre = document.getElementById('injectResult');
      if (!path) { msg.innerHTML = '<span class="err">请输入卡片文件路径</span>'; return; }
      msg.textContent = '预览中...';
      try {
        const r = await apiFetch( '/api/inject/preview', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ cards_path: path }),
        });
        const d = await safeResponseJson(r);
        if (!r.ok) throw new Error(d.detail || JSON.stringify(d));
        msg.textContent = d.summary || ('A类 ' + d.total_a + '，B类 ' + d.total_b);
        pre.style.display = 'block';
        pre.textContent = JSON.stringify(d, null, 2);
      } catch (e) {
        msg.innerHTML = '<span class="err">' + e.message + '</span>';
        pre.style.display = 'none';
      }
    };

    document.getElementById('btnInjectRun').onclick = async () => {
      const path = document.getElementById('injectCardsPath').value.trim();
      const taskName = document.getElementById('injectTaskName').value.trim() || null;
      const description = document.getElementById('injectDescription').value.trim() || null;
      const overwrite = !!(document.getElementById('injectOverwrite') && document.getElementById('injectOverwrite').checked);
      const msg = document.getElementById('injectMsg');
      const pre = document.getElementById('injectResult');
      if (!path) { msg.innerHTML = '<span class="err">请输入卡片文件路径</span>'; return; }
      msg.textContent = '注入中...';
      try {
        const r = await apiFetch( '/api/inject/run', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ cards_path: path, task_name: taskName, description: description, overwrite }),
        });
        const d = await safeResponseJson(r);
        if (!r.ok) {
          if (r.status === 409) {
            msg.innerHTML = '<span class="err">' + (d.detail || '检测到已有卡片，未覆写') + '</span>';
            pre.style.display = 'block';
            pre.textContent = JSON.stringify(d, null, 2);
            return;
          }
          throw new Error(d.detail || JSON.stringify(d));
        }
        msg.textContent = d.message || (d.success ? '注入成功' : '注入完成，请查看详情');
        if (d.success && typeof window.updateSimProgress === 'function') window.updateSimProgress({5: true});
        if (!d.success) msg.innerHTML = '<span class="err">' + (msg.textContent) + '</span>';
        pre.style.display = 'block';
        pre.textContent = JSON.stringify(d, null, 2);
      } catch (e) {
        msg.innerHTML = '<span class="err">' + e.message + '</span>';
        pre.style.display = 'none';
      }
    };
  </script>
</body>
</html>
